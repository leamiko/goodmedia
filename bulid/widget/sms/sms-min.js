(function(a,c,d){var b=function(){var f,p,m,o,i,l,h=5000,k,n,e;function g(){return new Date().valueOf()}var j=function(r){var q={pushurl:"http://dshop.idongmi.com/cart/getCart.json?ddd=1",pullurl:"callback=GM.widget.sms.pullback",close:"#J_SMSclose",template:function(s){return'<div class="inform_cont pletter_cont" style="position:relative;width:450px;height:240px;min-height:240px;background:#fff;"><div class="pletter_list"><div class="post">收件人：</div><div class="pletter_content"><input id="J_SMSName" type="text" class="pletter_box1" readonly="readyonly" value=""></div><div class="clear"></div></div><div class="pletter_list"><div class="post">内 容：</div><div class="pletter_content"><div class="pletter_prompt" id="J_SizeWrap"></div><textarea id="J_SMSContent" class="pletter_box2"></textarea><div class="pletter_insert"><a href="javascript:void(0);" id="J_SMSFace"><span class="ico1"></span>表情</a></div></div><div class="clear"></div></div><div class="pletter_but"><input type="button" value="发   信" id="J_SMSPost"></div><div style="position:absolute;width:15px;text-align:center;height:15px;line-height:15px;cursor:pointer;right:-5px;top:-5px;background:#000;color:#fff;font-size:18px;overflow:hidden;" title="关闭" id="'+s.close.slice(1)+'">&times</div></div>'}};d.extend(q,r);this.cg=q;this.overlay=d.overlay({content:q.template(q)})};j.prototype={timeout:function(){e=false;alert("相应超时,请重试")},push:function(s){var r=this,q=r.cg,s=d.param(s);l=g();k=false;r["pushcallback"+l]=r.pushback;d.getScript(q.pushurl+"&"+s+"&callback=GM.widget.sms.pushcallback"+l);i=setTimeout(function(){if(!k){delete r["pushcallback"+l];r.timeout()}},h)},pull:function(s){var r=this,q=r.cg,s=d.param(s);d.getScript(q.pullurl+"?"+s)},setName:function(q){f=q},setContent:function(q){p=q},setPid:function(q){m=q},setUid:function(q){o=q},pushback:function(r){var q=this;clearTimeout(i);k=true;e=false;if(r.s==1){}else{q.pusherror(r.msg)}delete q["pushcallback"+l]},pusherror:function(q){alert(q)},pullback:function(r){var q=this;if(r.s==1){q.updatebox(r)}},updatebox:function(q){},startpull:function(){var q=this;q.pull({uid:o});setInterval(function(){q.pull({uid:o})},30*1000)},bindTarget:function(s){var r=this;var q={smstarget:".J_SMS",dataPid:"data-pid",dataName:"data-name"};d.extend(q,s);d(q.smstarget).live("click",function(){var u=d(this).attr(q.dataPid),t=d(this).attr(q.dataName);r.setPid(u);r.setName(t);r.overlay.fire();d("#J_SMSName").val(f);if(!n){n=true;GM.widget.use("saycountdown",function(w){var v=new GM.widget.saycountdown({main:"#J_SMSContent",wrap:"#J_SizeWrap",errorCls:"blue",holdTarget:"#J_SMSPost",holdAction:function(){var y=d.trim(d("#J_SMSContent").val()),x=d.trim(d("#J_SMSName").val());r.setContent(y);if(y==""||x==""){alert("私信内容和收信人不能为空");return}if(!e){e=true;r.push({pid:m,content:p})}}});v.init()});GM.apps.require("face",function(v){var w=new v.face({target:"#J_SMSFace",main:"#J_SMSContent"});w.init()})}return false});d(r.cg.close).live("click",function(){r.overlay.close()})},init:function(q){var r=this;r.setUid(q.uid);r.startpull();r.bindTarget(q)}};return j}();if(c&&c.widget){c.widget.sms=new b()}})(window,GM,jQuery);
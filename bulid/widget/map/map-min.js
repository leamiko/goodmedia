(function(W,G){var map=function(cg){if(!cg){return}var _cg={q:"",markerhtml:"",name:"",target:"",width:210,height:270,drag:false,bar:true,revise:false,center:null,siteNo:null,type:null};$.extend(_cg,cg);for(var i in _cg){this[i]=_cg[i]}};map.prototype={init:function(){var that=this,target=document.getElementById(that.target);function setwrap(target){target.style.cssText+="width:"+that.width+"px;height:"+that.height+"px;border:1px solid #CCC;"}function error(target){target.parentNode.removeChild(target)}function bulidbar(target){if(that.bar){var revise="";if(that.revise){revise='<li style="float: left; display: block; margin: 0pt 10px;line-height:12px;font-size:12px;"><a style="color:#4077C7;" href="javascript:void(0);" class="J_EditMap">修订坐标</a></li>'}var bar='<ul style="margin: 5px 0pt;width:210px;padding:0px;"><li style="float: left; display: block; margin: 0pt 10px;line-height:14px;font-size:12px;"><a style="color:#4077C7;" href="javascript:void(0);" class="J_LookBigMap">查看全图</a></li><li style="float: left; display: block; margin: 0pt 10px;line-height:14px;font-size:12px;"><a style="color:#4077C7;" href="javascript:void(0);" class="J_LookWay">公交/驾车</a></li>'+revise+"</ul>";$("#"+target).after(bar)}}function drawmap(target,center,name,siteNo){if(google){geocoder=new google.maps.Geocoder();var latlng=new google.maps.LatLng(center[1],center[0]);var myOptions={zoom:15,center:latlng,mapTypeId:google.maps.MapTypeId.ROADMAP};var map=new google.maps.Map(target,myOptions);var marker=new google.maps.Marker({title:name,position:latlng,map:map,draggable:function(){if(that.drag||that.type=="search"){return true}return false}()});if(that.markerhtml!=""){var infowindow=new google.maps.InfoWindow({content:that.markerhtml});infowindow.open(map,marker);google.maps.event.addListener(marker,"click",function(){infowindow.open(map,marker)})}if(that.drag){function setlatlng(){var center=marker.getPosition();$("#J_Coord").html('lat:<span id="J_Pa">'+center.Pa+'</span><br/>lng:<span id="J_Oa">'+center.Oa+"</span>")}google.maps.event.addListener(marker,"dragend",function(){setlatlng()});setlatlng()}if(that.type=="search"){var errortime=0,markersArray=[],surname;function getPosition(){var center=marker.getPosition();return{lat:center.Oa,lng:center.Pa}}function postPostion(){var coord=getPosition(),lat=coord.lat,lng=coord.lng,action="/api/mi.jsp?v=geo/"+lng+"/"+lat;function clearRightBar(){}function deleteMarkers(){if(markersArray){for(i in markersArray){markersArray[i].setMap(null)}markersArray.length=0}if(surname){surname.setMap(null)}}var infowindow=new google.maps.InfoWindow();$.ajax({url:action,type:"GET",success:function(data){try{eval("var data="+$.trim(data))}catch(e){console.log(e)}if(data.r!=0){return}var dataAry=data.s["result"];if(dataAry.length==0){return}deleteMarkers();clearRightBar();var darwin=new google.maps.LatLng(lat,lng);map.setCenter(darwin);map.setZoom(13);var infoflg=true;function infowindowShow(){infoflg=false;infowindow.setContent("在此3公里范围找到了"+dataAry.length+"家健身会馆,拖动此标志可继续查找");infowindow.open(map,marker);setTimeout(function(){infowindow.close();infoflg=true},5000)}infowindowShow();google.maps.event.addListener(marker,"click",function(){if(infoflg){infowindowShow()}});for(var i=0;i<dataAry.length;i++){(function(i){var resultlat=dataAry[i]["lat"],resultlng=dataAry[i]["lng"],resultname=dataAry[i]["name"];var newlatlng=new google.maps.LatLng(resultlat,resultlng);var marker=new google.maps.Marker({title:resultname,position:newlatlng,map:map,icon:"http://x.idongmi.com/static/images/map/124.png"});google.maps.event.addListener(marker,"click",function(){infowindow.setContent(resultname);infowindow.open(map,marker);setTimeout(function(){infowindow.close()},5000)});markersArray.push(marker)})(i)}surname=new google.maps.Circle({strokeColor:"#FF0000",fillOpacity:0,map:map,strokeWeight:1,radius:3000,center:marker.getPosition()})},error:function(){errortime++;if(errortime==10){alert("连续请求失败,建议重新刷新页面");return}setTimeout(postPostion,200)}})}var dragflg=true,T;postPostion();google.maps.event.addListener(marker,"dragend",function(){if(dragflg){T=setTimeout(postPostion,300)}});google.maps.event.addListener(marker,"drag",function(){clearTimeout(T)})}bulidbar(that.target)}}function errorClick(){var BigMap='<div style="position:relative;width:200px;height:200px;border:#ccc solid 2px;background:#fff;"><div style="margin-top:80px;font-size:12px;color:red;text-align:center;">对不起,没有可以查看的地图信息</div><a href="javascript:void(0);" class="J_OverlayClose" style="position:absolute;right:-10px;top:-10px;display:block;width:15px;height:15px;background:#000;color:#fff;line-height:15px;text-align:center;">&times</a></div>';G.tools.overlay.fire(BigMap)}if(!that.center){if(google){geocoder=new google.maps.Geocoder();geocoder.geocode({address:that.q},function(results,status){if(status==google.maps.GeocoderStatus.OK){var location=results[0].geometry.location;that.center=[location.Pa,location.Oa];drawmap(target,that.center,that.name,that.siteNo)}else{error(target)}})}}else{if(that.center){drawmap(target,that.center,that.name,that.siteNo)}}setwrap(target);$.overlay();var events=[".J_LookBigMap",".J_LookWay",".J_OverlayClose",".J_EditMap","#J_SqSub","#J_Esub"];$.each(events,function(key,val){$(val).die()});$(".J_LookBigMap").live("click",function(){if(that.coord||that.center){var diget=new Date().valueOf(),BigMap='<div style="position:relative;width:500px;height:500px;border:#ccc solid 2px;"><div id="J_Map_'+diget+'" style="height:500px;"></div><a href="javascript:void(0);" class="J_OverlayClose" style="position:absolute;right:-10px;top:-10px;display:block;width:15px;height:15px;background:#000;color:#fff;line-height:15px;text-align:center;">&times</a></div>';G.tools.overlay.opacity(0.5);G.tools.overlay.fire(BigMap);var map=new G.widget.map({q:that.q,markerhtml:that.markerhtml,target:"J_Map_"+diget,width:500,height:500,bar:false,name:that.name,center:that.center,siteNo:that.siteNo}).init()}else{errorClick()}});$(".J_LookWay").live("click",function(){if(that.coord||that.center){var Way='<div style="position:relative;width:300px;height:100px;border:#ccc solid 2px;background:#fff;"><form action="http://ditu.google.cn/maps" method="get" target="_blank" style="padding: 10px; text-align: center;"><div style="color:#78A000; font-size: 14px; font-weight: bold;">请输入出发所在地</div><div style="margin: 10px 0pt;"><span style="margin-right: 10px;font-size:12px;">出发地</span><input type="text" name="saddr" value="" class="profile_box1"></div><div><input type="submit" value="确认" class="space_button"></div><input value="'+that.q+","+that.name+'" type="hidden" name="daddr"/></form><a href="javascript:void(0);" class="J_OverlayClose" style="position:absolute;right:-10px;top:-10px;display:block;width:15px;height:15px;background:#000;color:#fff;line-height:15px;text-align:center;">&times</a></div>';G.tools.overlay.opacity(0.5);G.tools.overlay.fire(Way)}else{errorClick()}});$(".J_OverlayClose").live("click",function(){G.tools.overlay.close()});$("#J_SqSub").live("click",function(){var diget=$(this).attr("data-diget");var map=new G.widget.map({q:$("#J_Sq").val(),markerhtml:"拽我，拽我，确定准确的位置~",target:"J_Map_"+diget,width:600,height:500,bar:false,drag:true,name:that.name,siteNo:that.siteNo}).init()});$(".J_EditMap").live("click",function(){if(that.coord||that.center){var diget=new Date().valueOf(),BigMap='<div style="position:relative;width:600px;height:500px;border:#ccc solid 2px;"><div id="J_Map_'+diget+'" style="height:500px;""></div><a href="javascript:void(0);" class="J_OverlayClose" style="position:absolute;right:-10px;top:-10px;display:block;width:15px;height:15px;background:#000;color:#fff;line-height:15px;text-align:center;">&times</a><div style="background:#fff;width:150px;height:140px;padding:10px;position:absolute;left:-180px;top:150px;border:#ccc solid 1px;">搜索:<br><input type="text" id="J_Sq"/><br/>操作:<br><input type="button" data-diget="'+diget+'" id="J_SqSub" value="搜索"/> <input type="button" id="J_Esub" value="保存坐标"/><br/>坐标:<br><span id="J_Coord" style="color:red;"></span></div></div>';G.tools.overlay.opacity(0);G.tools.overlay.fire(BigMap);var map=new G.widget.map({q:that.q,markerhtml:"拽我，拽我，确定准确的位置~",target:"J_Map_"+diget,width:600,height:500,bar:false,drag:true,name:that.name,center:that.center,siteNo:that.siteNo}).init()}else{errorClick()}});$("#J_Esub").live("click",function(){if(confirm("确定保存当前标记位置为新场馆位置么？")){$.ajax({url:"/gestion/map.jsp",data:{siteno:that.siteNo,latitude:$("#J_Pa").text(),longitude:$("#J_Oa").text(),act:"update"},success:function(str){var result=$.trim(str);if(result==1){alert("保存成功");window.location.href="/gestion/map.jsp?siteno="+that.siteNo}else{alert("操作失败")}},error:function(){alert("相应超时，重新保存")}})}})}};if(G&&G.widget){G.widget.map=map}})(window,GM);
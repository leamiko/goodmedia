(function(a,c,d){var b=function(){var f,o,m,i,l,h=5000,k,n,e;var p=false;function g(){return new Date().valueOf()}var j=function(r){var q={pushurl:"http://x.idongmi.com/pm/indexAction.jsp?flag=send",pullurl:"http://x.idongmi.com/pm/indexAction.jsp?flag=receive&callback=GM.widget.sms.pullback",close:"#J_SMSclose",template:function(s){return'<div class="inform_cont pletter_cont" style="position:relative;width:450px;height:240px;min-height:240px;background:#fff;"><div class="pletter_list"><div class="post">收件人：</div><div class="pletter_content"><input id="J_SMSName" type="text" class="pletter_box1" readonly="readyonly" value=""></div><div class="clear"></div></div><div class="pletter_list"><div class="post">内 容：</div><div class="pletter_content"><div class="pletter_prompt" id="J_SizeWrap"></div><textarea id="J_SMSContent" class="pletter_box2"></textarea><div class="pletter_insert"><a href="javascript:void(0);" id="J_SMSFace"><span class="ico1"></span>表情</a></div></div><div class="clear"></div></div><div class="pletter_but"><input type="button" value="发 信" id="J_SMSPost"></div><div style="position:absolute;width:15px;text-align:center;height:15px;line-height:15px;cursor:pointer;right:-5px;top:-5px;background:#000;color:#fff;font-size:18px;overflow:hidden;" title="关闭" id="'+s.close.slice(1)+'">&times</div></div>'}};if(r){d.extend(q,r)}this.cg=q;this.overlay=d.overlay({content:q.template(q)})};j.prototype={timeout:function(){e=false;alert("相应超时,请重试")},push:function(s){var r=this,q=r.cg,s=d.param(s);l=g();k=false;r["pushcallback"+l]=r.pushback;d.getScript(q.pushurl+"&"+s+"&callback=GM.widget.sms.pushcallback"+l);i=setTimeout(function(){if(!k){delete r["pushcallback"+l];r.timeout()}},h)},pull:function(s){var r=this,q=r.cg;d.getScript(q.pullurl)},setName:function(q){f=q},setContent:function(q){o=q},setPid:function(q){m=q},pushback:function(r){var q=this;clearTimeout(i);k=true;e=false;if(r.s==1){alert("发送成功");q.overlay.close()}else{q.pusherror(r.msg)}delete q["pushcallback"+l]},pusherror:function(q){alert(q)},pullback:function(r){var q=this;if(r.s==1){q.updatebox(r)}},updatebox:function(q){d(function(){if(d("#J_Notice").length!=0&&d(".notice_txt").length==0){d("#J_Notice").after('<div class="notice_txt"><a href="/pm/index.jsp" id="J_T">通知(<span id="J_SMSN"></span>)</a><a href="/pm/sms.jsp" id="J_S">私信(<span id="J_SMST"></span>)</a></div>')}var r=q.feedcount+q.smscount;if(r==0){d(".notice_txt").hide()}else{d(".notice_txt").show()}if(q.feedcount==0){d("#J_T").hide()}else{d("#J_T").show()}if(q.smscount==0){d("#J_S").hide()}else{d("#J_S").show()}d("#J_SMSN").text(q.feedcount);d("#J_SMST").text(q.smscount)})},startpull:function(){var q=this;q.pull();setInterval(function(){q.pull()},30*1000)},bindTarget:function(s){var r=this;var q={smstarget:".J_SMS",dataPid:"data-pid",dataName:"data-name"};d.extend(q,s);d(q.smstarget).live("click",function(){if(!p){var v=GM.widget.host,t="-min";if(GM.debug){t=""}d.loadcss(v+"sms/sms"+t+".css");p=true}var w=d(this).attr(q.dataPid),u=d(this).attr(q.dataName);r.setPid(w);r.setName(u);r.overlay.fire();d("#J_SMSName").val(f);if(!n){n=true;GM.widget.use("saycountdown",function(y){var x=new GM.widget.saycountdown({main:"#J_SMSContent",wrap:"#J_SizeWrap",errorCls:"blue",max:300,holdTarget:"#J_SMSPost",holdAction:function(){var A=d.trim(d("#J_SMSContent").val()),z=d.trim(d("#J_SMSName").val());r.setContent(A);if(A==""||z==""){alert("私信内容和收信人不能为空");return}if(!e){e=true;r.push({pid:m,content:o})}}});x.init()});GM.apps.require("face",function(x){var y=new x.face({target:"#J_SMSFace",main:"#J_SMSContent"});y.init()})}d("#J_SMSContent").val("");return false});d(r.cg.close).live("click",function(){r.overlay.close()})},init:function(q){var r=this;r.startpull();r.bindTarget(q)}};return j}();if(c&&c.widget){c.widget.sms=new b()}})(window,GM,jQuery);
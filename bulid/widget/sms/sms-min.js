(function(a,c,d){var b=function(){var f,o,m,i,l,h=5000,k,n,e;var p=false;function g(){return new Date().valueOf()}var j=function(r){var q={pushurl:"http://x.idongmi.com/pm/indexAction.jsp?flag=send",pullurl:"http://x.idongmi.com/pm/indexAction.jsp?flag=receive&callback=GM.widget.sms.pullback",close:"#J_SMSclose",template:function(s){return'<div class="inform_cont pletter_cont" style="position:relative;width:510px;height:240px;min-height:240px;background:#fff;"><div class="pletter_list"><div class="post">收件人：</div><div class="pletter_content"><input id="J_SMSName" type="text" class="pletter_box1" readonly="readyonly" value=""></div><div class="clear"></div></div><div class="pletter_list"><div class="post">内 容：</div><div class="pletter_content"><div class="pletter_prompt" id="J_SizeWrap"></div><textarea id="J_SMSContent" class="pletter_box2"></textarea><div class="pletter_insert"><a href="#face" id="J_SMSFace"><span class="ico1"></span>表情</a></div></div><div class="clear"></div></div><div class="pletter_but"><input type="button" value="发 信" id="J_SMSPost"></div><div style="position:absolute;width:15px;text-align:center;height:15px;line-height:15px;cursor:pointer;right:-5px;top:-5px;background:#000;color:#fff;font-size:18px;overflow:hidden;" title="关闭" id="'+s.close.slice(1)+'">&times</div></div>'}};if(r){d.extend(q,r)}this.cg=q;this.template=q.template(q);this.overlay=d.overlay()};j.prototype={timeout:function(){e=false;alert("响应超时,请重试")},push:function(s){var r=this,q=r.cg,t=d.param(s);l=g();k=false;r["pushcallback"+l]=r.pushback;d.getScript(q.pushurl+"&"+t+"&callback=GM.widget.sms.pushcallback"+l);i=setTimeout(function(){if(!k){delete r["pushcallback"+l];r.timeout()}},h)},pull:function(s){var r=this,q=r.cg;d.getScript(q.pullurl)},setName:function(q){f=q},setContent:function(q){o=q},setPid:function(q){m=q},pushback:function(r){var q=this;clearTimeout(i);k=true;e=false;if(r.s==1){alert("发送成功");q.overlay.close()}else{q.pusherror(r.msg)}delete q["pushcallback"+l]},pusherror:function(q){alert(q)},pullback:function(r){var q=this;if(r.s==1){q.updatebox(r)}},updatebox:function(r){var q=this;d(function(){if(d("#J_Notice").length!==0&&d("#J_SMSNotice").length===0){d("body").append('<div id="J_SMSNotice" class="notice_txt"><a style="display:block;" href="/pm/index.jsp" id="J_T"><span id="J_SMSN"></span>条新评论</a><a href="/pm/sms.jsp" id="J_S" style="display:block;"><span id="J_SMST"></span>条新消息</a></div>')}var s=r.feedcount+r.smscount;if(s===0){d(".notice_txt").hide()}else{d(".notice_txt").show()}if(r.feedcount===0){d("#J_SMSN").addClass("gray").removeClass("red")}else{d("#J_SMSN").addClass("red").removeClass("gray")}if(r.smscount===0){d("#J_SMST").addClass("gray").removeClass("red")}else{d("#J_SMST").addClass("red").removeClass("gray")}d("#J_SMSN").text(r.feedcount);d("#J_SMST").text(r.smscount);q.boxfix("top")})},startpull:function(){var q=this;q.pull();setInterval(function(){q.pull()},30*1000)},bindTarget:function(s){var r=this;var q={smstarget:".J_SMS",dataPid:"data-pid",dataName:"data-name"};d.extend(q,s);d(q.smstarget).live("click",function(){if(!p){var v=GM.widget.host,t="-min";if(GM.debug){t=""}d.loadcss(v+"sms/sms"+t+".css");p=true}var w=d(this).attr(q.dataPid),u=d(this).attr(q.dataName);r.setPid(w);r.setName(u);if(!n){r.overlay.fire(r.template)}else{r.overlay.fire()}d("#J_SMSName").val(f);if(!n){n=true;GM.widget.use("saycountdown",function(y){var x=new GM.widget.saycountdown({main:"#J_SMSContent",wrap:"#J_SizeWrap",errorCls:"blue",max:300,holdTarget:"#J_SMSPost",holdAction:function(){var A=d.trim(d("#J_SMSContent").val()),z=d.trim(d("#J_SMSName").val());r.setContent(A);if(A===""||z===""){alert("私信内容和收信人不能为空");return}if(!e){e=true;r.push({pid:m,content:o})}}});x.init()});GM.apps.require("face",function(x){var y=new x.face({target:"#J_SMSFace",main:"#J_SMSContent"});y.init()})}d("#J_SMSContent").val("");return false});d(r.cg.close).live("click",function(){r.overlay.close()})},addSmsIcon:function(){var q="div.friends>ul>li",r=function(s,t){return'<div class="user_messages"><a class="J_SMS" data-pid="'+s+'" data-name="'+t+'" href="javascript:void(0);"></a></div>'};d(q).bind("mouseenter",function(){var s=d(this).attr("data-pid"),t=d(this).attr("data-name");if(!s||!t){return}if(d(this).find(".J_SMS").length===0){d(this).append(r(s,t))}else{d(this).find(".J_SMS").show()}}).bind("mouseleave",function(){d(this).find(".J_SMS").hide()})},boxfix:function(q){var r=d("#J_Notice").offset();if(q=="top"){d("#J_SMSNotice").css({position:"absolute",left:r.left,top:r.top+20})}else{d("#J_SMSNotice").css({position:"absolute",left:r.left,top:d(window).scrollTop()})}},init:function(q){var r=this;r.startpull();r.bindTarget(q);r.addSmsIcon();d(window).bind("scroll resize",function(){var s=d(window).scrollTop();if(s===0){r.boxfix("top")}else{r.boxfix()}})}};return j}();if(c&&c.widget){c.widget.sms=new b()}})(window,GM,jQuery);
(function(W,G){var map=function(cg){if(!cg){return}var _cg={q:"",markerhtml:"",name:"",target:"",width:210,height:270,drag:false,bar:true,revise:false,center:null,siteNo:null,type:null};$.extend(_cg,cg);for(var i in _cg){this[i]=_cg[i]}};var centerflg=true;map.prototype={_loadcss:function(){var host=GM.widget.host,place="-min";if(GM.debug){place=""}$.loadcss(host+"map/map"+place+".css")},_searchQ:function(q,callback){if(google){var Gmap=google.maps,geocoder=new Gmap.Geocoder();geocoder.geocode({address:q},function(results,status){if(status==Gmap.GeocoderStatus.OK){var location=results[0].geometry.location;if(callback){callback(location)}}else{if(callback){callback(null)}}})}},drawmap:function(target,center,name,siteNo){if(google){var that=this,T,Circle,errortime=0,markersArray=[],Gmap=google.maps,Gevent=Gmap.event,infowindow=new Gmap.InfoWindow(),latlng=new Gmap.LatLng(center[0],center[1],true),myOptions={zoom:15,center:latlng,mapTypeId:Gmap.MapTypeId.ROADMAP};var map=new Gmap.Map(target,myOptions);var marker=new Gmap.Marker({title:name,position:latlng,map:map,draggable:function(){if(that.drag||that.type=="search"){return true}return false}()});var _fn={setlatlng:function(m,c){var center=m.getPosition();$("#J_Coord").html('lat:<span id="J_Pa">'+center.Pa+'</span><br/>lng:<span id="J_Oa">'+center.Qa+"</span>")},getPosition:function(m){var center=m.getPosition();return{lat:center.Qa,lng:center.Pa}},deleteMarkers:function(ary,cle){if(ary){for(i in ary){ary[i].setMap(null)}ary.length=0}if(cle){cle.setMap(null)}},infoshow:function(info,msg,position){clearTimeout(T);info.setContent(msg);if(position){info.setPosition(position)}info.open(map);T=setTimeout(function(){info.close()},3000)},infowindowShow:function(info,l){_fn.infoshow(info,"在此3公里范围找到了"+l+"家健身会馆,拖动此标志可继续查找",marker.getPosition())},addrimmarkers:function(ary,map,info,markAry){var infotemp='<div class="info-window"><p><a href="/s/{siteno}" target="_blank" class="green">{name}</a></p><p class="coaches">入驻教练：{coaches}</p><p>热线电话：{tel}</p><p class="map_more"><a href="/s/{siteno}" target="_blank">会所详细介绍&gt;&gt;</a></p>';"</div>";_fn.infoopen={};for(var i=0;i<ary.length;i++){(function(i){var result=ary[i],resultlat=result.lat,resultlng=result.lng,resultname=result.name;function addMarker(name,lat,lng){var newlatlng=new Gmap.LatLng(lat,lng,true),newmarker=new Gmap.Marker({title:name,position:newlatlng,map:map,icon:"http://s1.ifiter.com/static/images/map/124.png"});markAry.push(newmarker);var msg=$.substitute(infotemp,result);Gevent.addListener(newmarker,"click",function(){var current=i+1,max=10,page=Math.ceil(current/max);_fn.infoshow(info,msg,newlatlng);_fn.flip(page,$("#J_MAP_RightBar li"),i)});_fn.infoopen[i]=function(){_fn.infoshow(info,msg,newlatlng)}}result.coaches=function(){var tempary=result.coaches,returnstr="";if(tempary.length==0){return"暂无教练信息"}for(var i=0;i<tempary.length;i++){var tempobj=tempary[i];returnstr+='<a href="/uc/'+result.siteno+"/"+tempobj.cid+'" target="_blank" class="green">'+tempobj.cname+"</a>"}return returnstr}();if(resultlat=="0.0"&&resultlng=="0.0"){that._searchQ(result.cityZone,function(location){if(location){addMarker(resultname,location.Qa,location.Pa)}})}else{addMarker(resultname,resultlat,resultlng)}})(i);$(".info-window").die();$(".info-window").live("mouseover",function(){clearTimeout(T)});$(".info-window").live("mouseout",function(){T=setTimeout(function(){info.close()},3000)})}},infoopen:{},createRightlist:function(data){var errorhandle="this.parentNode.removeChild(this);",returnstr='<ul class="maplist">';for(var i=0;i<data.length;i++){var obj=data[i],temp='<li data-index="'+i+'"><p class="map_title"><a href="javascript:void(0)">{name}</a></p><p><span>会馆特色：</span>{feature}</p><p><span>特色项目：</span>{items}</p><p><span>热线电话：</span>{tel}</p><p><span>所在城市：</span>{cityZone}</p><p class="map_pic"><a href="/s/{siteno}" target="_blank"><img src="{logo}" width="120" height="120" title="{name}" alt="{name}" onerror="'+errorhandle+'"></a></p><p class="map_more"><a href="/s/{siteno}" target="_blank">会所详细介绍&gt;&gt;</a></p></li>';for(var j in data[i]){if(data[i][j]==""){data[i][j]="暂无"}}temp=$.substitute(temp,data[i]);returnstr+=temp}return returnstr+="</ul>"},paglist:function(data){if(data.length<10){return""}var returnstr="<div id='J_Paglist' data-current='1'>",max=10,page=0;if(data.length>10){returnstr+='<b id="J_PagBack">上一页</b>'}for(var i=0;i<data.length;i++){if(i%max==0){page++;returnstr+='<span data-num="'+page+'">['+page+"]</span>"}}if(data.length>10){returnstr+='<b id="J_PagNext">下一页</b>'}return returnstr+='</div><input type="hidden" value="'+page+'" id="J_PagLength">'},flip:function(current,lis,guide){var max=10;lis.hide();lis.each(function(index,node){var index=index+1;if(index<=current*max&&index>(current-1)*max){$(node).show()}});$("#J_Paglist").attr("data-current",current);if(!guide){guide=(current-2)*max+max}_fn.Rightfold(guide);_fn.infoopen[guide]();var l=$("#J_PagLength").val();if(current==1){$("#J_PagBack").hide()}else{$("#J_PagBack").show()}if(current==l){$("#J_PagNext").hide()}else{$("#J_PagNext").show()}var currentSpan=$("#J_Paglist>span").eq(current-1),text=currentSpan.text();$("#J_Paglist>span").each(function(){$(this).removeClass("current");var num=$(this).text().match(/\d/g)[0];$(this).text("["+num+"]")});currentSpan.addClass("current");currentSpan.text(text.replace(/\[|\]/g,""))},Rightfold:function(guide){$(".maplist li>p").find("a").removeClass("active");$(".maplist li>p").not(".map_title").hide();$(".maplist li:eq("+guide+")>p").show().find("a").addClass("active");$(".map_title").die();$(".map_title").live("click",function(){$(".maplist li>p").not(".map_title").hide();$(".maplist li>p.map_title a").removeClass("active");$(this).siblings("p").show();$(this).parent().find(".map_title a").addClass("active");var index=$(this).closest("li").attr("data-index");_fn.infoopen[index]()})},clickseach:function(e){var lat=e.latLng["Qa"],lng=e.latLng["Pa"],darwin=new Gmap.LatLng(lng,lat);marker.setPosition(darwin);_fn.postPostion(marker)},postPostionSuccess:function(data,lat,lng){var darwin=new Gmap.LatLng(lat,lng,true);map.setCenter(darwin);map.setZoom(13);try{eval("var data="+$.trim(data))}catch(e){console.log(e)}if(data.r!=0){return}var dataAry=data.s["result"];_fn.deleteMarkers(markersArray,Circle);Circle=new Gmap.Circle({strokeColor:"#0552A5",fillOpacity:0.1,fillColor:"#0764C1",map:map,strokeWeight:1,radius:3200,center:marker.getPosition()});Gevent.addListener(Circle,"click",_fn.clickseach);_fn.addrimmarkers(dataAry,map,infowindow,markersArray);_fn.pagallfire(dataAry);if(dataAry.length==0){$("#J_MAP_RightBar").html("附近没有找到相应的场馆")}},tosearch:function(){var q=$.trim($("#J_SearchMapText").val());if(q==""){alert("请输入搜索地址，比如:北京市 朝阳区");return}that._searchQ(q,function(location){if(location){var darwin=new Gmap.LatLng(location.Pa,location.Qa,true);map.setCenter(darwin);marker.setPosition(darwin);_fn.postPostion(marker)}else{_fn.getourcoord({city:that.q,q:q},function(data){if(data&&data.r==0){var dataAry=data.s["result"];if(dataAry.length==0){alert("对不起，没有找到你想搜索的地名或场馆");return}_fn.deleteMarkers(markersArray,Circle);_fn.addrimmarkers(dataAry,map,infowindow,markersArray);_fn.pagallfire(dataAry);var darwin=new Gmap.LatLng(dataAry[0]["lat"],dataAry[0]["lng"],true);map.setCenter(darwin);map.setZoom(11)}else{alert("系统错误")}})}})},pagallfire:function(dataAry){var Rightlist=_fn.createRightlist(dataAry),pag=_fn.paglist(dataAry);$("#J_MAP_RightBar").html(Rightlist+pag);var dieary=["#J_Paglist span","#J_PagBack","#J_PagNext","#J_SearchSub","#J_SearchMapText","#J_ShareSina"];$.each(dieary,function(index,val){$(val).die()});$("#J_Paglist span").live("click",function(){var current=parseInt($(this).attr("data-num"));_fn.flip(current,$("#J_MAP_RightBar li"))});$("#J_PagBack").live("click",function(){var current=parseInt($("#J_Paglist").attr("data-current"));_fn.flip(current-1,$("#J_MAP_RightBar li"));$("#J_Paglist").attr("data-current",current-1)});$("#J_PagNext").live("click",function(){var current=parseInt($("#J_Paglist").attr("data-current"));_fn.flip(current+1,$("#J_MAP_RightBar li"));$("#J_Paglist").attr("data-current",current+1)});if(dataAry.length!=0){_fn.flip(1,$("#J_MAP_RightBar li"))}$("#J_SearchSub").live("click",_fn.tosearch);$("#J_SearchMapText").live("keydown",function(e){if(e.keyCode==13){_fn.tosearch()}});$("#J_ShareSina").live("click",function(){var tsina="http://v.t.sina.com.cn/share/share.php?title={T}&url={U}",href=$.substitute(tsina,{T:"哈哈，我终于在我身边半径3公里的地区找到了适合我的健身场馆，真是不看不知道啊。你也可以来试试哦。（来自：动米网）",U:encodeURIComponent(window.location.href)});$(this).attr("href",href)})},getourcoord:function(data,callback){var coordurl="/api/mi.jsp?v=geokey/"+encodeURI(data.q),c=0,mc=3,t=1000;$.ajax({type:"GET",url:coordurl,success:function(result){try{eval("var r="+$.trim(result))}catch(e){console.log(e);var r=null}if(callback){callback(r)}},error:function(){if(c==mc){alert("网络延迟请重新查询");c=0;return}setTimeout(function(){_fn.getourcoord(data,callback);c++},t)}})},postPostionError:function(){errortime++;if(errortime==3){alert("连续请求失败,建议重新刷新页面");return}setTimeout(function(){_fn.postPostion(marker)},1000)},postPostion:function(m){var coord=_fn.getPosition(m),action="/api/mi.jsp?v=geo/"+coord.lat+"/"+coord.lng;$.ajax({url:action,type:"GET",success:function(data){_fn.postPostionSuccess(data,coord.lng,coord.lat);that._sharehash(coord.lng,coord.lat)},error:_fn.postPostionError})}};if(that.markerhtml!=""){infowindow.setContent(that.markerhtml);infowindow.open(map,marker);Gevent.addListener(marker,"click",function(){infowindow.open(map,marker)})}if(that.drag){_fn.setlatlng(marker,center);Gevent.addListener(marker,"dragend",function(){_fn.setlatlng(marker,center)})}if(that.type=="search"){_fn.postPostion(marker);Gevent.addListener(marker,"dragend",function(){_fn.postPostion(marker)});Gevent.addListener(marker,"drag",function(e){infowindow.close();clearTimeout(T);Circle.setCenter(e.latLng)});Gevent.addListener(map,"click",_fn.clickseach)}if(that.bar){that._bulidbar(that.target)}}},_bulidbar:function(target){var revise="",that=this,bar;if(that.revise){revise='<li><a href="javascript:void(0);" class="J_EditMap">修订坐标</a></li>'}bar='<ul class="map_bar"><li><a href="javascript:void(0);" class="J_LookBigMap">查看全图</a></li><li><a href="javascript:void(0);" class="J_LookWay">公交/驾车</a></li>'+revise+"</ul>";$("#"+target).after(bar)},_errorClick:function(){var BigMap='<div class="emersion error"><div class="msg">对不起,没有可以查看的地图信息</div><a href="javascript:void(0);" class="J_OverlayClose mapclose">&times</a></div>';G.tools.overlay.fire(BigMap)},_setwrap:function(target){var that=this;target.style.cssText+="width:"+that.width+"px;height:"+that.height+"px;border:1px solid #CCC;"},_Initerror:function(target){target.parentNode.removeChild(target)},_sharehash:function(lat,lng){var that=this;W.location.hash="lat="+lat+"&lng="+lng},init:function(){var that=this,target=document.getElementById(that.target),hashval=W.location.hash.slice(1),Initlatlng=$.analyse(hashval);that._loadcss();if(Initlatlng.lat&&Initlatlng.lng){that.center=[Initlatlng.lat,Initlatlng.lng]}if(!that.center){that._searchQ(that.q,function(location){if(location){that.center=[location.Pa,location.Qa];that.drawmap(target,that.center,that.name,that.siteNo)}else{that._Initerror(target)}})}else{if(that.center){if(centerflg&&!Initlatlng.lat&&!Initlatlng.lng){that.center=[that.center[1],that.center[0]];centerflg=false}that.drawmap(target,that.center,that.name,that.siteNo)}}that._setwrap(target);$.overlay();var events=[".J_LookBigMap",".J_LookWay",".J_OverlayClose",".J_EditMap","#J_SqSub","#J_Esub"];$.each(events,function(key,val){$(val).die()});$(".J_LookBigMap").live("click",function(){if(that.coord||that.center){that._BigMapaction()}else{that._errorClick()}});if(/jsmap\=lookmap/.test(W.location.href)){$(window).load(function(){if(that.coord||that.center){that._BigMapaction()}else{that._errorClick()}})}$(".J_LookWay").live("click",function(){if(that.coord||that.center){that._lookway()}else{that._errorClick()}});$(".J_OverlayClose").live("click",function(){G.tools.overlay.close()});$("#J_SqSub").live("click",function(){var diget=$(this).attr("data-diget"),map=new G.widget.map({q:$("#J_Sq").val(),markerhtml:"拽我，拽我，确定准确的位置~",target:"J_Map_"+diget,width:600,height:500,bar:false,drag:true,name:that.name,siteNo:that.siteNo}).init()});$(".J_EditMap").live("click",function(){if(that.coord||that.center){that._editaction()}else{that._errorClick()}});$("#J_Esub").live("click",function(){that._revise()})},_BigMapaction:function(){var diget=new Date().valueOf(),that=this,BigMap='<div class="emersion bigmap"><div id="J_Map_'+diget+'" style="height:500px;"></div><a href="javascript:void(0);" class="J_OverlayClose mapclose">&times</a></div>';G.tools.overlay.opacity(0.5);G.tools.overlay.fire(BigMap);var map=new G.widget.map({q:that.q,markerhtml:that.markerhtml,target:"J_Map_"+diget,width:500,height:500,bar:false,name:that.name,center:that.center,siteNo:that.siteNo}).init()},_lookway:function(){var that=this;var Way='<div class="emersion lookway"><form action="http://ditu.google.cn/maps" method="get" target="_blank"><div class="lookway_title">请输入出发所在地</div><div class="lookway_content"><span>出发地</span><input type="text" name="saddr" class="profile_box1"></div><div><input type="submit" value="确认" class="space_button"></div><input value="'+that.q+","+that.name+'" type="hidden" name="daddr"/></form><a href="javascript:void(0);" class="J_OverlayClose mapclose">&times</a></div>';G.tools.overlay.opacity(0.5);G.tools.overlay.fire(Way)},_editaction:function(){var diget=new Date().valueOf(),that=this,BigMap='<div class="emersion edit"><div id="J_Map_'+diget+'" style="height:500px;""></div><a href="javascript:void(0);" class="J_OverlayClose mapclose">&times</a><div class="editbox">搜索:<br><input type="text" id="J_Sq"/><br/>操作:<br><input type="button" data-diget="'+diget+'" id="J_SqSub" value="搜索"/> <input type="button" id="J_Esub" value="保存坐标"/><br/>坐标:<br><span id="J_Coord"></span></div></div>';G.tools.overlay.opacity(0);G.tools.overlay.fire(BigMap);var map=new G.widget.map({q:that.q,markerhtml:"拽我，拽我，确定准确的位置~",target:"J_Map_"+diget,width:600,height:500,bar:false,drag:true,name:that.name,center:that.center,siteNo:that.siteNo}).init()},_revise:function(){var that=this;if(confirm("确定保存当前标记位置为新场馆位置么？")){$.ajax({url:"/gestion/map.jsp",data:{siteno:that.siteNo,latitude:$("#J_Oa").text(),longitude:$("#J_Pa").text(),act:"update"},success:function(str){var result=$.trim(str);if(result==1){alert("保存成功");window.location.href="/gestion/map.jsp?siteno="+that.siteNo}else{alert("操作失败")}},error:function(){alert("相应超时，重新保存")}})}}};if(G&&G.widget){G.widget.map=map}})(window,GM);
(function(a,b){var c=function(f){if(!f){return}var d={q:"",markerhtml:"",name:"",target:"",width:210,height:270,drag:false,bar:true,revise:false,center:null,siteNo:null};$.extend(d,f);for(var e in d){this[e]=d[e]}};c.prototype={init:function(){var g=this,j=document.getElementById(g.target);function d(l){l.style.cssText+="width:"+g.width+"px;height:"+g.height+"px;border:1px solid #CCC;"}function e(l){l.parentNode.removeChild(l)}function i(n){if(g.bar){var l="";if(g.revise){l='<li style="float: left; display: block; margin: 0pt 10px;line-height:12px;font-size:12px;"><a style="color:#4077C7;" href="javascript:void(0);" class="J_EditMap">修订坐标</a></li>'}var m='<ul style="margin: 5px 0pt;width:210px;padding:0px;"><li style="float: left; display: block; margin: 0pt 10px;line-height:14px;font-size:12px;"><a style="color:#4077C7;" href="javascript:void(0);" class="J_LookBigMap">查看全图</a></li><li style="float: left; display: block; margin: 0pt 10px;line-height:14px;font-size:12px;"><a style="color:#4077C7;" href="javascript:void(0);" class="J_LookWay">公交/驾车</a></li>'+l+"</ul>";$("#"+n).after(m)}}function h(r,l,n,t){if(google){geocoder=new google.maps.Geocoder();var o=new google.maps.LatLng(l[1],l[0]);var u={zoom:15,center:o,mapTypeId:google.maps.MapTypeId.ROADMAP};var m=new google.maps.Map(r,u);var q=new google.maps.Marker({title:n,position:o,map:m,draggable:function(){if(g.drag){return true}return false}()});if(g.markerhtml!=""){var p=new google.maps.InfoWindow({content:g.markerhtml});p.open(m,q);google.maps.event.addListener(q,"click",function(){p.open(m,q)})}if(g.drag){function s(){var v=q.getPosition();$("#J_Coord").html('lat:<span id="J_Pa">'+v.Pa+'</span><br/>lng:<span id="J_Oa">'+v.Oa+"</span>")}google.maps.event.addListener(q,"dragend",function(){s()});s()}i(g.target)}}function k(){var l='<div style="position:relative;width:200px;height:200px;border:#ccc solid 2px;background:#fff;"><div style="margin-top:80px;font-size:12px;color:red;text-align:center;">对不起,没有可以查看的地图信息</div><a href="javascript:void(0);" class="J_OverlayClose" style="position:absolute;right:-10px;top:-10px;display:block;width:15px;height:15px;background:#000;color:#fff;line-height:15px;text-align:center;">&times</a></div>';b.tools.overlay.fire(l)}if(!g.center){if(google){geocoder=new google.maps.Geocoder();geocoder.geocode({address:g.q},function(n,m){if(m==google.maps.GeocoderStatus.OK){var l=n[0].geometry.location;g.center=[l.Pa,l.Oa];h(j,g.center,g.name,g.siteNo)}else{e(j)}})}}else{if(g.center){h(j,g.center,g.name,g.siteNo)}}d(j);$.overlay();var f=[".J_LookBigMap",".J_LookWay",".J_OverlayClose",".J_EditMap","#J_SqSub","#J_Esub"];$.each(f,function(l,m){$(m).die()});$(".J_LookBigMap").live("click",function(){if(g.coord||g.center){var l=new Date().valueOf(),m='<div style="position:relative;width:500px;height:500px;border:#ccc solid 2px;"><div id="J_Map_'+l+'" style="height:500px;"></div><a href="javascript:void(0);" class="J_OverlayClose" style="position:absolute;right:-10px;top:-10px;display:block;width:15px;height:15px;background:#000;color:#fff;line-height:15px;text-align:center;">&times</a></div>';b.tools.overlay.opacity(0.5);b.tools.overlay.fire(m);var n=new b.widget.map({q:g.q,markerhtml:g.markerhtml,target:"J_Map_"+l,width:500,height:500,bar:false,name:g.name,center:g.center,siteNo:g.siteNo}).init()}else{k()}});$(".J_LookWay").live("click",function(){if(g.coord||g.center){var l='<div style="position:relative;width:300px;height:100px;border:#ccc solid 2px;background:#fff;"><form action="http://ditu.google.cn/maps" method="get" target="_blank" style="padding: 10px; text-align: center;"><div style="color:#78A000; font-size: 14px; font-weight: bold;">请输入出发所在地</div><div style="margin: 10px 0pt;"><span style="margin-right: 10px;font-size:12px;">出发地</span><input type="text" name="saddr" value="" class="profile_box1"></div><div><input type="submit" value="确认" class="space_button"></div><input value="'+g.q+","+g.name+'" type="hidden" name="daddr"/></form><a href="javascript:void(0);" class="J_OverlayClose" style="position:absolute;right:-10px;top:-10px;display:block;width:15px;height:15px;background:#000;color:#fff;line-height:15px;text-align:center;">&times</a></div>';b.tools.overlay.opacity(0.5);b.tools.overlay.fire(l)}else{k()}});$(".J_OverlayClose").live("click",function(){b.tools.overlay.close()});$("#J_SqSub").live("click",function(){var l=$(this).attr("data-diget");var m=new b.widget.map({q:$("#J_Sq").val(),markerhtml:"拽我，拽我，确定准确的位置~",target:"J_Map_"+l,width:600,height:500,bar:false,drag:true,name:g.name,siteNo:g.siteNo}).init()});$(".J_EditMap").live("click",function(){if(g.coord||g.center){var l=new Date().valueOf(),m='<div style="position:relative;width:600px;height:500px;border:#ccc solid 2px;"><div id="J_Map_'+l+'" style="height:500px;""></div><a href="javascript:void(0);" class="J_OverlayClose" style="position:absolute;right:-10px;top:-10px;display:block;width:15px;height:15px;background:#000;color:#fff;line-height:15px;text-align:center;">&times</a><div style="background:#fff;width:150px;height:140px;padding:10px;position:absolute;left:-180px;top:150px;border:#ccc solid 1px;">搜索:<br><input type="text" id="J_Sq"/><br/>操作:<br><input type="button" data-diget="'+l+'" id="J_SqSub" value="搜索"/> <input type="button" id="J_Esub" value="保存坐标"/><br/>坐标:<br><span id="J_Coord" style="color:red;"></span></div></div>';b.tools.overlay.opacity(0);b.tools.overlay.fire(m);var n=new b.widget.map({q:g.q,markerhtml:"拽我，拽我，确定准确的位置~",target:"J_Map_"+l,width:600,height:500,bar:false,drag:true,name:g.name,center:g.center,siteNo:g.siteNo}).init()}else{k()}});$("#J_Esub").live("click",function(){if(confirm("确定保存当前标记位置为新场馆位置么？")){$.ajax({url:"/gestion/map.jsp",data:{siteno:g.siteNo,latitude:$("#J_Pa").text(),longitude:$("#J_Oa").text(),act:"update"},success:function(m){var l=$.trim(m);if(l==1){alert("保存成功");window.location.href="/gestion/map.jsp?siteno="+g.siteNo}else{alert("操作失败")}},error:function(){alert("相应超时，重新保存")}})}})}};if(b&&b.widget){b.widget.map=c}})(window,GM);
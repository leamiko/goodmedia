(function(a,c,d){var b=function(){var f,o,m,i,l,h=5000,k,n,e;function g(){return new Date().valueOf()}var j=function(q){var p={pushurl:"http://x.idongmi.com/pm/indexAction.jsp?flag=send",pullurl:"http://x.idongmi.com/pm/indexAction.jsp?flag=receive&callback=GM.widget.sms.pullback",close:"#J_SMSclose",template:function(r){return'<div class="inform_cont pletter_cont" style="position:relative;width:450px;height:240px;min-height:240px;background:#fff;"><div class="pletter_list"><div class="post">收件人：</div><div class="pletter_content"><input id="J_SMSName" type="text" class="pletter_box1" readonly="readyonly" value=""></div><div class="clear"></div></div><div class="pletter_list"><div class="post">内 容：</div><div class="pletter_content"><div class="pletter_prompt" id="J_SizeWrap"></div><textarea id="J_SMSContent" class="pletter_box2"></textarea><div class="pletter_insert"><a href="javascript:void(0);" id="J_SMSFace"><span class="ico1"></span>表情</a></div></div><div class="clear"></div></div><div class="pletter_but"><input type="button" value="发   信" id="J_SMSPost"></div><div style="position:absolute;width:15px;text-align:center;height:15px;line-height:15px;cursor:pointer;right:-5px;top:-5px;background:#000;color:#fff;font-size:18px;overflow:hidden;" title="关闭" id="'+r.close.slice(1)+'">&times</div></div>'}};if(q){d.extend(p,q)}this.cg=p;this.overlay=d.overlay({content:p.template(p)})};j.prototype={timeout:function(){e=false;alert("相应超时,请重试")},push:function(r){var q=this,p=q.cg,r=d.param(r);l=g();k=false;q["pushcallback"+l]=q.pushback;d.getScript(p.pushurl+"&"+r+"&callback=GM.widget.sms.pushcallback"+l);i=setTimeout(function(){if(!k){delete q["pushcallback"+l];q.timeout()}},h)},pull:function(r){var q=this,p=q.cg;d.getScript(p.pullurl)},setName:function(p){f=p},setContent:function(p){o=p},setPid:function(p){m=p},pushback:function(q){var p=this;clearTimeout(i);k=true;e=false;if(q.s==1){}else{p.pusherror(q.msg)}delete p["pushcallback"+l]},pusherror:function(p){alert(p)},pullback:function(q){var p=this;if(q.s==1){p.updatebox(q)}},updatebox:function(p){d(function(){if(d("#J_Notice").length!=0&&d("#J_SMSNUM").length==0){d("#J_Notice").after('<div class="notice_txt"><a href="/pm/index.jsp">消息（<span id="J_SMSNUM"></span>）</a></div>')}var q=p.feedcount+p.smscount;d("#J_SMSNUM").text(q)})},startpull:function(){var p=this;p.pull();setInterval(function(){p.pull()},30*1000)},bindTarget:function(r){var q=this;var p={smstarget:".J_SMS",dataPid:"data-pid",dataName:"data-name"};d.extend(p,r);d(p.smstarget).live("click",function(){var t=d(this).attr(p.dataPid),s=d(this).attr(p.dataName);q.setPid(t);q.setName(s);q.overlay.fire();d("#J_SMSName").val(f);if(!n){n=true;GM.widget.use("saycountdown",function(v){var u=new GM.widget.saycountdown({main:"#J_SMSContent",wrap:"#J_SizeWrap",errorCls:"blue",holdTarget:"#J_SMSPost",holdAction:function(){var x=d.trim(d("#J_SMSContent").val()),w=d.trim(d("#J_SMSName").val());q.setContent(x);if(x==""||w==""){alert("私信内容和收信人不能为空");return}if(!e){e=true;q.push({pid:m,content:o})}}});u.init()});GM.apps.require("face",function(u){var v=new u.face({target:"#J_SMSFace",main:"#J_SMSContent"});v.init()})}return false});d(q.cg.close).live("click",function(){q.overlay.close()})},init:function(p){var q=this;q.startpull();q.bindTarget(p)}};return j}();if(c&&c.widget){c.widget.sms=new b()}})(window,GM,jQuery);
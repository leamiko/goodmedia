<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />    
  <title>The source code</title>
    <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
    <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
</head>
<body  onload="prettyPrint();">
    <pre class="prettyprint lang-js">/*!
 * X weibo JavaScript Library v1.1
 * http://x.weibo.com/
 * 
 * Copyright 2010 SINA Inc.
 * Date: 2010/10/28 21:22:06
 */

(function(X){

if(!window.__debug)
    __debug = false;

var String = window.String,
    undefined,
    trimReg = new RegExp("(?:^\\s*)|(?:\\s*$)", "g"),
    localDomain  = location.hostname,
    domainReg = /:\/\/(.[^\/]+)/;

var XwbRequest = {

<div id="cls-Xwb.util"></div>/**
 * @class Xwb.util
 * Utility Package
 * @static
 */
    util : {
       <div id="method-Xwb.util-templ"></div>/**
        * @param {String} templateString
        * @param {Object} dataMap
        * @param {Boolean} [urlencode] encodeURIComponent for value
        * @param {Boolean} [cascade] cascade apply template from value
        example:
        <pre>
            <code>
                var name = templ('My name is {name}', {name:'xweibo'});
                var url  = templ('http://www.server.com/getName?name={name}', {name:'微博'}, true);
            </code>
        </pre>
        */
       templ : function(str, map, urlencode, cascade){
            return str.replace(/\{([\w_$]+)\}/g, function(s, s1){
                var v = map[s1];
                if(cascade && typeof v === 'string')
                    v = argument.callee(v, map, urlencode, cascade);
                
                if(v === undefined || v === null) 
                    return '';
                return urlencode?encodeURIComponent(v) : v;
            });
       },
       
        <div id="method-Xwb.util-extend"></div>/**
         * @param {Object} target 目标对象,可为空
         * @param {Object} source 源对象
         * @param {Boolean} [override]
         * @return {Object} target
         */
        extend : function(target, src, override){
          if(!target)
            target = {};
          if(src){
            for(var i in src)
                if(target[i]===undefined || override)
                    target[i] = src[i];
          }
          return target;
        },
        
        <div id="method-Xwb.util-trim"></div>/**
         * 移除字符串最左与最右边的空格
         * @param {String} string
         * @return {String}
         */
        trim : function(s){
            return s.replace(trimReg, "");
        },

        <div id="method-Xwb.util-queryString"></div>/**
         * 返回对象查询字符串表示形式.
         * <pre><code>
           var obj = {name:'xweibo', age:'25'};

           //显示 name=rock&age=25
           alert(queryString(obj));
         * </code></pre>
         * @param {Object} obj
         * @return {String} 对象的查询字符串表示形式
         */
        queryString : function(obj) {
            if(!obj)
                return '';
            var arr = [];
            for(var k in obj){
                var ov = obj[k], k = encodeURIComponent(k);
                var type = typeof ov;
                if(type === 'undefined'){
                    arr.push(k, "=&");
                }else if(type != "function" && type != "object"){
                    arr.push(k, "=", encodeURIComponent(ov), "&");
                }else if(ov instanceof Array){
                    if (ov.length) {
                        for(var i = 0, len = ov.length; i < len; i++) {
                            arr.push(k, "=", encodeURIComponent(ov[i] === undefined ? '' : ov[i]), "&");
                        }
                    } else {
                        arr.push(k, "=&");
                    }
                }
            }
            arr.pop();
            return arr.join("");
        },
        
        <div id="method-Xwb.util-bind"></div>/**
         * 如果仅仅想切换this范围，而又使代理函数参数与原来参数一致的，可使用本方法。
         * @param {Function} sourceFunction
         * @param {Object} scope scope.func()
         * @return {Function}
         */
        bind : function(fn, scope){
          return function() {
              return fn.apply(scope, arguments);
          };
        },

        <div id="cls-Xwb.request.AjaxConfig"></div>/**
         * @class Xwb.request.AjaxConfig
         * {@link Xwb.util#ajax}方法的请求参数
         */
         <div id="cfg-Xwb.request.AjaxConfig-url"></div>/**
          * @cfg {String} url 请求目标URL
          */
         <div id="cfg-Xwb.request.AjaxConfig-method"></div>/**
          * @cfg {String} method 请求方法 POST/GET
          */
         <div id="cfg-Xwb.request.AjaxConfig-encoding"></div>/**
          * @cfg {String} encoding 发送内容的字符编码，未设置采用默认
          */
         <div id="cfg-Xwb.request.AjaxConfig-dt"></div>/**
          * @cfg {String} dt dataType，返回内容类据类型，text或json，默认为json，系统根据该类型传递对应类型的数据到回调方法的参数中。
          */
         <div id="cfg-Xwb.request.AjaxConfig-data"></div>/**
          * @cfg {String|Object} data 请求时传递的数据，可为字符串，也可为键值对。
          */
          <div id="cfg-Xwb.request.AjaxConfig-cache"></div>/**
           * @cfg {Boolean} cache 请求时是否应用缓存，默认忽略缓存
           */
         <div id="cfg-Xwb.request.AjaxConfig-scope"></div>/**
          * @cfg {Object} scope 可指定回调方法调用时的this对象
          */
         <div id="cfg-Xwb.request.AjaxConfig-success"></div>/**
          * @cfg {Function} success 请求成功后回调方法
          * @param {Mixed} data 根据设定的数据类型传递不同的类型数据
          * @param {XMLHttpRequest} ajax 
          */
         <div id="cfg-Xwb.request.AjaxConfig-failure"></div>/**
          * @cfg {Function} failure 请求失败后回调方法
          * @param {String} responseText 根据设定的数据类型传递不同的类型数据
          * @param {XMLHttpRequest} ajax 
          */
          
        /**
         * @class Xwb.util
         */
        <div id="method-Xwb.util-ajax"></div>/**
         * 发起一个ajax请求.
         * @param {Xwb.request.AjaxConfig} param 请求参数
         * @return {XMLHttpRequest}
         */
        ajax : function(param){
            var ajax, url = param.url;
            
            if (window.XMLHttpRequest) {
                ajax = new XMLHttpRequest();
            } else {
                if (window.ActiveXObject) {
                    try {
                        ajax = new ActiveXObject("Msxml2.XMLHTTP");
                    } catch (e) {
                        try {
                            ajax = new ActiveXObject("Microsoft.XMLHTTP");
                        } catch (e) { }
                        }
                    }
            }
            
            
            if(ajax){
                param.method = param.method ? param.method.toUpperCase() : 'GET';
                // setup param

                var ps = param.data, ch = !param.cache;
                if(ps || ch){
                    var isQ = url.indexOf('?') >= 0;
                    if(ch){
                        if (isQ)
                            url = url + '&_=' + (+new Date());
                        else
                            url = url + '?_=' + (+new Date());
                    }
                    
                    // append data to url or parse post data to string
                    if(ps){
                        if(typeof ps === 'object')
                            ps = Util.queryString(ps);
                        if(param.method === 'GET'){
                            if(!isQ && !ch)
                                url = url+'?';
            
                            url = url + '&' + ps;
                        }
                    }
                }
                ajax.open(param.method, url, true);
                
                if (param.method === 'POST')
                    ajax.setRequestHeader('Content-type', 'application/x-www-form-urlencoded; charset='+(param.encoding?param.encoding:''));
                
                ajax.onreadystatechange = function(){
                    if (ajax.readyState === 4) {
                        var ok = (ajax.status === 200);
                        if(ok && param.success){
                            try{
                                var data = (!param.dt || param.dt === 'json') ? eval("("+ajax.responseText+");") : ajax.responseText;
                            }catch(e){
                                if( __debug ) console.error('服务器返回JSON格式有误，请检查。\n',e,'\n', ajax.responseText);
                                ok = false;
                            }
                            if (ok)
                                param.success.call(param.scope||this, data, ajax);
                        }
                        
                        if(!ok && param.failure){
                            param.failure.call(param.scope||this, ajax.responseText, ajax);
                        }
                    }
                };
                
                // send POST data
                ajax.send("POST" === param.method ? ps : undefined);
                
                return ajax;
            }
        },
        
        <div id="cls-Xwb.request.JSONPConfig"></div>/**
         * @class Xwb.request.JSONPConfig
         * {@link Xwb.util#jsonp}方法的请求参数
         */
         
         <div id="cfg-Xwb.request.JSONPConfig-url"></div>/**
          * @cfg {String} url 请求目标URL
          */
         <div id="cfg-Xwb.request.JSONPConfig-doc"></div>/**
          * @cfg {DOMElement} doc 可以指定生成JSONP脚本所在的document
          */
         
         <div id="cfg-Xwb.request.JSONPConfig-scope"></div>/**
          * @cfg {Object} scope 可指定回调方法调用时的this对象
          */
          
         <div id="cfg-Xwb.request.JSONPConfig-data"></div>/**
          * @cfg {Object} data 作为提交参数的键值对
          */
          
          <div id="cfg-Xwb.request.JSONPConfig-charset"></div>/**
           * @cfg {String} charset JSONP脚本字符编码
           */
           <div id="cfg-Xwb.request.JSONPConfig-script"></div>/**
            * @cfg {Object} script 进行JSONP请求的script标签的属性集，在请求前该属性集将被复制到script标签中
            */
         <div id="cfg-Xwb.request.JSONPConfig-success"></div>/**
          * @cfg {Function} success 请求成功后回调方法
          * @param {Object} data 根据设定的数据类型传递不同的类型数据
          * @param {XMLHttpRequest} ajax
          */
         <div id="cfg-Xwb.request.JSONPConfig-failure"></div>/**
          * @cfg {Function} failure 请求失败后回调方法
          * @param {String} responseText 根据设定的数据类型传递不同的类型数据
          * @param {XMLHttpRequest} ajax 
          */
          <div id="cfg-Xwb.request.JSONPConfig-jsonp"></div>/**
           * @cfg {String} jsonp 指定JSONP请求标识参数的名称，默认为'jsonp'
           */
        /**
         * @class Xwb.util
         */
         <div id="method-Xwb.util-jsonp"></div>/**
          * 发起一个JSONP请求
         * @param {String} url 目标地址
         * @param {Xwb.request.JSONPConfig} param 请求参数
         * @return {HTMLElement} scriptElement
         */
        jsonp : function(param){
            var fn  = 'jsonp_' + (+new Date()),
                doc = param.doc || document, 
                url = param.url,
                script = doc.createElement('script'),
                hd = doc.getElementsByTagName("head")[0],
                success;
            
            if(typeof param == 'function'){
                success = param;
                param = {};
            }else success = param.success;
            
            
            script.type = 'text/javascript';
            param.charset && (script.charset = param.charset);
            param.deffer  && (script.deffer  = param.deffer);
            
            url = url + ( url.indexOf('?')>=0 ? '&' + ( param.jsonp || 'jsonp')+'='+fn : '?'+( param.jsonp || 'jsonp')+'='+fn);
            
            if(param.data)
                url += '&'+Util.queryString(param.data);
            
            if(param.script){
                Util.extend(script, param.script);
                delete param.script;
            }
            
            script.src = url;

            var cleaned = false;
            
            function clean(){
                if(!cleaned){
                    try {
                        delete window[fn];
                        script.parentNode.removeChild(script);
                        script = null;
                    }catch(e){}
                    cleaned = true;
                }
            }
            
            window[fn] = function(){
                clean();
                if(success)
                  success.apply(param.scope||this, arguments);
            };

            script.onreadystatechange = script.onload = function(){
                var rs = this.readyState;
                // 
                if( !cleaned && (!rs || rs === 'loaded' || rs === 'complete') ){
                    clean();
                    if(param.failure)
                        param.failure.call(param.scope||this);
                }
            };
            
            hd.appendChild(script);
            
            return script;
        }
    },
    
<div id="cls-Xwb.request.XwbRequestConfig"></div>/**
 * @class Xwb.request.XwbRequestConfig
 * @extends Xwb.request.AjaxConfig
 */
 
 <div id="cfg-Xwb.request.XwbRequestConfig-success"></div>/**
  * @cfg {Function} success
  * @param {Xwb.request.ResponseDefinition} data
  */

<div id="cls-Xwb.request"></div>/**
 * @class Xwb.request
 * Xwb库数据层API。<br/>
 * 发起任何请求前请先执行初始化{@link #init}。
 * @static
 * @namespace
 */

<div id="method-Xwb.request-init"></div>/**
 *  初始化请求。发起任何请求前请先初始化。
 * @param {String} serverBaseUrl 服务器URL.
 * @return this
 */
    init : function(server){
        this.basePath = server;
        return this;
    },
    
<div id="method-Xwb.request-direct"></div>/**
 * 发起一个请求。<br>请求不必理会是否跨域，系统会判断是否同域调用ajax或JSONP请求。
 * @param {String} url
 * @param {Xwb.request.RequestConfig} config
 */
    direct : function(cfg){
        if(!cfg)
            cfg = {};
            
        // make a success handler wrapper
        var handler = cfg.success, connector;
        cfg.success = function(data, connector){
            var e = new ( cfg.responseDefinition || XwbRequest.DefaultResponseDefinition ) (data, cfg, connector);
            
            if(__debug) console.log('req e:', e);
            
            if(cfg.scope)
                handler.call(cfg.scope, e);
            else handler(e);
            
            data = null;
            e = null;
            connector = null;
        };
        // check domain the same
        var domain = cfg.url.match(domainReg);
        connector = !domain || domain[1] == localDomain ? Util.ajax(cfg) : Util.jsonp(cfg);
    },
    
/**
 * 利用给定参数发起一个POST请求
 * @param {String} url
 * @param {Object} data
 * @param {Function} successCallback
 * @param {Xwb.request.RequestConfig} config
 * <code><pre>
    // POST
    Xwb.request.post(
        'http://demo.rayli.com.cn/?m=action.getCounts',
        {ids:'3042338323,3042296891'},
        function(e){
            if(e.isOk()){
                console.log(e.getRaw());
            }
        }
    );
   </pre></code>
 * @private
 */
    postReq : function(url, data, success, cfg){
        !cfg && (cfg = {});
        cfg.method = 'POST';
        this.q(url, data, success, cfg);
    },

<div id="method-Xwb.request-q"></div>/**
 * 利用给定参数发起一个请求。
 * q是query的缩写。
 * @param {String} url
 * @param {Object} data
 * @param {Function} successCallback
 * @param {Xwb.request.RequestConfig} config

 * <code><pre>
    // JSONP
    Xwb.request.q(
        'http://bbs.rayli.com.cn/api/sinax.php',
        {
            action : 'sinalogin',
            name   : 'yourname',
            pwd    : 'youpassword'
        },
        function(e){
            if(e.isOk()){
                console.log(e.getRaw());
            }
        },
        
        // 默认 'jsonp'，可根据具体目标而设置
        {jsonp:'jscallback'}
    );
   </pre></code>
 */
    q : function(url, data, success, cfg){
        !cfg && (cfg = {});
        cfg.url = url;
        // merge data
        if(cfg.data)
            Util.extend(cfg.data, data);
        else cfg.data = data;
        cfg.success = success;
        this.direct(cfg);
    },
    
    basePath : '/',
    
<div id="method-Xwb.request-act"></div>/**
 * 发起XWB的action请求
 * @param {String} actionName
 * @param {Xwb.request.RequestConfig} config
 */
    act : function(name, data, success, cfg){
        var url = this.apiUrl('action', name);
        this.postReq(url, data, function(){
            success && success.apply(this, arguments);
            // 数据层发送 act.开头的各种action事件
            var arg = ['api.'+name];
            for(var i=0,len=arguments.length;i<len;i++)
                arg.push(arguments[i]);
            X.fire.apply(X, arg);
        }, cfg);
    },
    
// ------------------------------------
// XWB具体数据请求API
// ------------------------------------

<div id="method-Xwb.request-post"></div>/**
 * 发布微博
 * @param {String} text 微博内容
 * @param {Function} callback 成功后回调方法，参数为 callback(ResponseDefinition definition)
 * @param {String} pic
 * @param {Xwb.request.RequestConfig} [config] 可选，请求配置信息
 */
    post : function(text, fn, pic, cfg){
        var data = {text:text};
        if(pic)
            data.pic = pic;
        XwbRequest.act('update', data, fn, cfg);
    },
    
<div id="method-Xwb.request-postImgText"></div>/**
 * 分享图片微博
 * @param {String} text 微博内容
 * @param {String} picId 图片pid
 * @param {Function} callback 成功后回调方法，参数为 callback(ResponseDefinition definition)
 * @param {Xwb.request.RequestConfig} [config] 可选，请求配置信息
 */
    postImgText : function(text, picId, fn, cfg){
        XwbRequest.act('upload', {text:text, pic:picId}, fn, cfg);
    },
    
<div id="method-Xwb.request-repost"></div>/**
 * 转发微博
 * @param {String} postId  微博id
 * @param {String} text    微博内容
 * @param {String} userList   同时作为userList的评论发布，用户ID用逗号分隔
 * @param {Function} callback 成功后回调方法，参数为 callback(ResponseDefinition definition)
 * @param {Xwb.request.RequestConfig} [config] 可选，请求配置信息
 */
    repost : function(id, text, uids, fn, cfg){
        XwbRequest.act('repost', {
            id:id, 
            text:text, 
            rtids : uids
          }, fn, cfg
        );
    },
<div id="method-Xwb.request-getEmotion"></div>/**
 * 获取表情数据
 * 
 */
	getEmotion: function(fn) {
		XwbRequest.act('emotions', null,fn);
	},

<div id="method-Xwb.request-del"></div>/**
 * 删除微博
 * @param {String} postId 微博id
 * @param {Function} callback 成功后回调方法，参数为 callback(ResponseDefinition definition)
 * @param {Xwb.request.RequestConfig} [config] 可选，请求配置信息
 */
    del : function(id, fn, cfg){
        XwbRequest.act('destroy', {id:id}, fn, cfg);
    },

<div id="method-Xwb.request-comment"></div>/**
 * 评论微博
 * @param {String} postId 微博id
 * @param {String} text 微博内容
 * @param {Number} forward 是否作为一条新微博发布，1是，0否
 * @param {Number} headPictureType 评论显现头像类型, 默认是1，30大小的头像，2，50大小的头像
 * @param {Function} callback 成功后回调方法，参数为 callback(ResponseDefinition definition)
 * @param {Xwb.request.RequestConfig} [config] 可选，请求配置信息
 */
    comment : function(id, text, forward, hpt, fn, cfg){
        XwbRequest.act('comment', {
            id:id,
            text:text,
            forward : forward,
            type:hpt
           }, fn, cfg
        );
    },

<div id="method-Xwb.request-delComment"></div>/**
 * @param {String} commentId 评论微博id
 * @param {Function} callback 成功后回调方法，参数为 callback(ResponseDefinition definition)
 * @param {Xwb.request.RequestConfig} [config] 可选，请求配置信息
 */
    delComment : function(id, fn, cfg){
        XwbRequest.act('comment_destroy', {id:id}, fn, cfg);
    },
    
<div id="method-Xwb.request-reply"></div>/**
 * 回复微博评论
 * @param {String} postId 微博id
 * @param {String} commentPostId 要回复的评论ID
 * @param {String} text 微博内容
 * @param {Number} forward 是否作为一条新微博发布，1是，0否
 * @param {Number} headPictureType 评论显现头像类型, 默认是1，30大小的头像，2，50大小的头像
 * @param {Function} callback 成功后回调方法，参数为 callback(ResponseDefinition definition)
 * @param {Xwb.request.RequestConfig} [config] 可选，请求配置信息
 */
    reply : function(id, cid, text, forward, hpt, fn, cfg){
        XwbRequest.act('reply', {
            id:id,
            cid:cid,
            text:text,
            forward : forward,
            type:hpt
           }, fn, cfg
        );
    },
<div id="method-Xwb.request-follow"></div>/**
 * 关注某人，或批量关注用户
 * @param {String} user 关注用户，UID或微博名称
 * @param {Number} userDataType user参数类型，0为user id，1为微博名称
 * @param {Function} callback 成功后回调方法，参数为 callback(ResponseDefinition definition)
 * @param {Xwb.request.RequestConfig} [config] 可选，请求配置信息
 */
    follow : function(user, dt, fn, cfg){
        XwbRequest.act('createFriendship', {uid:user, type:dt}, fn, cfg);
    },

<div id="method-Xwb.request-unfollow"></div>/**
 * @param {String} user 关注用户，UID或微博名称
 * @param {Number} userDataType user参数类型，0为user id，1为微博名称
 * @param {Function} callback 成功后回调方法，参数为 callback(ResponseDefinition definition)
 * @param {Xwb.request.RequestConfig} [config] 可选，请求配置信息
 */
    unfollow : function(user, name, fn, cfg){
        XwbRequest.act('deleteFriendship', {id:user, name:name, is_follower:0}, fn, cfg);
    },
	
<div id="method-Xwb.request-removeFans"></div>/**
 * 移除粉丝
 * @param {String} user 关注用户，UID或微博名称
 * @param {Number} userDataType user参数类型，0为user id，1为微博名称
 * @param {Function} callback 成功后回调方法，参数为 callback(ResponseDefinition definition)
 * @param {Xwb.request.RequestConfig} [config] 可选，请求配置信息
 */
	removeFans : function(user, name, fn, cfg) {
		XwbRequest.act('deleteFriendship', {id:user, name:name, is_follower:1}, fn, cfg);
	},

<div id="method-Xwb.request-fav"></div>/**
 * 收藏微博
 * @param {String} blogId 要收藏的微博ID
 * @param {Function} callback 成功后回调方法，参数为 callback(ResponseDefinition definition)
 * @param {Xwb.request.RequestConfig} [config] 可选，请求配置信息
 */
    fav : function(id, fn, cfg){
        XwbRequest.act('createFavorite', {id:id}, fn, cfg);
    },
    
    delFav : function(id, fn, cfg){
        XwbRequest.act('deleteFavorite', {id:id}, fn, cfg);
    },

<div id="method-Xwb.request-updateHeadPic"></div>/**
 * 更改头像。
 * WARNING : 更改头像需要由form提交
 * @param {Function} callback 成功后回调方法，参数为 callback(ResponseDefinition definition)
 * @param {Xwb.request.RequestConfig} [config] 可选，请求配置信息
 */
    updateHeadPic : function(image, fn, cfg){
        XwbRequest.act('updateProfileImage', {image:image}, fn, cfg);
    },
    
<div id="method-Xwb.request-setProfile"></div>/**
 * 更新用户资料
 * @param {Object} data 用户资料（键值对）
 * @param {Function} callback 成功后回调方法，参数为 callback(ResponseDefinition definition)
 * @param {Xwb.request.RequestConfig} [config] 可选，请求配置信息
 */
    setProfile : function(data, fn, cfg){
        XwbRequest.act('saveProfile', data, fn, cfg);
    },

<div id="method-Xwb.request-unread"></div>/**
 * 获取未读数 包括新微博数，@我的微博数，评论数，粉丝数，私信
 * @param {String} lastReadId 最新已读微博ID
 * @param {Function} callback 成功后回调方法，参数为 callback(ResponseDefinition definition)
 * @param {Xwb.request.RequestConfig} [config] 可选，请求配置信息
 */
    unread : function(id, fn, cfg){
        XwbRequest.act('unread', {id:id}, fn, cfg);
    },
    
<div id="method-Xwb.request-clearUnread"></div>/**
 * 清零未读消息数目
 * @param {Number} messageType  1为清零评论，2为清零@me，3为清零私信，4为清零粉丝，默认清零全部
 * @param {Function} callback 成功后回调方法，参数为 callback(ResponseDefinition definition)
 * @param {Xwb.request.RequestConfig} [config] 可选，请求配置信息
 */
    clearUnread : function(type, fn, cfg){
        XwbRequest.act('clearTip', {type:type}, fn, cfg);
    },
    
<div id="method-Xwb.request-getComments"></div>/**
 * 获取指定的微博评论列表
 * @param {String} id 微博ID
 * @param {Number} page 评论的页码
 * @param {Number} type 列表类型, 默认是1，微博列表的某条微博评论列表，2单条微博的详细评论列表
 * @param {Function} callback 成功后回调方法，参数为 callback(ResponseDefinition definition)
 * @param {Xwb.request.RequestConfig} [config] 可选，请求配置信息
 */
    getComments : function(id, page, type, fn, cfg){
        XwbRequest.act('getComments', {id:id, page:page, type:type||1}, fn, cfg);
    },

<div id="method-Xwb.request-msg"></div>/**
 * 发私信
 * @param {String} targetUserId 用户帐号ID，与用户微博名称两者给出其一即可
 * @param {Number} userType 指明第一个参数的类型，用户ID时值为0, 用户微博名称时为1，默认为0
 * @param {String} targetWeiBoName 用户微博名称与帐号ID两者给出其一即可
 * @param {String} text 私信内容
 * @param {Function} callback 成功后回调方法，参数为 callback(ResponseDefinition definition)
 * @param {Xwb.request.RequestConfig} [config] 可选，请求配置信息
 */
    msg : function(uid, userType, text, fn, cfg){
        XwbRequest.act('sendDirectMessage', {id : userType?'':uid, name: userType?uid:'', text:text}, fn, cfg);
    },

<div id="method-Xwb.request-delMsg"></div>/**
 * 删除私信
 * @param {String} msgId 私信ID
 * @param {Function} callback 成功后回调方法，参数为 callback(ResponseDefinition definition)
 * @param {Xwb.request.RequestConfig} [config] 可选，请求配置信息
 */
    delMsg : function(id, fn, cfg){
        XwbRequest.act('deleteDirectMessage', {id:id}, fn, cfg);
    },
<div id="method-Xwb.request-followed"></div>/**
 * 查看某人是否是目标用户的粉丝
 * @param {String} user 目标用户
 * @param {Function} callback 成功后回调方法，参数为 callback(ResponseDefinition definition)
 * @param {Number} targetAccountType 目标帐号类型，如果参数传入的是用户ID，为0,如果参数为用户微博名称则为1
 * @param {String} src 源用户(不指定，就使用当前登录用户)
 * @param {Number} sourceAccountType 源帐号类型，如果参数传入的是用户ID，为0,如果参数为用户微博名称则为1
 * @param {Xwb.request.RequestConfig} [config] 可选，请求配置信息
 */
    followed : function(user, fn, userType, src, srcType, cfg){
        var data = {};
        if( userType )
            data.t_name = user;
        else data.t_id  = user;
        if(src){
            if(srcType)
                data.s_name = src;
            else data.s_id  = src;
        }
        XwbRequest.act('friendShip', data, fn, cfg);
    },
    
<div id="method-Xwb.request-setting"></div>/**
 *  个人设置
 * @param {String} type 设置类型，默认是’autoshow’新微博显示方式，’tipshow’未读数显示方式
 * @param {Function} callback 成功后回调方法，参数为 callback(ResponseDefinition definition)
 * @param {Xwb.request.RequestConfig} [config] 可选，请求配置信息
 */
    setting : function(type, fn, cfg){
        XwbRequest.act('setting',{type:type}, fn, cfg);
    },

<div id="method-Xwb.request-shieldBlog"></div>/**
 *  屏蔽单条微博
 * @param {String} weiboId 微博ID
 * @param {Function} callback 成功后回调方法，参数为 callback(ResponseDefinition definition)
 * @param {Xwb.request.RequestConfig} [config] 可选，请求配置信息
 */
    shieldBlog : function(wbId, fn, cfg){
        XwbRequest.postReq(XwbRequest.mkUrl('show', 'disabled'), {id:wbId}, fn, cfg);
    },
<div id="method-Xwb.request-reportSpam"></div>/**
 *  举报单条微博
 * @param {String} weiboId 微博ID
 * @param {String} content
 * @param {Function} callback 成功后回调方法，参数为 callback(ResponseDefinition definition)
 * @param {Xwb.request.RequestConfig} [config] 可选，请求配置信息
 */
    reportSpam : function(wbId, content, fn, cfg){
        XwbRequest.postReq(XwbRequest.mkUrl('show', 'reportSpam'), {cid:wbId, content:content}, fn, cfg);
    },

<div id="method-Xwb.request-createTags"></div>/**
 *  增加标签
 * @param {String} tagList 逗号分隔
 * @param {Function} callback 成功后回调方法，参数为 callback(ResponseDefinition definition)
 * @param {Xwb.request.RequestConfig} [config] 可选，请求配置信息
 */
    createTags : function(tagList, fn, cfg){
        XwbRequest.act('createTags', {tagName:tagList}, fn, cfg);
    },

<div id="method-Xwb.request-delTag"></div>/**
 * 删除标签
 */
    delTag : function(tagId, fn, cfg){
        XwbRequest.act('deleteTags', {tag_id:tagId}, fn, cfg);
    },
    
    updateShowProfile : function(data, fn, cfg){
        XwbRequest.act('saveShow', data, fn, cfg);
    },
    
    updateNoticeProfile : function(data, fn, cfg){
        XwbRequest.act('saveNotice', data, fn, cfg);
    },
    
<div id="method-Xwb.request-saveSkin"></div>/**
 * 设置皮肤
 * @param {String} skin skin文件夹
 * @param {Function} callback 成功后回调方法，参数为 callback(ResponseDefinition definition)
 * @param {Xwb.request.RequestConfig} [config] 可选，请求配置信息
 */
    saveSkin : function(skin, fn, cfg){
        // url, data, success, cfg
        XwbRequest.postReq(XwbRequest.mkUrl('setting', 'setSkin'), {skin_id:skin}, fn, cfg);
    },
    
<div id="method-Xwb.request-counts"></div>/**
 * 获取多条微博转发数，评论数等信息
 * @param {String} weiboIds 微博ID列表，由逗号分隔
 * @param {Function} callback 成功后回调方法，参数为 callback(ResponseDefinition definition)
 * @param {Xwb.request.RequestConfig} [config] 可选，请求配置信息
 */
    counts : function(ids, fn, cfg){
        XwbRequest.act('getCounts', {ids:ids}, fn, cfg);
    },

<div id="method-Xwb.request-blacklistAdd"></div>/**
 * 添加用户黑名单
 * @param {String} id 用户ID
 * @param {String} name 用户昵称 
 * 参数二选一即，如只知道昵称 (null, 'billgate');
 */
	blacklistAdd : function(id, name, fn, cfg) {
		XwbRequest.act('createBlocks', {id:id,name:name}, fn, cfg);
	},

	blacklistDel : function(id, name, fn, cfg) {
		XwbRequest.act('deleteBlocks', {id:id,name:name}, fn, cfg);
	},
	

<div id="method-Xwb.request-getProvinces"></div>/**
 * 获取省份城市列表
 * @param {Function} callback 成功后回调方法，参数为 callback(ResponseDefinition definition)
 */
	getProvinces : function(fn) {
		XwbRequest.act('getProvinces', null, fn);
	},

<div id="method-Xwb.request-feedback"></div>/**
 * 用户反馈
 * @param {Object} data 微博ID列表，由逗号分隔
 * @param {Function} callback 成功后回调方法，参数为 callback(ResponseDefinition definition)
 * @param {Xwb.request.RequestConfig} [config] 可选，请求配置信息
 */
	feedback : function(data, fn, cfg){
	    this.postReq( this.mkUrl('feedback','save'), data, fn, cfg );
	},

<div id="method-Xwb.request-sinaurl"></div>/**
 * 解析短链接
 * @param {String} shortLinkId
 * @param {Function} callback 成功后回调方法，参数为 callback(ResponseDefinition definition)
 * @param {Xwb.request.RequestConfig} [config] 可选，请求配置信息
 */
    sinaurl : function(id, fn){
        XwbRequest.act('sinaurl', {id:id}, fn);
    },
<div id="method-Xwb.request-mkUrl"></div>/**
 * 创建Xwb页面链接
 * @param {String} moduleName
 * @param {String} actionName
 * @param {String} [queryString]
 * @param {String} [entry]
 * @return {String}
 */
    mkUrl : function(module, action, queryStr, entry){
        var params = (entry||'')+'?m=' + module;
        if (action)
            params += '.' + action;

        if (queryStr){
          typeof queryStr === 'string' ?  params += '&' + queryStr : params+=Util.queryString(queryStr);
        }
        return this.basePath + params;
    },
    
<div id="method-Xwb.request-apiUrl"></div>/**
 * 发起api/weibo/请求
 * @param {String} moduleName
 * @param {String} actionName
 * @param {String} [queryString]
 */
    apiUrl : function(module, action, queryStr){
        return this.mkUrl('api/weibo/'+module, action, queryStr);
    },

<div id="method-Xwb.request-parseProtocol"></div>/**
 * 解析原始返回的数据，很少会用到本方法，除非要手动解释返回的JSON数据。
 * @param {Object} rawData
 * @return {Xwb.request.DefaultResponseDefinition}
 */
    parseProtocol : function(ret){
        return new XwbRequest.DefaultResponseDefinition( ret );
    }
};


<div id="cls-Xwb.request.ResponseDefinition"></div>/**
 * 该类定义获得返回内容数据的方式
 * @class Xwb.request.ResponseDefinition
 * @constructor
 * @param {Object} rawData row json data responsed by server
 * @param {Object} requestConfig 连接配置信息
 * @param {XMLHttpRequest|JSONP} connector 发起请求的连接器(ajax:XMLHttpRequest或JSONP:script结点)
 */
XwbRequest.DefaultResponseDefinition = function(rawData, reqCfg, connector){
    this.raw = rawData;
    this.reqCfg = reqCfg;
    if(connector)
        this.connector = connector;
};

XwbRequest.DefaultResponseDefinition.prototype = {
<div id="method-Xwb.request.ResponseDefinition-getRequestCfg"></div>/**
 * 获得该请求发起时的配置信息
 * @return {Object}
 */
    getRequestCfg : function(){
        return this.reqCfg;
    },
<div id="method-Xwb.request.ResponseDefinition-getConnector"></div>/**
 * 获得该请求所使所有连接器(ajax:XMLHttpRequest对象或JSONP:script结点)
 * @return {Object}
 */
    getConnector : function(){
        return this.connector;
    },
    
<div id="method-Xwb.request.ResponseDefinition-getRaw"></div>/**
 * 获得请求原始返回数据，根据请求数据类型的不同返回text文本或json对象
 * @return {Object} jsonData
 */
    getRaw : function(){
        return this.raw;
    },

<div id="method-Xwb.request.ResponseDefinition-getData"></div>/**
 * 获得该请求的应用数据
 * @return {Object}
 */
    getData : function(){
        return this.getRaw().rst;
    },

<div id="method-Xwb.request.ResponseDefinition-isOk"></div>/**
 * 检测服务器数据调用是否成功。
 * 该检测处于服务器成功返回之后，
 * 对客户端提交的请求数据有效性的一种反应。
 * @return {Boolean}
 */
    isOk : function(){
        return !this.getCode();
    },

<div id="method-Xwb.request.ResponseDefinition-getCode"></div>/**
 * 获得返回码
 * @return {Number}
 */
    getCode : function(){
        return this.getRaw().errno;
    },

<div id="method-Xwb.request.ResponseDefinition-getError"></div>/**
 * 获得错误的具体信息
 * @return {Object} errorInfo
 */
    getError : function(){
        return this.getRaw().err;
    },
    
<div id="method-Xwb.request.ResponseDefinition-getMsg"></div>/**
 * 从ERRORMAP获得错误码对应信息。
 * @param {String} defaultString 如果不存在，返回该字符串。
 * @return {String}
 */
    getMsg : function(def){
        if(__debug) if( !ERRORMAP[ this.getCode() ] ) console.warn('未定义错误码消息：' + this.getCode(), '@', this.getRaw());
        // '系统繁忙，请稍后重试！'
        return ERRORMAP[ this.getCode() ] || def || ('未处理异常：' + this.getCode(), '@', this.getRaw());
    },

<div id="method-Xwb.request.ResponseDefinition-each"></div>/**
 * 枚举返回的data数据，只枚举下标为数字的条项。
 * @param {Function} callback
 * @param {Object} scope
 */
    each : function(func, scope){
        var i = 0, data = this.getData();
        for( var item in data ){
            if( isNaN (item) )
                continue;
            if( scope ){
                if( func.call(scope, data[item], i) === false)
                    break;
            } else if( func(data[item], i) === false)
                 break;
            i++;
        }
    }
};


//
//  这里只限定后台返回的错误码，请不要定义其它多余的错误码。
//
var ERRORMAP = XwbRequest.ERRORMAP = {
        '0': '发布失败。',
		'5': '超过字数了！',
		'1': '图片正在上传，请稍候。',
		'2': '正在发布,请稍候。。',
		'3': '请先输入内容。',
		'4': '请写上你要说的话题。',
		'1020002': '请不要重复发布相同的内容。',
		'1010006': '不能采用sina域下的邮箱。',
		'1010007': '已经提交，请耐心等待管理员审核，谢谢！',
        '20011': '评论字数超过限制',
		'20016': '他还没有关注你,不能发私信',
		'30001': '皮肤保存失败，请重试。',
		//图片相关
		'20020':'上传图片为空',
		'20021':'上传图片大小超过限制',
		'20022':'上传图片类型不符合要求',
		'20023':'上传图片失败，重新试试看？',
		'20024':'非法的上传图片',
	    '1021200':'此昵称不存在',
	    '1020500':'此微博已被作者移除。',
	    '1020301':'此微博已被作者移除。',
	    '1020700':'此微博已被作者移除。',
	    '1020402':'此微博已被作者移除。',
	    '1020504':'此微博已被作者移除。',
	    '1020501':'此评论已被作者移除。',
	    '1020600':'此评论已被作者移除。',
		'1040003':'您尚未登录，请先登录再操作',
		'1040000':'您尚未登录，请先登录再操作',
		'1050000':'系统繁忙，请稍候再试。',
		'1040007':'发评论太多啦，休息一会儿吧。',
		'1040006':'发微博太多啦，休息一会儿吧。',
		'1040004': '请不要发表违法和不良信息。',
		'1021301': '该昵称已存在，请换一个昵称。',
		'1020104': '不要太贪心哦，发一次就够啦。',
		'1020801': '关注的用户不存在。',
		'1020800': '关注失败',
		'1020805': '已关注该用户',
		'1050000': '操作失败，重新试试看？',
		'1020404': '由于用户设置，你暂不能发表评论。',
		'1020405': '根据对方的设置，你不能进行此操作。',
		'1020806': '你使用的帐号或IP关注过于频繁，今日将无法再进行同类操作，请谅解！',
		// 上传文件由于其它原因出错
		// 这里后台最好和上面的一致
		'2010009' : '上传图片大小超过限制。',
		'2010010' : '上传图片大小超过限制。',
		'2010011' : '上传图片的数据不完整，重新试试看？',
		'2010012' : '图片上传失败，重新试试看？',
		'2010013' : '上传图片失败，重新试试看？',
		'2010014' : '上传图片失败，重新试试看？'
};

var Util = XwbRequest.util;

if ( !X )
    X = window.Xwb = {};

//
//  为方便处理，所有事件统一有X层发送
//
if(!X.fire)
    X.fire = function(){};

X.request = XwbRequest;

})(window.Xwb);
<div id="cls-jQuery"></div>/**
 * @class jQuery
 * 本类是Xwb JavaScript API对jQuery方法的扩展。
 */
(function(X, $){
	var FALSE = false,
		TRUE = true,
		NULL = null,
		toInt = parseInt,
		isIE6 = !!($.browser.msie && $.browser.version == '6.0');;
	// 图片控制组件
	var imgCtrler = function() {
	    this.cid = 'imageCtrler';
	    this.canvas = NULL;
	    this.maxWidth = 440;
	    this.width = 0;
	    this.height = 0;
	    this.curAngle = 0;
	};

	imgCtrler.prototype = {
	    // 初始化，支持canvas的创建canvas，IE使用矩阵滤镜
	    init: function(data) {
	        var _el = data.el;
	        
	        this.width = _el.offsetWidth;
	        this.height = _el.offsetHeight;
	        
	        if($.browser.msie) {
	            var _matrix = 'DXImageTransform.Microsoft.Matrix';
	            
	            _el.style.filter = 'progid:DXImageTransform.Microsoft.Matrix()';
	            _el.filters.item(_matrix).SizingMethod = "auto expand";
	            $(_el).addClass('narrow-move');
	            _matrix = NULL;
	        }else {
	            this.canvas = $('<canvas></canvas>')
	                .attr({
	                    'height': this.height,
	                    'width': this.width
	                })
					.addClass('narrow-move')
					.attr('rel', 'e:zo')
	                .insertBefore(_el)[0];
	            
	            if(this.canvas.getContext) {
	                $(_el).hide();
	                
	                var ctx = this.canvas.getContext('2d');
	                
	                //ctx.drawImage(_el,0,0);
	
	            }
	        }
	        
	        this.element = _el;
	    },
	    
	    //旋转图片
	    //旋转方式，'left'或者'right'
	    rotate: function(dir) {
	        if(!this.element) {return;}
	        
	        //相对原始图片的旋转角度
	        var _angle;
	        if(dir === 'right') {
	            _angle = this.curAngle + 90;
	            this.curAngle = _angle>=360 ? 0 : _angle;
	        }else if(dir === 'left') {
	            _angle = this.curAngle - 90;
	            this.curAngle = _angle<0 ? 360+_angle : _angle;
	        }
	        _angle = NULL;
	        
	        //调整图片旋转后的大小
	        var drawW,drawH, h=this.width,w=this.height;
	            
	        this.width = w;
	        this.height = h;
	
	        if(w > this.maxWidth) {
	            h = toInt(this.maxWidth * h/w);
	            w = this.maxWidth;
	        }
	        
	        if(this.canvas) {
	            var 
	                ctx = this.canvas.getContext('2d'), el = this.element, 
	                cpx=0, cpy=0;
	            //设置画布大小，重置了内容
	            $(this.canvas).attr({
	                'width': w,
	                'height': h
	            });
	            
	            ctx.clearRect(0,0,w,h);
	            
	            switch(this.curAngle) {
	                case 0:
	                    cpx = 0;
	                    cpy = 0;
	                    drawW = w;
	                    drawH = h;
	                    break;
	                case 90:
	                    cpx = w;
	                    cpy = 0;
	                    drawW = h;
	                    drawH = w;
	                    break;
	                case 180:
	                    cpx = w;
	                    cpy = h;
	                    drawW = w;
	                    drawH = h;
	                    break;
	                case 270:
	                    cpx = 0;
	                    cpy = h;
	                    drawW = h;
	                    drawH = w;
	                    break;
	            }
	            
	            ctx.save();
	            ctx.translate(cpx,cpy);
	            ctx.rotate(this.curAngle * Math.PI/180);
	            ctx.drawImage(el, 0, 0, drawW,drawH);
	            ctx.restore();
	            
	        }else {
	            var 
	                _rad = this.curAngle * Math.PI/180,
	                _cos = Math.cos(_rad),
	                _sin = Math.sin(_rad),
	                _el = this.element,
	                _matrix = 'DXImageTransform.Microsoft.Matrix';
	                
	            _el.filters.item(_matrix).M11 = _cos;
	            _el.filters.item(_matrix).M12 = -_sin;
	            _el.filters.item(_matrix).M21 = _sin;
	            _el.filters.item(_matrix).M22 = _cos;
	            
	            // this.width = _el.offsetWidth;
	            // this.height = _el.offsetHeight;
	            
	            switch(this.curAngle) {
	                case 0:
	                case 180:
	                    drawW = w;
	                    drawH = h;
	                    break;
	                case 90:
	                case 270:
	                    drawW = h;
	                    drawH = w;
	                    break;
	            }
	            
	            _el.width = drawW;
	            _el.height = drawH;
	            //修正IE8下图片占位的问题
	            //18是操作菜单的高度
	            if($.browser.version == 8) {
	                _el.parentNode.style.height = _el.offsetHeight+18;
	            }
	        }
	    }
	};

	$.extend($.fn, {
		   <div id="method-jQuery-zoomText"></div>/**
			* 文字放大渐隐（微博数增加效果）
			*@param {Number} num 增加数值
			*@param {Number} times 放大倍数
			*@return {jQuery}
			*/
			zoomText: function(num, times) {
				this.each(function() {
					var
						$clone,
						$el = $(this),
						offset = $el.offset(),
						text = $el.text();
						
					times = isNaN(times) ? 2 : times;
					
					if(!isNaN(+text)) {
						text = +text + (num || 1);
					}
					
					$el.text(text);
					
					$clone = $el.clone()
						.attr('id', '')
						.css({
							'position': 'absolute',
							'top': offset.top,
							'left': offset.left,
							'font': $el.css('font'),
							'color': $el.css('color')
						})
						.appendTo($(document.body));
					
					var fontsize = times * parseInt($el.css('font-size'));
					
					$clone.animate({
						'font-size': fontsize,
						'top': offset.top - ($el.height()/4),
						'left': offset.left - ($el.width()/2),
						'opacity': 0.1
					}, {
						'duration': 300,
						'complete': function() {
							$clone.remove();
						}
					});
					
				});
				
				return this;
			},

			<div id="method-jQuery-imgRotate"></div>/**
			* 图片左右旋转
			* @param {String} dir  旋转方式，'left'或者'right'
			* @return {jQuery} this
			*/
			imgRotate: function(dir) {
			   
				this.each(function() {
					if(this.tagName !== 'IMG') {return FALSE};
					var img = $(this).data('img');

					if (!img)
					{
						var img = new imgCtrler();
						img.init({el: this});
						
						img.maxWidth = $(this).parent().width();

						$(this).data('img', img);
					}
					
					img.rotate(dir);
				});
				
				return this;
			},
			<div id="method-jQuery-focusText"></div>/**
			 * 文本输入框加上聚焦清空，失焦停留提示功能。<br/>
			 如果利用{@link Xwb.ax.Validator}类作表单验证，制作类似功能时不必直接采用该方法，
			 Validator类提供一系列验证器无需写代码即可轻松实现，详见该类的各种验证器。<br/>
			 如果当前文本框已经过{@link Xwb.ax.SelectionHolder}实例处理，
			 则focusText方法会利用当前{@link Xwb.ax.SelectionHolder}实例输出文本。
			 * @param {String} hoverText 停留提示文字
			 * @param {String} [focusStyle] 修饰样式类
			 * @param {DomSelector} [cssNode]
			 * @param {Boolean} [removeOnFocus] 如果为false，当聚焦后添加css类，否则移除css类
			  <pre><code>
                $('#id').focusText('这里输入用户名', 'focusStyle');
              </code></pre>
			 */
			focusText : function(text, css, cssNode, removeOnFocus){
			    this.each(function(){
			        $(this).focus(function(){
			            if(this.value === text){
			                var selHolder = $(this).data('xwb_selholder');
			                if(selHolder)
			                    selHolder.setText('');
			                else this.value = '';
			            }
			            if(css){
			                if(removeOnFocus)
			                    $(cssNode||this).removeClass(css);
			                else $(cssNode||this).addClass(css);
			            }
			        })
			        .blur(function(){
			            if($.trim(this.value) === ''){
			                var selHolder = $(this).data('xwb_selholder');
			                if(selHolder)
			                    selHolder.setText(text);
			                else this.value = text;
			            }
			            if(css){
			                if(removeOnFocus)
			                    $(cssNode||this).addClass(css);
			                else $(cssNode||this).removeClass(css);
			            }
			        });
			    });
			},
			
			<div id="method-jQuery-cssDisplay"></div>/**
			 * 方法使用'hidden'样式控制元素的显示或隐藏状态。
			 * 如果无参数，返回当前元素hidden样式的状态，否则利用'hidden'CSS类进行隐藏或显示元素。
			  <pre><code>
			    // 获得显示状态
			    if ($('#id').cssDisplay()) {}
			    // 显示
			    $('#id').cssDisplay(true);
             </code></pre>
             *@return {Boolean|jQuery}
			 */
			cssDisplay : function(b){
			    var len = this.length, jq;
			    if(len){
			        if(len === 1){
			            if(b === undefined){
			                var v = !this.hasClass('hidden');
			                return v;
			            }else {
			                if(b) this.removeClass('hidden');
			                else this.addClass('hidden');
			            }
			        }
			        
			        else {
			            this.each(function(){
    			            if(b) $(this).removeClass('hidden');
			                else $(this).addClass('hidden');
			            });
			        }
			    }
			    return this;
			},
			
            <div id="method-jQuery-checkClass"></div>/**
             * 检查是否含有某个样式,如果有,添加或删除该样式.
             * @param {String} css 样式名称
             * @param {Boolean} addOrRemove true 时添加样式，false时移除该样式
             * @return {jQuery} this
             */
			checkClass : function(cs, b){
			    if(cs){
    			    this.each(function(){
    			        var jq = $(this);
            			var hc = jq.hasClass(cs);
            			if(b){
            				if(!hc)
            				jq.addClass(cs);
            			}else if(hc){
            				jq.removeClass(cs);
            			}			        
    			    });
			    }
        		return this;
			},
			
            <div id="method-jQuery-switchClass"></div>/**
            * 替换view元素样式类.<br/>
            * <code>comp.switchClass('mouseoverCss', 'mouseoutCss');</code><br/>
            * @param {String} oldSty 已存在的CSS类名
            * @param {String} newSty 新的CSS类名
            * @return {Object} this
            */
              switchClass: function(oldSty, newSty) {
                    this.each(function(){
                        var jq = $(this);
                        jq.removeClass(oldSty);
                        jq.addClass(newSty);
                    });
                    return this;
              },
              
              <div id="method-jQuery-absolutePos"></div>/**
               * 获得相对于viewport的位置，只适用于单个元素
               * @return {left, top}
               */
              absolutePos : function(){
                    var off = this.offset(), doc = $(document);
                    var st  = doc.scrollTop(), sl = doc.scrollLeft();
                    off.left -= sl;
                    off.top -= st;
                    return off;
              },
              
              slideMenu : function(slideLayer){
                this.each(function(){
                    (function(jq){
                        var layer = jq.find(slideLayer);
                        var setTimer, clsTimer;
                        function slidedown(){
                            layer.show().cssDisplay(true);
                        }
                        
                        function slideup(){
                            layer.slideUp('fast', function(){
                                layer.cssDisplay(false);
                            });
                        }
                        
                        function clear() { 
                            if(setTimer){
                                clearTimeout(setTimer);
                                setTimer = false;
                            }
                            clsTimer = setTimeout(slideup, 250);
                        }
                        
                        function set(){
                            if(clsTimer){
                                clearTimeout(clsTimer);
                                clsTimer = false;
                            }
                            setTimer = setTimeout(slidedown, 150);
                        }
                        
                        jq.hover(set, clear);
                    })($(this));
                });
              },

		<div id="method-jQuery-substrText"></div>/**
	    * 截取微博内容
	    *@param {Number} num  位置，默认10
        *@param {Boolean} hasFace  是否显示表情图片，否为文字代替
        *@param {String} postfix  后缀
        *@return jQuery
	    */
        substrText: function(num, hasFace, postfix) {
            var re = new RegExp('(?:<a.*?>.*?<\\/a>)|(?:<img.*?>)|.','gi');
            
	        this.each(function() {
                var 
                    cache = [],
                    postfix = postfix || '...',
                    text = this.innerHTML,
                    match = text.match(re);
                    
                num = num||10;
                    
                if(match && match.length > num) {
                    
                    match = match.slice(0, num).join('');

                    text = hasFace ? match : match.replace(/<img.*?title=\"(.*?)\".*?>/gi, '[$1]');
                    
                    $(this).html(text+postfix);
                }
	        });
            
            return this;
        },

		<div id="method-jQuery-fixPng"></div>/**
	    * IE6修复PNG图片
	    *@return jQuery
	    */
        fixPng: function() {			

            if(isIE6) {
                this.each(function() {
                    if(this.tagName == 'IMG') {
                        var $img = $('<span></span>').css({
                            width: this.offsetWidth,
                            height: this.offsetHeight,
                            display: 'inline-block'
                        });
                        $img[0].style.filter = 'progid:DXImageTransform.Microsoft.AlphaImageLoader(src="'+this.src+'", sizingMethod="scale")';                        
                        $(this).replaceWith($img);
                    }
                });
            }
            
            return this;
        }
      

	});
	
<div id="method-jQuery-highlight"></div>/**
 * jQuery 高亮查找插件，完全基于文本结点的DOM操作，对原有非文本结点不造成任何影响。
 * @param {Array} keywords 高亮文本数组
 * @param {String} [style] 应用于高亮文本的样式类
 * 用法:
 <pre><code>
   高亮:
   $('#ss').highlight(['keyword', ... ]);
   清除:
   $('#ss').clearHighlight();
   
   或者传递自定义的样式类
   $('#ss').highlight(['keyword', ... ], 'cssClass');
   清除:
   $('#ss').clearhighlight('cssClass');   
 </code></pre>
 请确保每次高亮前清除先前已高亮内容。
 可选配置信息：$.fn.highlight.cls
 * @method highlight
*/
 
(function(){

// private
var IGNORE,S,ESC,LT,GT, inited;

// private
function init(){
    IGNORE = /INPUT|IMG|SCRIPT|STYLE|HEAD|MAP|AREA|TEXTAREA|SELECT|META|OBJECT|IFRAME/i;
    S      = /^\s+$/;
    ESC    = /(\.|\\|\/|\*|\?|\+|\[|\(|\)|\]|\{|\}|\^|\$|\|)/g;
    LT     = /</g;
    GT     = />/g;
    inited = TRUE;
}

// entry
function entry(keys, cls){
    if(!inited)
      init();
  
    if(typeof keys === 'string')
      keys = $.trim(keys).split(S);

    // normalize
    var arr = [];
    for(var i=0,len=keys.length;i<len;i++){
       if(keys[i] && !S.test(keys[i])) {
          arr[arr.length] = keys[i].replace(LT, '&lt;')
                                   .replace(GT, '&gt;')
                                   .replace(ESC, '\\$1');
       }
    }
    var reg     = new RegExp('(' + arr.join('|') + ')', 'gi'),
        placing = '<span class="'+(cls||entry.cls)+'">$1</span>',
        div     = document.createElement('DIV');
    this.each(function(){
      highlightEl(this, reg, placing, div);
    });

	return this;
}

// public
$.fn.highlight = entry;
<div id="method-jQuery-clearHighlight"></div>/**
 * 清除高亮
 * @see {@link #highlight}
 * @method clearHighlight
 */
$.fn.clearHighlight = function(cls) {
  if(!inited)
    init();
  var cls = cls||entry.cls;
  this.each(function(){
    clearElhighlight(this, cls);
  });
};


// private
function replaceTextNode(textNode, reg, placing, div) {
  var data = textNode.data;
  if(!S.test(data)){
     data = data.replace(LT, '&lt;').replace(GT, '&gt;');
     if(reg.test(data)){
        if(!div)
          div = document.createElement('DIV');
        // html escape
        div.innerHTML = data.replace(reg, placing);
        // copy nodes
        var chs = div.childNodes,
            arr = [],
            fr = document.createDocumentFragment();
        
        // copy to array
        for(var i=0,len=chs.length;i<len;i++)
          arr[i] = chs[i];
        
        for(i=0;i<len;i++)
          fr.appendChild(arr[i]);
        
        textNode.parentNode.replaceChild(fr, textNode);
     }
  }
}

// private
function highlightEl(el, reg, placing, div){
    var chs = el.childNodes, 
        arr = [], i, len, nd;
      
      // copy to array
      for(i=0,len=chs.length;i<len;i++){
        if(!IGNORE.test( chs[i].tagName ))
          arr.push(chs[i]);
      }
      
      for(i=0,len=arr.length;i<len;i++){
        nd = arr[i];
        // textnode
        if(nd.nodeType === 3){
          try { 
            replaceTextNode(nd, reg, placing, div);
          }catch(e){}
        }else arguments.callee(nd, reg, placing, div);
      }
}


// private
function clearElhighlight(el, cls) {
  var chs = el.childNodes, 
      arr = [], i, len, nd, t;
      
  // copy to array
  for(i=0,len=chs.length;i<len;i++){
    if(!IGNORE.test( chs[i].tagName ))
    arr.push(chs[i]);
  }

  for(i=0,len=arr.length;i<len;i++){
    nd = arr[i];
    t = nd.nodeType;
    // textnode
    if(t === 3)
      continue;
    // span
    if(t === 1 && nd.tagName === 'SPAN' && nd.className === cls){
      // merge text nodes
      var textNode = nd.childNodes[0], 
          p        = nd.parentNode,
          pre      = nd.previousSibling,
          nxt      = nd.nextSibling;
      
      if(pre && pre.nodeType === 3){
        p.removeChild(pre);
        textNode.data = pre.data + textNode.data;
      }
      
      if(nxt && nxt.nodeType === 3){
        p.removeChild(nxt);
        textNode.data = textNode.data + nxt.data;
      }

      p.replaceChild(textNode, nd);
    }else arguments.callee(nd, cls);
  }
}

entry.cls = 'search-txt';

})();

<div id="method-jQuery-cookie"></div>/**
 * 获得或设置cookie
 * @param {String} name
 * @param {String} value
 * @param {Object} options
 * @method
 */
$.cookie = function(name, value, options) {
    if (typeof value != 'undefined') { // name and value given, set cookie
        options = options || {};
        if (value === NULL) {
            value = '';
            options.expires = -1;
        }
        var expires = '';
        if (options.expires && (typeof options.expires == 'number' || options.expires.toUTCString)) {
            var date;
            if (typeof options.expires == 'number') {
                date = new Date();
                date.setTime(date.getTime() + (options.expires * 24 * 60 * 60 * 1000));
            } else {
                date = options.expires;
            }
            expires = '; expires=' + date.toUTCString(); // use expires attribute, max-age is not supported by IE
        }
        // CAUTION: Needed to parenthesize options.path and options.domain
        // in the following expressions, otherwise they evaluate to undefined
        // in the packed version for some reason...
        var path = options.path ? '; path=' + (options.path) : '';
        var domain = options.domain ? '; domain=' + (options.domain) : '';
        var secure = options.secure ? '; secure' : '';
        document.cookie = [name, '=', encodeURIComponent(value), expires, path, domain, secure].join('');
    } else { // only name given, get cookie
        var cookieValue = NULL;
        if (document.cookie && document.cookie != '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) == (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
};

})(Xwb, jQuery);
﻿// htmls可任意改，但ID模板名称和rel属性不能更改
Xwb.Tpl = {
    Box : [
        '<div class="win-pop {.cs}">',
            '<div class="win-t"><div></div></div>',
            '<div class="win-con">',
                '<div class="win-con-in">',
                    '[?.title?{BoxTitlebar}?]',
                    '<div class="win-box" id="xwb_dlg_ct">',
                        '{.contentHtml}',
                    '</div>',
                '</div>',
                '<div class="win-con-bg"></div>',
            '</div>',
            '<div class="win-b"><div></div></div>',
			'[?.closeable?<a href="#" class="icon-close-btn icon-bg" id="xwb_cls" title="关闭"></a>?]',
            '{.boxOutterHtml}',
        '</div>'
     ].join(''),
     
     DialogContent : '{.dlgContentHtml}<div class="btn-area" id="xwb_dlg_btns">{.buttonHtml}</div>',
          
     BoxTitlebar : '<h4 class="win-tit x-bg"><span id="xwb_title">{.title}</span></h4>',
     
     Mask : '<div class="shade-div"></div>',
     
     ForwardDlgContentHtml : [
            '<p id="xwb_forward_text"></p>',
            '<div class="forward-tool"><span id="xwb_warn_tip">还可以输入140字</span><a href="#" class="icon-face-choose all-bg" id="xwb_face_trig"></a></div>',
            '<textarea id="xwb_fw_input"></textarea>',
            '<div id="xwb_fw_lbl"></div>'
     ].join(''),
     
     ForwardDlgLabel : '<label><input type="checkbox" value="{.uid}">同时作为{.nick}的评论发布</label>',
     
     MsgDlgContent : '<div class="tips-c"><div class="icon-alert all-bg" id="xwb_msgdlg_icon"></div><p id="xwb_msgdlg_ct"></p></div>',
     
     Button : '<a href="#" class="general-btn {.cs}" id="xwb_btn_{.id}"><span>{.title}</span></a>',

	EmotionHotList: '<div class="hot-e-list" id="hotEm">{.hotList}</div>',
     
     EmotionBoxContent : [
        '<div class="win-tab bottom-line" id="cate">',
		 '	{.category} ',
        '</div>',
        '<div class="emotion-box" id="box">',
			'{EmotionHotList}',
            '<div class="e-list" id="flist0">',
				'{.faces}',
            '</div>',
        '</div>'
     ].join(''),
     ArrowBoxBottom  : '<div class="arrow all-bg"></div>',
     EmotionIcon       : '<a href="javascript:;" title="{.title}" rel="e:em"><img src="{.src}"></a>',
     Loading : '<div id="xweibo_loading" class="loading"></div>',
     CommentArea : [
        '<div class="feed-comment box-style hidden">',
          '<div class="box-t skin-bg"><span class="skin-bg"></span></div>',
          '<div class="box-content">{.cmtBoxHtml}<ul id="cmtCt" class="hidden"></ul><div class="more-comment" id="more">后面还有<span id="lefCnt"></span>条评论，<a href="{.cmtUrl}">点击查看</a></div>',
          '</div>',
          '<div class="box-b skin-bg"><span class="skin-bg"></span></div>',
          '<span class="box-arrow skin-bg"></span>',
        '</div>'
    ].join(''),
    
    CmtBox : [
              '<div class="post-comment" id="cmtBox">',
                  '<div class="post-comment-main">',
                      '<a href="javascript:;" class="icon-face-choose all-bg" rel="e:ic"></a>',
                      '<a class="general-btn" href="javascript:;" rel="e:sd"><span>评论</span></a>',
                      '<div class="comment-keyin"><div><textarea class="comment-textarea" id="inputor"></textarea></div></div>',
                  '</div>',
                  '<div>',
                      '<span class="keyin-tips" id="warn">还可以输入140个字</span>',
                      '<label><input type="checkbox" id="sync"/>同时发一条微博</label>',
                  '</div>',
              '</div>'
   ].join(''),
    
    MBCmtBox : [
    '<div class="feed-comment box-style" id="cmtBox">',
        '<div class="box-t skin-bg"><span class="skin-bg"></span></div>',
        '<div class="box-content">',
            '<div class="post-comment">',
                '<div class="post-comment-main">',
                    '<a class="icon-face-choose all-bg" href="#" rel="e:ic"></a>',
                    '<a href="javascript:;" class="general-btn" rel="e:sd"><span>评论</span></a>',
                    '<div class="comment-keyin"><div><textarea id="inputor" class="comment-textarea"></textarea></div></div>',
                '</div>',
                '<div>',
                	'<!--当超过140个字时，class="keyin-tips over-limit"-->',
                	'<span class="keyin-tips" id="warn">还可以输入140个字</span>',
                    '<label><input type="checkbox" id="sync">同时发一条微博</label>',
                '</div>',
            '</div>',
                '</div>',
        '<div class="box-b skin-bg"><span class="skin-bg"></span></div>',
        '<span class="box-arrow skin-bg"></span>',
    '</div>'
    ].join(''),

    Comment : [
        '<li rel="c:{.id},n:{.nick}">',
            '<div class="user-pic">',
                '<a href="{.usrUrl}"><img src="{.profileImg}" title="{.nick}" alt="{.nick}的头像" width="{.picSz}" height="{.picSz}" /></a>',
            '</div>',
            '<div class="comment-content">',
                '<p><a href="{.usrUrl}">{.nick}{.verifiedHtml}</a>：{.text}<span>({.time})</span></p>',
                '<div>[?.canDel?<a href="javascript:;" rel="e:dl">删除</a>|?]<a href="javascript:;" rel="e:rp">回复</a></div>',
            '</div>',
        '</li>'
    ].join(''),
    
    MBlogCmt : [
        '<li rel="c:{.id},n:{.nick}">',
            '<div class="user-pic">',
                '<a href="{.usrUrl}"><img alt="" src="{.profileImg}" /></a>',
            '</div>',
            '<div class="comment-c">',
                '<p class="c-info"><a href="{.usrUrl}">{.nick}{.verifiedHtml}</a> {.text}({.time}) </p>',
                '<div class="c-for" id="trigs">',
                    '<a href="javascript:;" class="icon-reply icon-bg" rel="e:rp">回复</a>',
                '</div>',
                '{.cmtBoxHtml}',
                '[?.canDel?<a href="javascript:;" class="icon-del icon-bg" rel="e:dl">删除</a>?]',
            '</div>',
        '</li>'
    ].join(''),
    
    Followed : '<span class="followed-icon {.cs}">已关注</span>',

    MediaBoxContentHtml : [
			'<div class="insert-box">',
				'<p>请输入<a href="http://video.sina.com.cn" target="_blank">新浪播客</a>、<a href="http://www.youku.com" target="_blank">优酷网</a>、<a href="http://www.tudou.com" target="_blank">土豆网</a>、<a href="http://www.ku6.com/" target="_blank">酷6网</a>等视频网站的视频播放页链接</p>',
				'<input type="text" id="xwb_inputor"><a href="#" class="general-btn" rel="e:ok"><span>确定</span></a>',
				'<p class="error-tips hidden" id="xwb_err_tip">你输入的链接地址无法识别<span><a href="#" rel="e:cc">取消操作</a>或者<a href="#" rel="e:nm">作为普通的链接</a>发布。</span></p>',
			'</div>'
    ].join(''),

	PictureBox: [
		'<div class="box-style" style="display:none">',
		'	<div class="box-t skin-bg"><span class="skin-bg"></span></div>',
		'	<div class="box-content">',
		'   <div class="show-img"><p><a href="#" rel="e:zo" class="icon-piup icon-bg">收起</a>',
		'   <a href="{.org}" target="_blank" class="icon-src icon-bg">查看原图</a>',
		'   <a href="#" class="icon-trunleft icon-bg" rel="e:tl">向左转</a>',
		'   <a href="#" class="icon-trunright icon-bg" rel="e:tr">向右转</a></p>',
		'   <div name="img"></div></div>',
		'   </div>',
		'	<div class="box-b skin-bg"><span class="skin-bg"></span></div>',
		'	<span class="box-arrow skin-bg"></span>',
		'</div>'
	].join(''),
	
	//转发中的图片显示
	PictureBoxForward: [
		'<div class="show-img cutline" style="display:none">',
		'<p><a class="icon-piup icon-bg" rel="e:zo" href="#">收起</a><a class="icon-src icon-bg" target="_blank" href="{.org}">查看原图</a><a rel="e:tl" class="icon-trunleft icon-bg" href="#">向左转</a><a rel="e:tr" class="icon-trunright icon-bg" href="#">向右转</a></p>',
		'<div name="img"></div></div>'
	].join(''),

	PreviewBox: [
		'<div class="preview-img"></div>'
	].join(''),
	
	VideoThumbHtml: [
		'<div class="feed-img"><img width="120px" src="{.img}" alt="">',
		'<div class="video-view all-bg" rel="e:pv,i:{.id}"></div></div>'
	].join(''),
	
	VideoBox: [
		'<div class="box-style showbox" style="display:none">',
		'	<div class="box-t skin-bg"><span class="skin-bg"></span></div>',
		'	<div class="show-video box-content">',
		'   <p><a rel="e:cv" href="#" class="icon-piup icon-bg">收起</a><span>|</span><a title="{.title}" target="_blank" href="{.href}">{.title}</a></p>',
		'   <div>{.flash}</div></div>',
		'	<div class="box-b skin-bg"><span class="skin-bg"></span></div>',
		'	<span class="box-arrow skin-bg"></span>',
		'</div>'
	].join(''),

	VideoBoxForward: [
		'<div class="cutline show-video">',
		'<p><a rel="e:cv" href="#" class="icon-piup icon-bg">收起</a><span>|</span><a title="{.title}" target="_blank" href="{.href}">{.title}</a></p>',
		'<div>{.flash}</div></div>'
	].join(''),
    
    MusicBoxContentHtml : [
        '<div class="insert-box music-box">',
            '<p>请输入<a href="http://music.sina.com.cn/yueku/" target="_blank">新浪乐库</a>等音乐站点的音乐播放页链接</p>',
            '<input type="text" id="xwb_inputor"><a href="#" class="general-btn" rel="e:ok"><span>确定</span></a>',
            '<p class="error-tips hidden" id="xwb_err_tip">你输入的链接地址无法识别<span><a href="#" rel="e:cc">取消操作</a>或者<a href="#" rel="e:nm">作为普通的链接</a>发布。</span></p>',
        '</div>'
    ].join(''),
    
    UploadImgBtn : '<a href="#" rel="e:dlp" class="icon-close-btn icon-bg" title="删除"></a>',
    
    SearchDropdownList : '<ul class="head-searchlist"><li class="mouseover">含<span></span>的微博</li><li>名<span></span>的人</li></ul>',
    
    PrivateMsgContent : [
        '<div class="field"><label>发私信给:</label><input type="text" id="sender" /><em class="warn warn-pos hidden" id="warnPos">她还没有关注你,暂时不能发私信</em></div>',
        '<div class="field"><label>私信内容:</label><textarea id="content"></textarea></div>',
        '<input type="hidden" id="uid" value="">',
        '<div class="field pad">',
            '<div class="icon-face-choose all-bg fl" rel="e:ic"></div>',
            '<div class="fr">',
                '<span class="tips fl" id="word">您还可以输入140个字</span>',
                '<a class="general-btn highlight fl" href="javascript:;" rel="e:sd"><span>发送</span></a>',
            '</div>',
        '</div>'
    ].join(''),
    
    NoticeLayer : [
        '<div class="new-tips-fixed hidden">',
            '<h4 id="xwb_title">提示</h4>',
                '<p id="wbs" class="hidden"><span id="c">0</span>条新微博，<a href="{.wbsUrl}">点击查看</a></p>',
                '<p id="fans" class="hidden"><span id="c">0</span>个新粉丝，<a href="{.fansUrl}">点击查看</a></p>',
                '<p id="cmts" class="hidden"><span id="c">0</span>条新评论，<a href="{.cmtsUrl}">点击查看</a></p>',
                '<p id="msgs" class="hidden"><span id="c">0</span>封新私信，<a href="{.msgsUrl}">点击查看</a></p>',
                '<p id="refer" class="hidden"><span id="c">0</span>条微博提到了你，<a href="{.referUrl}">点击查看</a></p>',
            '<a href="#" class="icon-close-btn icon-bg" id="xwb_cls" ></a>',
        '</div>'
    ].join(''),
    
    NoticeLayer2 : [
        '<div class="new-tips">',
            '<a id="wbs" class="hidden" href="{.wbsUrl}"><span id="c">0</span>条新微博</a>',
            '<a id="fans" class="hidden" href="{.fansUrl}"><span id="c">0</span>个新粉丝</a>',
            '<a id="cmts" class="hidden" href="{.cmtsUrl}"><span id="c">0</span>条新评论</a>',
            '<a id="msgs" class="hidden" href="{.msgsUrl}"><span id="c">0</span>封新私信</a>',
            '<a id="refer" class="hidden" href="{.referUrl}"><span id="c">0</span>条微博提到了你</a>',
            '<a href="javascript:;" class="icon-close-btn icon-bg" id="xwb_cls"></a>',
        '</div>'
    ].join(''),
    
	//登录
	Login: [
		'<div class="login-area">',
		'	<span><a href="{.regUrl}">注册帐号</a></span><a class="btn-web-account bind-btn-bg" href="{.siteLoginUrl}">{.siteName}登录</a>',
		'	<span><a href="{.sinaRegUrl}" target="_blank">开通微博</a></span><a class="btn-sina-account bind-btn-bg" href="#" id="oauth">新浪微博帐号登录</a>',
		'</div>',
		'<div class="bind-tips">提示：您可以使用{.siteName}帐号或新浪微博帐号登录本网站</div>'
	].join(''),
	
    PostBoxContent : [
        '<div class="post-box">',
            '<div class="post-title">有什么新鲜事告诉大家？</div>',
            '<div class="key-tips" id="xwb_word_cal">您还可以输入<span>140</span>字</div>',
            '<div class="post-textarea" id="focusEl"><div class="inner"><textarea id="xwb_inputor"></textarea></div></div>',
            '<div class="add-area">',
                '<a class="icon-face icon-bg" href="#" rel="e:ic">表情</a>',
                '<span class="pic_uploading hidden" id="xwb_upload_tip">正在上传..</span>',
                '<span class="hidden" id="xwb_photo_name"><a class="icon-close-btn icon-bg" href="#" ></a></span>',
                '<a class="icon-pic icon-bg" href="#" id="xwb_btn_img">图片</a>',
                '<a class="icon-video icon-bg" href="#" id="xwb_btn_vd" rel="e:vd">视频</a>',
                '<a class="icon-music icon-bg" href="#" id="xwb_btn_ms" rel="e:ms">音乐</a>',
                '<a class="icon-topic icon-bg" href="#" id="xwb_btn_tp" rel="e:tp">话题</a>',
            '</div>',
            '<div class="share-btn" rel="e:sd"></div>',
			'<div class="share-upload-pic">',
				'<form class="upload-pic"  method="post"  enctype="multipart/form-data" id="xwb_post_form" action="" target="">',
					'<input type="file" name="pic" id="xwb_img_file" value="" />',
				'</form>',
			'</div>',
            '<div class="post-success all-bg hidden" id="xwb_succ_mask"></div>',
        '</div>'
    ].join(''),
    
    AnchorTipContent : '<div class="tips-c"><div class="icon-correct icon-bg"></div><p id="xwb_title"></p></div>',
    AnchorDlgContent : '<div class="tips-c"><div class="icon-warn icon-bg"></div><p id="xwb_title"></p></div>',
    
    SpanBoxContent : [
        '<div class="win-box-inner">',
            '<p class="desc">不良信息是指含有色情、暴力、广告或其他骚扰你正常微博生活的内容。</p>',
            '<p>你要举报的是“{.nick}”发的微博：</p>',
            '<div class="report-box">',
                '<div>{.text}</div>',
                '<img src="{.img}" class="user" width="30px" height="30px" >',
            '</div>',
            '<p>你可以填写更多举报说明：（选填）</p>',
            '<p><textarea rows="" cols="" id="content"></textarea></p>',
            '<div class="foot-con">',
                '<p>请放心，你的隐私将会得到保护。<br>举报电话：400 690 0000</p>',
                '<div class="btn-area">',
                    '<a href="#" class="general-btn highlight" rel="e:ok"><span>确认举报</span></a>',
                    '<a href="#" class="general-btn" rel="e:cancel"><span>取消</span></a>',
                '</div>',
            '</div>',
        '</div>'
    ].join('')
};




/*!
 * X weibo JavaScript Library v1.1
 * http://x.weibo.com/
 * 
 * Copyright 2010 SINA Inc.
 * Date: 2010/10/28 21:22:06
 */


(function(X, $){

var 
    undefined,

	FALSE = false,

	TRUE = true,

	NULL = null,
    
    doc  = document,

    T    = X.Tpl,
    
    // 微博字数最大值
    MAX_WBTXT_LEN = 140,
    
    Req  = X.request,
    
    CFG = X.cfg,

    // 复用Xwb.request.util类
	Util = X.util = Req.util,
	
	// 通用的disabled样式
    disabledCS = 'general-btn-disabled';

if(!T)
    T = X.Tpl = {};

//debug开关
window.__debug = !!window.__debug;
Util.extendIf = function(des, src) {
    if(!des)
      des = {};

    if(src)
      for(var i in src){
        if(des[i] === undefined)
          des[i] = src[i];
      }

    return des;
};

if(window.__debug){

<div id="cls-console"></div>/**
 * @class console
 * 系统控制台,如果存在firebug,利用firebug输出调试信息,否则忽略.
 * 在firbug中可直接进行对某个对象进行监视,
 * 无console时就为空调用,可重写自定输出.
 * @singleton
 */
if(!window.console)
      window.console = {};

Util.extendIf(console,{
      <div id="method-console-debug"></div>/**
       * %o表示参数为一个对象
       * console.log('This an string "%s",this is an object , link %o','a string', CC);
       *@param {arguments} 类似C语言中printf语法
       *@method
       */
    debug : $.noop,

<div id="method-console-trace"></div>/**
 * @method trace
 */
    trace : $.noop,
<div id="method-console-log"></div>/**
 * @method log
 */
    log : $.noop,
<div id="method-console-warn"></div>/**
 * @method warn
 */
    warn : $.noop,
<div id="method-console-error"></div>/**
 * @method error
 */
    error : $.noop,

<div id="method-console-group"></div>/**
 * @method group
 */
    group:$.noop,
<div id="method-console-groupEnd"></div>/**
 * @method groupEnd
 */
    groupEnd:$.noop
});

}


if ( $.browser.msie && $.trim($.browser.version) == "6.0" )
    doc.execCommand("BackgroundImageCache", false, true);

<div id="cls-Xwb"></div>/**
 * @class Xwb
 * 本类是所有Xweibo JavaScript交互应用的命名空间根目录。
 */


<div id="cls-Xwb.util.Tpl"></div>/**
 * @class Xwb.util.Tpl
 * <p>HTML模板类，用于解析字符串HTML并生成对应的DOM元素。</p>
 * <p>HTML模板字符解析依赖两个数据：
    <ul><li>未解析的htmls字符串</li>
    <li>map(key,value)对象数据</li>
    </ul>
    htmls字符串是原始的数据，通过{@link #parse}方法解析。
   </p>
   <pre>
    模板文法描述：
    
    入口：
    parse(entry, dataMap)
    参数：
    dataMap: {  key : value, …}
    key : JavaScript标识符
    value:entry
    entry: html 文本，.keyFromDataMap，keyFromTemplates
    html文本: &lt;tag attribute="{.keyFromDataMap}"&gt;{keyFromTemplates}&lt;/tag&gt;, IfTest, ...
    IfTest : [?keyFromDataMap?html文本?],取反：[?!keyFromDataMap?html文本?]
    Templates : {key : html文本}
    
    例子：
    var map = { name:’Xweibo’ };
    var templates = {
         Header : ‘&lt;h2&gt;{.name}&lt;/h2&gt;’,
         Box:’{Header}&lt;div&gt;名称是{.name}&lt;/div&gt;’
    };
    alert( parse(‘Box’, map) );
    结果是：&lt;h2&gt;Xweibo&lt;/h2&gt;&lt;div&gt;名称是Xweibo&lt;/div&gt;
    </pre>
  */

// 兼容处理，现已将X.Tpl移到X.util.Tpl
Util.Tpl = T;

var tplRegIf = /\[\?(!?)\.([\w_$]+?)\?([\S\s]*?)\?\]/g,
    tplReg   = /\{(\.?[\w_$]+)\}/g;

<div id="method-Xwb.util.Tpl-parse"></div>/**
 * 键查找过程：模板 --> 对象 --> 模板
 <pre><code>
    var map = { name:’Xweibo’ };
    var templates = {
         Header : ‘&lt;h2&gt;{.name}&lt;/h2&gt;’,
         Box:’{Header}&lt;div&gt;名称是{.name}&lt;/div&gt;’
    };
    alert( parse(‘Box’, map) );
    结果是：&lt;h2&gt;Xweibo&lt;/h2&gt;&lt;div&gt;名称是Xweibo&lt;/div&gt;
 </code></pre>
 * @param {String} htmls 模板字符串
 * @param {Object} map 值键对
 */
T.parse = function(htmls, map){
    if(!map)
        map = {};
    if(htmls.charAt(0) !== '<'){
        var tmp = T[htmls];
        if(tmp) 
            htmls = tmp;
    }
    
    // [?test?<img src="{src}">],当test置值时应用内容部份
    // example : [?right?output value {right}?]the left
    htmls = htmls.replace(tplRegIf, function(s, s0, s1, s2){
        if(s0 === '!')
            return !map[s1] ? s2:'';

        return map[s1] === undefined ? '' : s2;
    });
    
    return htmls.replace(tplReg, function(s, k){
        var v = k.charAt(0) === '.' ? map[k.substr(1)] : T[k];
        if(v === undefined || v === NULL)
            return '';
            
        // html text
        if(v.toString().charAt(0) === '<')
            return T.parse(v, map);
        
        // key of Tpl?
        if(T[v])
            return T.parse(T[v], map);
            
        return v;
    });
};


   <div id="method-Xwb.util.Tpl-forNode"></div>/**
    * 根据html模板创建HTML元素
    <pre>
        <code>
            var iframeElement = forNode(
              '&lt;{tag} class="{cls}" frameBorder="no" scrolling="auto" hideFocus=""&gt;&lt;/iframe&gt;',
              {tag:'iframe', cls:'ui-frame'}
            );
        </code>
    </pre>
    * @param {String} htmls
    * @param {Object|Array} map
    * @return {HTMLElement}
    */
    T.forNode = function(htmls, map){
        if(map)
            htmls = this.parse(htmls, map);
        return $(htmls).get(0);
    };
<div id="method-Xwb.util.Tpl-get"></div>/**
 *  根据模板名称获得模板字符串。
 * @param {String} templateName
 * @return {String}
 */
    T.get = function(type){
        return this[type];
    };
    
/**
 * @class Xwb.util
 * 实用函数集
 */

var _uid = 0, ds = doc.selection;

$.extend(Util, {
    <div id="method-Xwb.util-arrayRemove"></div>/**
     * 移除数组下标元素
     * <pre><code>
     var arr = ['a',2,'string'];
     Xwb.util.arrayRemove(arr, 2);
 </code></pre>
     * @param {Array} array
     * @param {Number} index
     */
    arrayRemove : function(arr, idx){
        arr.splice(idx, 1)[0];
    },
<div id="method-Xwb.util-arrayIndexOf"></div>/**
 *  获得元素在数组中的下标，无则返回-1，通过===比较两个元素是否相等。
 * @param {Array} array
 * @param {Object} object
 * @return {Number} index, 或 -1
 */
    arrayIndexOf : function(arr, obj){
        for(var i=0,len=arr.length;i<len;i++)
            if(arr[i] === obj)
                return i;
        return -1;
    },
<div id="method-Xwb.util-create"></div>/**
 *  利用JavaScript中原型特性创建面向对象中的“类”。
 *  所有利用该方法创建的类都要实现或者说存在{@link #init}初始方法。
  <pre><code>
  function Base(){
  }
  
  Base.prototype = {
    init : function(){
        alert('init');
    },
    say : function(){
        alert('Base');
    },
    
    eat : function(){
        alert('eat');
    }
  };
  
  var A = Xwb.util.create(Base, {
        say : function(){
            Base.prototype.say.apply(this, arguments);
            alert('A');
        }
  });
  
  var a = new A();
  a.eat();
  a.say();
 </code></pre>
 * @param {String} [namespace] 名称，包含命名空间，可选
 * @param {Function} superclass 父类，无父类可置空
 * @param {Object} attributes 类(原型)属性，方法集
 * @return {Function} 新类
 */
    create : function(){
          var clazz = (function() {
            this.init.apply(this, arguments);
          });

          if (arguments.length === 0)
            return clazz;

          var absObj, base, type, ags = $.makeArray( arguments );

          if (typeof ags[0] === 'string') {
            type = ags[0];
            base = ags[1];
            ags.shift();
          } else base = ags[0];
          
          ags.shift();

          if (base)
            base = base.prototype;
          
          if (base) {
            function Bridge(){};
            Bridge.prototype = base;
            clazz.prototype = absObj = new Bridge();
          }

          if (type) {
            absObj.type = type;
            Util.ns(type, clazz);
          }
          
          for(var i=0,len=ags.length;i<len;i++)
            absObj = $.extend(absObj, typeof ags[i] === 'function' ? ags[i]( base ):ags[i]);
          
          absObj.constructor = clazz;
          return clazz;
    },
<div id="method-Xwb.util-domUp"></div>/**
 * 在DOM树中向上查找符合指定选择器的元素。
 * @param {HTMLElement} fromElement 开始元素(包含)
 * @param {HTMLElement} toElement 结束元素(不包含)，未设置时为document.body元素
 */    
    domUp : function(el, selector, end){
        end = end || doc.body;
        var isStr = typeof selector === 'string';
        while(el){
            if(isStr){
                if($(el).is(selector))
                    return el; 
            }else if(selector(el)){
                return el;
            }
            el = el.parentNode;
            if(el === end)
                return NULL;
        }
        return el;        
    },
<div id="method-Xwb.util-ns"></div>/**
 *  根据字符串创建命名空间。
  <pre><code>
  Xwb.util.ns('Xwb.ux', {});
 </code></pre>
 * @param {String} namespace
 * @param {Object} object
 */
    ns : function(ns, v){
        var routes = ns.split('.'),p=window,key;
        for(var k=0,len=routes.length - 1;k<len;k++){
            key = routes[k];
            if(!p[key])
                p[key] = {};
            p = p[key];
        }
        p[routes[k]] = v;
    },
<div id="method-Xwb.util-calWbText"></div>/**
 *  计算文本剩余字数，默认最大长度为微博最大长度。
 *  如果已超出最大限制字数，返回负值。
 * @param {String} text
 * @param {Number} [max] 可选，最大字数（一个字两个字符）
 * @return {Number} 
 */
    calWbText : function(text, max){
        if(max === undefined)
            max = MAX_WBTXT_LEN;
        var cLen=0;
        var matcher = text.match(/[^\x00-\xff]/g),
            wlen  = (matcher && matcher.length) || 0;
        return Math.floor((max*2 - text.length - wlen)/2);
    },
    
<div id="method-Xwb.util-byteLen"></div>/**
 *  返回占用字节长度（一个字两个字节）
 * @param {String} text
 * @return {Number}
 */
    byteLen : function(text){
        var len = text.length;
        var matcher = text.match(/[^\x00-\xff]/g);
        if(matcher)
            len += matcher.length;
        return len;
    },
    
    <div id="method-Xwb.util-byteCut"></div>/**
     * 以字节为长度计算单位截取字符串，一个字两个字节
     * @param {String} text
     * @param {Number} length
     * @return {String} cutString
     */
    byteCut : function(str, length) {
      var wlen = Util.byteLen(str);
      if(wlen>length){
          // 所有宽字用&&代替
          var c = str.replace(/&/g, " ")
                     .replace(/[^\x00-\xff]/g, "&&");
          // c.slice(0, length)返回截短字符串位
          str = str.slice(0, c.slice(0, length)
                    // 由位宽转为JS char宽
                    .replace(/&&/g, " ")
                    // 除去截了半个的宽位
                    .replace(/&/g, "").length
                );
      }
      return str;
    },
    <div id="method-Xwb.util-stringReplace"></div>/**
     *  替换源字符串中某段为指定向字符串
     * @param {String} source
     * @param {String} replacement
     * @param {Number} fromIndex
     * @param {Number} toIndex
     * @return {String} newString
     */
    stringReplace : function(source, text, from, to){
        return source.substring(0, from) + text + source.substring(to);
    },

<div id="method-Xwb.util-focusEnd"></div>/**
 *  将光标定位至指定下标，如下标未设置，定位至文本末尾
 * @param {HTMLElement} inputor
 * @param {Number} index
 */
    focusEnd : function(inputor, num){
        inputor.focus();
        if(num === undefined)
            num = inputor.value.length;
        if(doc.selection) {
            var cr = inputor.createTextRange();
            cr.collapse();
            cr.moveStart('character', num);
            cr.moveEnd('character', num);
            cr.select();
        }else inputor.selectionStart = inputor.selectionEnd = num;
    },
    
    selectionStart : function(elem){
        if(!ds)
            return elem.selectionStart;
        var range = ds.createRange(), 
            s, 
            bdyRange = doc.body.createTextRange();
            
            bdyRange.moveToElementText(elem);
            try{
                for(s=0;bdyRange.compareEndPoints("StartToStart", range) < 0;s++)
                    bdyRange.moveStart('character', 1);
            }catch(e){
                s = this.getCursorPos(elem);
            }
         return s;
    },
    
    selectionBefore : function(elem){
        return elem.value.slice(0, this.selectionStart(elem));
    },
<div id="method-Xwb.util-selectText"></div>/**
 * 选择输入框内指向范围内的文本
 * @param {HTMLElement} inputor
 * @param {Number} startIndex
 * @param {Number} endIndex
 */
    selectText : function(elem, start, end){
        elem.focus();
        if(!ds){
            elem.setSelectionRange(start, end);
            return;
        }
        
        var range = elem.createTextRange();
        range.collapse(1);
        range.moveStart('character', start);
        range.moveEnd('character', end - start);
        range.select();
    },
<div id="method-Xwb.util-hasSelectionSupport"></div>/**
 *  检测是当前浏览器是否是支持W3C标准选择范围的浏览器
 * @return {Boolean}
 */
    hasSelectionSupport : function(){
       var el = doc.createElement('TEXTAREA');
       var is = FALSE;
       if( 'selectionStart' in el )
            is = TRUE;
       this.hasSelectionSupport = function(){
            return is;
       };
       return is;
    },
<div id="method-Xwb.util-getCursorPos"></div>/**
 * 获得输入框内光标下标
 * @param {HTMLElement} element
 * @return {Number} index
 */
    getCursorPos : function(elem){
        var pos = 0;
        // msie 8--
        if(!this.hasSelectionSupport()){
            elem.focus();
            var range = NULL;
            range = ds.createRange();
            var tmpRange = range.duplicate();
            tmpRange.moveToElementText(elem);
            tmpRange.setEndPoint("EndToEnd", range);
            elem.selectionStart = tmpRange.text.length - range.text.length;
            elem.selectionEnd = elem.selectionStart + range.text.length;
            pos = elem.selectionStart;
        }else{
            if( elem.selectionStart || elem.selectionStart == '0' )
                pos = elem.selectionStart;
        }
        
        return pos;
    },
<div id="method-Xwb.util-getSelectionText"></div>/**
 * 获得输入框内选择文本
 * @param {HTMLElement} element
 * @return {String} text
 */
    getSelectionText : function(elem){
        var selectedText = '';
        if(window.getSelection){
            selectedText = (function () {
                if (elem.selectionStart != undefined && elem.selectionEnd != undefined) {
                    return elem.value.substring(elem.selectionStart, elem.selectionEnd)
                }
                else {
                    return ""
                }
            })(elem);
        }else selectedText = ds.createRange().text;
        
        return selectedText;
    },
    
    setCursor : function(elem, pos, coverLen){
        pos = pos == NULL ? elem.value.length : pos;
        coverLen = coverLen == NULL ? 0 : coverLen;
        elem.focus();
        if(elem.createTextRange){
            var range = elem.createTextRange();
            range.move("character", pos);
            range.moveEnd("character", coverLen);
            range.select();
        }else {
            elem.setSelectionRange(pos, pos + coverLen);
        }
    },
    
    replaceSelection : function(elem, text){
        elem.focus();
        var start = this.selectionStart(elem),
            end   = this.getSelectionText(elem).length,
            val   = elem.value;
        end = end === 0 ? start : start+end;
        elem.value = Util.stringReplace(val, text, start, end);
        this.setCursor(elem, start+text.length);
        return start;
    },
<div id="method-Xwb.util-escapeHtml"></div>/**
 * 转义文本中的HTML字符
 * @param {String} html
 * @return {String} escapedHtml
 */
    escapeHtml : function(html){
        return html?html.replace(/</g, '&lt;').replace(/>/g, '&gt;'):'';
    },
<div id="method-Xwb.util-disable"></div>/** 
 *  利用CSS样式禁用或恢复指定html元素。
 * @param {HTMLElement} element
 * @param {Boolean} disabled
 * @param {String} [disabledCss] 可选，可自定义而不利用默认样式
 */
    disable : function(el , disabled, cs){
        disabled ? $(el).addClass(cs||disabledCS) : $(el).removeClass(cs||disabledCS);
    },
<div id="method-Xwb.util-getBind"></div>/**
 *  返回this为指定对象的函数，该方法会生成一个属性指定新函数，避免了每次调用时都产生新的函数。
  <pre><code>
  var a = {
     say : function(){ alert('say'); }
  };
  
  var wrappedSay = Xwb.util.getBind(a, 'say');
  // alert say
  wrappedSay();
  
  // 第二次调用时，返回原来已创建的闭包函数, true
  alert(wrappedSay === Xwb.util.getBind(a, 'say'))
 </code></pre>
 * @param {Object} object, this scope object
 * @param {String} functionName 函数名
 * @return {Function} closuredFunction
 */
    getBind : function(obj, funcName){
        var k = '__'+funcName;
        var m = obj[k];
        if(!m)
           m = obj[k] = Util.bind(obj[funcName], obj);
        return m;
    },
    
<div id="method-Xwb.util-uniqueId"></div>/**
 *  返回运行时唯一ID
 * @return {Number}
 */
    uniqueId : function(){
    	return ++_uid;
    },
<div id="method-Xwb.util-appendParam"></div>/**
 * 往URL追加提交参数
 * @param {String} url
 * @param {Object} param
 * @return {String}
 */
    appendParam : function(url, param){
        var qs = this.queryString(param);
        return url + ( url.indexOf('?') !== -1 ? '&'+qs : '?'+qs );
    },
<div id="method-Xwb.util-getFileName"></div>/**
 * 从路径中提取文件名
 * @param {String} pathName
 * @return {String}
 */
    getFileName : function(str, len){
		if (str.indexOf('\\')) {
			var parts = str.split('\\');
			str = parts.pop();
		}
			
		if (str.length > len) {
			str = str.substr(0, len-4) + '..' + str.substr(str.length-4);
		}
		return str;
    },
<div id="method-Xwb.util-split"></div>/**
 *  拆分字符串为数组。
 * @param {String} string
 * @param {String} splitChar 分隔字符
 * @param {String} escapeChar转义字符
 * @param {Array}  array
 */
    split : function(str, splitChar, escChar){
        var c, arr = [], tmp = [];
        if(!escChar)
            escChar = '\\';
    
        for(var i=0,len=str.length;i<len;i++){
            c = str.charAt(i);
            if(c === splitChar){
                arr.push(tmp.join(''));
                tmp.length = 0;
                continue;
            }
            else if(c === escChar && str.charAt(i+1) === splitChar){
                c = splitChar;
                i++;
            }
            tmp[tmp.length] = c;
        }
        if(tmp.length)
            arr.push(tmp.join(''));
        return arr;
    },
<div id="method-Xwb.util-parseKnV"></div>/**
 * 解释键值对字符串为JS对象，最常用法是解析html中rel属性。
 * @param {String} string
 * @return {Object} map
 */
    parseKnV : function(strRel){
        var map = {}, kv, kvs = this.split(strRel, ',');
        try {
            for( var i=0,len=kvs.length;i<len;i++){
                // if not contains ':'
                // set k = TRUE
                if(kvs[i].indexOf(':') === -1){
                    map[kvs[i]] = TRUE;
                }else {
                    // split : to k and v
                    kv = Util.split(kvs[i], ':');
                    // escape value
                    map[kv[0]] = kv[1];
                }
            }
        }catch(e) { 
            if(__debug) console.trace();
            throw 'Syntax Error:rel字符串格式出错。' + strRel; 
        }
    
        return map;
    },
<div id="method-Xwb.util-ancestorOf"></div>/**
 * 测试两个HTML元素间是否存在包含关系
 * @param {HTMLElement} parentElement
 * @param {HTMLElement} childElement
 * @return {Boolean}
 */
    ancestorOf :function(v, a, depth){
      if (v.contains && !$.browser.webkit) {
         return v.contains(a);
      }else if (v.compareDocumentPosition) {
         return !!(v.compareDocumentPosition(a) & 16);
      }
    
      if(depth === undefined)
        depth = 65535;
      var p = a.parentNode, bd = doc.body;
      while(p!= bd && depth>0 && p !== NULL){
        if(p == v)
          return true;
        p = p.parentNode;
        depth--;
      }
      return false;
    }
    
});



<div id="cls-Xwb.util.Cache"></div>/**
 * @class Xwb.util.Cache
 * 缓存类,数据结构为:<br>
 * <pre>
 * Cache[key] = [dataObjectArray||NULL, generator];
 * dataObjectArray[0] = 预留位,保存该key数据最大缓存个数, 默认为3.
 * generator = 生成数据回调
 * </pre>
 * @singleton
 */
var Cache = X.util.Cache = {

    <div id="cfg-Xwb.util.Cache-MAX_ITEM_SIZE"></div>/**@cfg {Number} MAX_ITEM_SIZE 对每个类别设置的最大缓存数量，默认为3.*/
    MAX_ITEM_SIZE: 3,

<div id="method-Xwb.util.Cache-reg"></div>/**
 * 注册数据产生方式回调函数,可重复赋值,函数返回键对应的数据.
 * @param {Object} key
 * @param {Function} callback
 * @param {Number} [max] 缓存该数据的最大值
 */
    reg: function(k, callback, max) {
       if(!this[k])
        this[k] = [NULL, callback];
       else this[k][1] = callback;

       if(max !== undefined)
        this.sizeFor(k, max);
    },
<div id="method-Xwb.util.Cache-get"></div>/**
 * 根据键获得对应的缓存数据.
 * @param {String} key
 * @return {Object}
 */
    get: function(k) {
        var a = this[k];
        if(a === undefined)
            return NULL;
        var b = a[1];
        a = a[0];

        if(a === NULL){
          return b();
        }
        //0位预留
        if(a.length > 1)
            return a.pop();
        if(b)
            return b();

        return NULL;
    },
<div id="method-Xwb.util.Cache-put"></div>/**
 * 缓存键值数据.
 * @param {Object} key
 * @param {Object} value
 */
    put: function(k, v) {
        var a = this[k];
        if(!a){
            this[k] = a = [[this.MAX_ITEM_SIZE, v]];
            return;
        }
        var c = a[0];
        if(!c)
          a[0] = c = [this.MAX_ITEM_SIZE];

        if (c.length - 1 >= c[0]) {
            return ;
        }

        c.push(v);
    },

<div id="method-Xwb.util.Cache-remove"></div>/**
 * 移除缓存.
 * @param {Object} key 键值
 */
    remove : function(k){
      var a = this[k];
      if(a){
        delete this[k];
      }
    },
<div id="method-Xwb.util.Cache-sizeFor"></div>/**
 * 设置指定键值缓存数据的最大值.
 * @param {Object} key
 * @param {Number} max
 */
    sizeFor : function( k, max ) {
        var a = this[k];
        if(!a)
          this[k] = a = [[]];
        if(!a[0])
          a[0] = [];
        a[0][0] = max;
    }
};

<div id="prop-Xwb.util.Cache-div"></div>/**
 * 缓存DIV结点.
 * <pre><code>
   var divNode = Xwb.Cache.get('div');
 * </code></pre>
 * @property div
 * @type DOMElement
 */
Cache.reg('div', function() {
    return doc.createElement('DIV');
});


/**
 * @class Xwb
 */

<div id="method-Xwb-getCfg"></div>/**
 * 根据配置名称获得全局配置值
 * @param {String} key
 * @return {Object}
 * @type Function
 */
X.getCfg     = function(key){
	return X.cfg && X.cfg[key]; 
};

<div id="method-Xwb-getSiteUid"></div>/**
 * 返回站点用户ID
 * @return {String} siteId
 * @type Function
 */
X.getSiteUid = function(){ return parseInt(X.getCfg('siteUid'));};

<div id="method-Xwb-getUid"></div>/**
 * 返回登录用户ID
 * @return {String} userId
 * @type Function
 */
X.getUid     = function(){
	var uid = X.getCfg('uid'); 
	return uid !== '0' && uid;
};

<div id="method-Xwb-getWb"></div>/**
 *  根据微博ID返回缓存中的微博数据
 * @type Function
 * @return {Object}
 */
X.getWb = function(id) {
	var wbList = X.getCfg('wbList');
	
	if (id)
	{
		return wbList && wbList[id];
	}

	return wbList;
};

<div id="method-Xwb-setWb"></div>/**
 *  缓存微博数据到全局缓存
 * @param {String} wid
 * @param {Object} wbData
 * @type Function
 */
X.setWb = function(id, data) {
	X.cfg.wbList && (X.cfg.wbList[id] = data);
};

//
//  以缩略名注册类
//
$.extend(X, {
	
	_cls : {},
	<div id="method-Xwb-reg"></div>/**
	 * 为指定类注册一个短命名标识
	 * @param {String} shortcut 标识，即该类的缩略名
	 * @param {Function} clazz 类
	 * @param {Boolean} [override] 默认如果已存在名称相同类，会抛出异常，通过设置本标记强制重定义类
	 * @return clazz
	 */
	reg : function(n, cls, override){
		if(this._cls[n] !== undefined && !override){
			if(__debug) console.trace();
			throw '已定义类' + n;
		}
		this._cls[n] = cls;
		return cls;
	},
	
	<div id="method-Xwb-use"></div>/**
	 * 使用短名类
	 * @param {Object} name
	 * @param {Object|Fu}
	 */
	use : function(n){
		// instance( type, config )
		var cls = this._cls[n];
		if (cls) {
		    // object only
		    if(typeof cls === 'object')
		        return cls;
		    // instance class
		    var cfg = arguments[1];
		    if( typeof cfg === 'function' )
		        return new cls(cfg(cls.prototype));
		    return new cls(cfg);
		}
		return NULL;
	},
	
<div id="method-Xwb-isModule"></div>/**
 * 检测当前页面是否为指定模块的页面。
 * @param {String} page
 * @param {Boolean}
 */
	isModule : function(name){
	    return this.getModule() === name;
	},
	
<div id="method-Xwb-getModule"></div>/**
 * 返回当前页面模块名称
 * @return {String}
 */
	getModule : function(){
	    if(this._mod === undefined){
	        if(this.getCfg('page')){
	            this._mod = this.getCfg('page');
	        }else {
    	        var url = location.href,
    	            idx = url.indexOf('?');
    	        if(idx !== -1){
    	            url = url.substring(idx+1);
    	            if(url){
    	                url = url.split('&');
    	                for(var i=0,len=url.length;i<len;i++){
    	                    var k = url[i].split('=');
    	                    if(k.length === 2 && k[0] === 'm'){
    	                        this._mod = k[1];
    	                        break;
    	                    }
    	                }
    	            }
    	        }
    
    	        if( this._mod === undefined )
    	            this._mod = FALSE;
    	        else {
                    var shareIdx = this._mod.indexOf('#');
                    if(shareIdx != -1)
                    this._mod = this._mod.substring(0, shareIdx);
    	        }
	        }
	    }
	    return this._mod;
	}
});

<div id="cls-Xwb.ax"></div>/**
 * @class Xwb.ax
 */
X.ax = {};

<div id="cls-Xwb.ax.Uploader"></div>/**
 * @class Xwb.ax.Uploader
 * 异步文件上传类，该类通过类似JSONP方式的隐藏IFRAME上传文件，
 * Xwb库内简称Uploader。
 <pre><code>
    X.use('Uploader', {
       form:$('#fileForm'),
       // 成功后回调 
       onload:function(e){
            if(e.isOk()){
                alert('uploaded!');
            }else {
                alert(e.getCode());
            }
       }
    });
    </code></pre>
 * @constructor
 * @param {Object} config 配置信息
 */

<div id="cfg-Xwb.ax.Uploader-[action]"></div>/**
 * @cfg {String} [action] 如果action未配置，则从form里提取action，如果form未置设action，默认action为Xwb.request.apiUrl('action', 'upload_pic')
 */
<div id="cfg-Xwb.ax.Uploader-onload"></div>/**
 * @cfg {Function} onload 上传后的回调函数，参数为Xwb.request.ResponseDefinition实例
 */
X.ax.Uploader = X.reg('Uploader', function(cfg){
    this.init(cfg);
});

X.ax.Uploader.prototype = {
    
    init : function( cfg ){
        $.extend( this, cfg );
        
        var form = this.form;
        var name = 'xwb_upload_frame_' + Util.uniqueId();
        this.iframe = T.forNode('<iframe src="about:blank" style="display:none;" id="'+name+'" name="'+name+'"></iframe>');
        
        //添加callback参数 ?? 为什么还要添加
        $('<input type="hidden" name="callback"/>').appendTo(form);
        
        $(this.iframe).appendTo( doc.body );
        
        form.target = name;
        
        if(!this.action)
            this.action = form.action || Req.apiUrl('action', 'upload_pic');
    },
    
<div id="method-Xwb.ax.Uploader-setAction"></div>/**
 * 可重置action值
 * @param {String} action
 */
    setAction : function(action){
        this.action = action;
        return this;
    },
<div id="method-Xwb.ax.Uploader-isLoading"></div>/**
 * 是否加载中
 */
    isLoading : function(){
        return !!this.jsonpFn;
    },
    
<div id="method-Xwb.ax.Uploader-upload"></div>/**
 *  开始上传
 * @param {Function} [callback]
 */
    upload : function( callback ){
        
        if(this.isLoading())
            this.abort();
        
        var self = this,
            fn = this.jsonpFn = 'jsonp' + new Date().getTime();
        
        window[fn] = function(){
            window[fn] = NULL;
            delete self.jsonpFn;
            var e = Req.parseProtocol(arguments[0]);
            (callback||self.onload).call(self, e);
            // fix a bug in IE7
            delete self.jsonpFn;
        };
        
        this.form.action = Util.appendParam(this.action, {callback:'parent.'+fn, '_':Util.uniqueId()});
        this.form.submit();
    },

    onload : $.noop,
    
    abort : function(){
        if(this.isLoading()){
            var fn = this.jsonpFn;
            window[fn] = function(){
                window[fn] = NULL;
            };
        }
    }
};

})(Xwb, $);
<div id="cls-Xwb.util.Eventable"></div>/**
 * @class Xwb.util.Eventable
 * 事件处理模型的实现.
 * @constructor
 * @param {Object} config config object
 */
 
 
<div id="method-Xwb.util.Eventable-fire"></div>/**
 * 发送对象事件.<br>
 <pre><code>
  var e = new Eventable();
  e.on('selected', function(arg){
   //handling..
  });
  e.fire('selected', arg);
  </code></pre>
 * @method fire
 * @param {Object} eid 事件名称
 * @param {Object, Object, ...} args 传递的回调参数
 */


<div id="method-Xwb.util.Eventable-on"></div>/**
 * 监听对象事件,如果回调函数返回false,取消后续的事件处理. <br>
 <pre><code>
   var self = {name:'cat'};
   var cfg = {message:'Good boy!'};
   var e = new Xwb.Eventable();
   e.on('selected', function(item, cfg){
    //显示an item
    alert(item.title);

    //显示Rock
    alert(this.name);

    //显示Good boy!
    alert(cfg.message);
   }, self, cfg);

   var item = {title:'an item'};
   e.fire('selected', item);
   </code></pre>
 * @param {Object} eid 事件名称
 * @param {Function} callback 事件回调函数
 * @param {Object} [ds] this范围对象
 * @param {Object} [objArgs] 传递参数,该参数将作为回调最后一个参数传递
 * @method on
 * @return this
 */

<div id="method-Xwb.util.Eventable-un"></div>/**
 * 移除事件监听.
 * @param {Object} eid
 * @param {Function} callback
 * @method un
 * @return this
 */

<div id="method-Xwb.util.Eventable-fireOnce"></div>/**
 * 发送一次后移除所有监听器,有些事件只通知一次的,此时可调用该方法发送事件
 * @param {Object} eid
 * @method fireOnce
 * @return this
 */

<div id="method-Xwb.util.Eventable-to"></div>/**
 * 订阅当前对象所有事件
 * @param {Object} target 订阅者,订阅者也是可Eventable的对象
 * @method to
 * @return this
 */

    <div id="cfg-Xwb.util.Eventable-events"></div>/**
     * @cfg {Object} events 保存的事件列表,格式为
     <pre><code>
       events : {
         // names
         'eventName' : [ //Array, handler list
           // handler data
           {  
             // callback 简写
             cb : function(arguments){
               // ...
             },
             
             // <b>this</b> caller
             caller : object
           },
           ...
         ],
         ...
       }
     </code></pre>
     */

(function(X, $){

var R = X.util.arrayRemove;

var Eventable = X.util.Eventable = (function(opt){
     if(opt)
      $.extend(this, opt);
     
     $.extend(this, Eventable.prototype);
});

Eventable.prototype = {

  fire : function(eid){
  
  	if(__debug) {console.log('发送:%o',arguments);}
  
  	if(this.events){
  		
  		var handlers = this.events[eid];
  		
  		if(handlers){
  			var fnArgs = $.makeArray(arguments),
  			    argLen, ret, i, len, oHand;
  			// remove eid the first argument
  			fnArgs.shift();
			argLen=fnArgs.length;
        
        handlers._evtLocked = true;
        
  			for(i=0,len=handlers.length;i<len;i++){
  				oHand = handlers[i];
  				
  				// 标记已删除
  				if( oHand.removed)
  				   continue;
  				// 如果注册处理中存在参数args,追加到当前参数列尾
  				if(oHand.args)
  				   fnArgs[argLen] = oHand.args;
  
  				// 如果注册处理中存在this,应用this调用处理函数
  				ret = (oHand.ds)?oHand.cb.apply(oHand.ds,fnArgs):oHand.cb.apply(this,fnArgs);
  				
  				//如果某个处理回调返回false,取消后续处理
  				if(ret === false)
  				   break;
  			}
  			
  			handlers._evtLocked = false;
  		}
  	}
  	//返回最后一个处理的函数执行结果
  	return ret;
  },
  
  on   :  function(eid,callback,ds,objArgs){
      if(!eid || !callback){
      	  if(__debug) console.trace();
          throw ('eid or callback can not be null');
      }

      
      if(!this.events)
        this.events = {};
      var hs = this.events[eid];
      if(!hs)
          hs = this.events[eid] = [];
      hs[hs.length] = {
          cb:callback,
          ds:ds,
          args:objArgs
      };
      return this;
  },
  
  un : function(eid,callback){
      if(!this.events)
        return this;
      
      if(callback === undefined){
        delete this.events[eid];
        return this;
      }
  
      var handlers = this.events[eid];
  
      if(handlers){
          // 产生迭代修改冲突，将复制新数组。
          if(handlers._evtLocked) {
             handlers = this.events[eid] = handlers.slice(0);
          }
          
          for(var i=0;i<handlers.length;i++){
              var oHand = handlers[i];
              if(oHand.cb == callback){
                  R(handlers, i);
                  // 标记删除
                  oHand.removed = true;
                  break;
              }
          }
      }
      return this;
  },
  
  fireOnce : function(eid){
    var r = this.fire.apply(this, arguments);
    this.un(eid);
    return r;
  }
};

})(Xwb, $);
<div id="cls-Xwb.ax.SelectionHolder"></div>/**
 *  @class Xwb.ax.SelectionHolder
 *  本类主要解决IE下文本输入框内文本选择，替换和插入等问题。<br/>
 *　例如发布微博框在IE６下，先在文本框内选择一段文字，再从表情选择框内选择一个表情插入到文本框，
 *  通常在这种情况下表情不能很好的直接插在文字选择处，而是追加到文本尾部。
 *  利用本类可忽略其中的兼容处理，直接调用类方法即可解决问题。<br/>
 *  对于使用该类实例封装后的输入框元素，会在元素的jQuery缓存xwb_selholder键保存指向该实例的引用。
 * @constructor
 * @param {Object} config
 */
 <div id="cfg-Xwb.ax.SelectionHolder-elem"></div>/**@cfg {HTMLElement} elem 关联的文件框*/
 
(function(X, Util, $){

    X.ax.SelectionHolder = function(opt){
        $.extend(this, opt);
        if(!Util.hasSelectionSupport())
            this.initEvent(this.elem);
    };
    
    X.ax.SelectionHolder.prototype = {
        
        pos : -1,
        
        length : 0,
        
        initEvent : function(){
            var self = this;
            var fn = function(){
                try{
                    self.saveSpot();
                }catch(e){}
            };
            $(this.elem)
              .mouseup(fn)
              .keyup(fn)
              .data('xwb_selholder', this);
        },
        <div id="method-Xwb.ax.SelectionHolder-saveSpot"></div>/**
         *  保存输入框当前选择状态和光标位置等信息，
         *  这个一般情况下不会用到，除非你不能确定是否由外部其它途径更新了输入框状态。
         */
        saveSpot : function(){
            var elem = this.elem;
            this.pos    = Util.getCursorPos(elem);
            this.length = Util.getSelectionText(elem).length;
        },
        <div id="method-Xwb.ax.SelectionHolder-insertText"></div>/**
         *  往输入框当前光标处插入一段文本
         *  @param {String} text
         */
        insertText : function(text){
            var elem = this.elem, 
                val  = elem.value;
            if(Util.hasSelectionSupport()){
                Util.replaceSelection(elem, text);
            }else {
                // append
                if(this.pos === -1){
                    elem.value = val + text;
                    Util.focusEnd(elem);
                }else {
                    elem.value = Util.stringReplace(val, text, this.pos, this.pos+this.length);
                    Util.setCursor(elem, this.pos+text.length);  
                }
            }
            this.saveSpot();
        },
        
        <div id="method-Xwb.ax.SelectionHolder-setText"></div>/**
         *设置选择框文本
         * @param {String} text
         */
        setText : function(text){
            this.elem.value = text;
            try{
                this.focusEnd();
            }catch(e){}
        },
        <div id="method-Xwb.ax.SelectionHolder-clearSpot"></div>/**清除选择框状态信息*/
        clearSpot : function(){
            this.length = 0;
            this.pos = -1;
        },
        <div id="method-Xwb.ax.SelectionHolder-focusEnd"></div>/**将光标定位至文本框末尾*/
        focusEnd : function(){
            Util.focusEnd(this.elem);
            this.saveSpot();
        },
        <div id="method-Xwb.ax.SelectionHolder-focusStart"></div>/**将光标定位至文本框开始位置*/
        focusStart : function(){
            Util.setCursor(this.elem, 0);
            this.saveSpot();
        }
    };

    X.reg('SelectionHolder', X.ax.SelectionHolder);

})(Xwb, Xwb.util, $);
(function(X, Util, $){
    var undefined;
<div id="cls-Xwb.ax.ActionEvent"></div>/**
 * @class Xwb.ax.ActionEvent
 当一个动作触发后，就生成一个Xwb.ax.ActionEvent实例作参数传给处理方法。
 本类携带了与该动作相关的数据和方法，如触发源元素，当前元素，获得当前路径数据等。
 类无需手动实例化，由{@link Xwb.ax.ActionMgr}内部维护。
<pre>
技巧：
利用该类获得动作关联元素常用方法：
1. 给相关元素设定局部唯一ID
2. 利用e.jq()方法或$(e.getEl())返回一定范围父元素的jq对象
3. 根据设定的id获得元素
例：
在处理方法中，
<code>
function( e ){
    // 假如事件源元素 rel="w:123765"
    // 获得包含w属性的html元素
    var jqWb = e.jq('w');
    var targetEl = jqWb.find('#xwb_tar');
    // ...
}
</code>
</pre>
 */

<div id="prop-Xwb.ax.ActionEvent-evt"></div>/**
 * @property evt
 触发该动作的浏览器事件对象
 * @type DOMEvent
 */
 
<div id="prop-Xwb.ax.ActionEvent-src"></div>/**
 * @property src
 触发该动作的源元素
 * @type HTMLElement
 */
 
<div id="prop-Xwb.ax.ActionEvent-data"></div>/**
 * @property data
 * 当前处理元素的rel数据
 * @type Object
 */
function ActionEvent(rels){
    this.q = rels;
    // 初始状态
    this.idx = -1;
    // end pos
    this.end = this.q.length-1;
};


ActionEvent.prototype = {

    prevented : undefined,
    
    stopPropagationed : undefined,
    
<div id="method-Xwb.ax.ActionEvent-get"></div>/**
 * 当前DOM路径内向上查找rel属性中包含name键的数据
  <pre><code>
  // rel="w:123456"
  var wbId = e.get('w');
 </code></pre>

 * @param {String} name
 * @return {String} value
 */
    get : function(name){
        var r = this.getRel(name);
        return r && r.data && r.data[name];
    },
<div id="method-Xwb.ax.ActionEvent-escape"></div>/**
 * 返回经escape函数转义后的字符串数据
 * @param {String} name
 * @return {String}
 */
    escape : function(name){
        var v = this.get(name);
        if(v !== undefined)
            return escape(v);
    },
<div id="method-Xwb.ax.ActionEvent-getEl"></div>/**
 * 当前DOM路径内向上查找含有rel以name为键的元素
 * @param {String} name
 * @return {HTMLElement}
 * <pre><code>
  // 从当前产生事件的元素开始向上查找获得包含w字段的元素
  var parent = e.getEl('w');
 </code></pre>
 */
    getEl : function(name){
        var r = this.getRel(name);
        return r && r.src;
    },

<div id="method-Xwb.ax.ActionEvent-jq"></div>/**
 * 上溯DOM获得rel含有name键元素或其子元素的jQuery对象
 *@param {String} name 字段名
 * @param {Selector} [child] 可查找元素下的子元素
 * @return {jQuery}
 */
    jq : function(name, child){
        var jq =  $(this.getEl(name));
        if(child)
            jq = jq.find(child);
        return jq;
    },
    
// private
    getRel : function(name){
        var set = this.q;
        for(var i=this.idx,end=this.end;i<=end;i++){
            var d = set[i].data;
            if(d[name] !== undefined)
                return set[i];
        }
    },
    
// private
    _next : function(){
        var nxt = this.q[++this.idx];
        // 最终状态
        if(nxt === undefined)
            this.idx = 0;
        return nxt;
    },

// private 拷贝包括当前状态等所有数据。
    clone : function(){
        var act = new ActionEvent(this.q);
        act.idx = 0;
        return act;
    },

<div id="method-Xwb.ax.ActionEvent-preventDefault"></div>/**
 * 是否终止浏览器默认操作，<b>默认为终止</b>。<br/>
 常见的处理完checkbox或radio元素的事件后，调用该方法使得元素改变选择状态。<br/>
 * @param {Boolean} prevented
 */
    preventDefault : function(set){
        this.prevented = set;
    },
<div id="method-Xwb.ax.ActionEvent-stopPropagation"></div>/**
 * 是否停止浏览器的事件冒泡，<b>默认为停止</b>。
 * @param {Boolean} stopPropagation
 */    
    stopPropagation : function(set){
        this.stopPropagationed = set;
    },
<div id="method-Xwb.ax.ActionEvent-lock"></div>/**
 * 标记当前动作，或获得当前动作标记。
 * 常用于标记以防止动作重复触发动作。
 * @param {Boolean} locked
 * @param {String} [name] name
 *<pre><code>
 // 锁定动作元素，使得不能再触发
 e.lock(1);
 // 待请求处理后恢复
 Xwb.request.post(data, function(){
    // 解除锁定
    e.lock(0);
 });
 </code></pre>

 */
    lock : function(set, name){
        var k = 'xwb_e_' + this.data.e;
        if(name)
            k+= '_' + name;
        if(set === undefined)
            return $(this.src).data(k);
        $(this.src).data(k, set);
    }
};

<div id="cls-Xwb.ax.ActionMgr"></div>/**
 * @class Xwb.ax.ActionMgr
 * 本类行为类似DOM事件模型中的事件冒泡，
 * 在某一个元素内集中监听各种事件，包括子元素的事件，
 * 并在事件触发时方便获得相关数据，而无需对子元素绑定类似事件。
 * <pre><code>
  将动作事件管理器绑定到元素上
  var mgr = new Xwb.ax.ActionMgr({target:'#selector'});
  
  注册动作处理，当指定动作发生时执行处理
  mgr.reg('myaction', function(actEvt){
        // 显示a元素
        alert(actEvt.src);
        
        // 显示myaction
        alert(actEvt.data.e);
        
        // 显示123456
        alert(actEvt.get('u'));
  });
  
  将动作添加到HTML模板中，用户点击元素时就能触发
  &lt;li rel=&quot;u:123456&quot;&gt;&lt;a href=&quot;#&quot; rel=&quot;e:myaction&quot;&gt;click me&lt;/a&gt;&lt;/li&gt;
  
  更多关于本类的使用方法详见actions.js文件。
 </code></pre>
 * @constructor
 * @param {Object} config
 */
<div id="cfg-Xwb.ax.ActionMgr-target"></div>/**@cfg {jQuery|HTMLElement} target 在该元素范围内监听action事件*/
X.ax.ActionMgr = X.reg('ActionMgr', function(cfg){
   cfg && $.extend(this, cfg);
   if(!this.actions)
        this.actions = {};
   if(!this.filters)
        this.filters  = [];
   
   if(this.target){
        this.bind(this.target);
        delete this.target;
   }
});

var globalFilters = [];

<div id="method-Xwb.ax.ActionMgr-ActionMgr.parseRel"></div>/**
 * 解析rel字符串为JSON对象数据
 * @param {String} relData
 * @static
 * @return {Object}
 */
X.ax.ActionMgr.parseRel = function(rel){
    return Util.parseKnV(rel);
};

// 解析HTML元素及父元素的rel属性，并返回该属性链的JSON数据，以被{@link Xwb.ax.ActionEvent}利用。
X.ax.ActionMgr.collectRels = function(trigSource, stopEl, cache){
    var 
        rels, 
        rel, 
        self = this;
    
    if(cache===undefined)
        cache = true;
    
    // 往上收集rel
    Util.domUp(trigSource, function(el){
        var jq = $(el);
        
        if(cache){
            rel = jq.data('xwb_rel');
            if(!rel){
                rel = jq.attr('rel');
                if(rel){
                    rel = {src:el, data:self.parseRel(rel)};
                    jq.data('xwb_rel', rel);
                }
            }
        }else {
            rel = jq.attr('rel');
            if(rel)
                rel = {src:el, data:self.parseRel(rel)};
        }
    
        if(rel){
            if(!rels)
                rels = [];
            rels[rels.length] = rel;
        }
    
    } , stopEl);
    
    return rels;
};

<div id="method-Xwb.ax.ActionMgr-ActionMgr.wrapRel"></div>/**
 * 解析DOM树中的rel属性值，返回该属性链接相关的{@link Xwb.ax.ActionEvent}类，以便利用该类获得链中的数据
 * @param {HTMLElement} sourceElement 开始元素
 * @param {HTMLElement} [toElement] 结束元素
 * @return {Xwb.ax.ActionEvent}
 * @static
 */
X.ax.ActionMgr.wrapRel = function(el, stopEl, cacheNodeData){
    var rels = this.collectRels(el, stopEl, cacheNodeData);
    var e = new ActionEvent(rels);
    e._next();
    return e;
};

<div id="method-Xwb.ax.ActionMgr-ActionMgr.getRel"></div>/**
 * 获得具体单个rel键值
 * @param {HTMLElement} sourceElement 开始元素
 * @param {String} name
 * @param {HTMLElement} [toElement] 结束元素
 * @return {String}
 */
X.ax.ActionMgr.getRel = function(el, name, stopEl){
    return this.wrapRel(el, stopEl).get(name);
};

<div id="cfg-Xwb.ax.ActionMgr-trigEvent"></div>/**@cfg {String} trigEvent 触发动作的事件名称，默认为click */
X.ax.ActionMgr.prototype = {
    
    trigEvent : 'click',

    cacheNodeData : true,
    
<div id="method-Xwb.ax.ActionMgr-reg"></div>/**
 * 注册动作处理方法，当参数只有一个时注册全局监听器，可监听来自该管理器的所有动作<br/>
 * 只有一个参数时时监听管理器内所有动作
 * @param {String} actionName 动作名称
 * @param {Function} handler 动作处理方法
 * @param {Xwb.ax.ActionConfig} config 动作信息
 *@return this
 */
    reg : function(act, handler, cfg){
        var d = { n : act, h : handler };
        if( cfg )
            $.extend( d, cfg );
        
        this.actions[act] = d;
        return this;
    },
    
<div id="method-Xwb.ax.ActionMgr-get"></div>/**
 * 获得一个动作配置信息
 * @param {String} name
 * @return {Xwb.ax.ActionConfig}
 */
    get : function( name ){
        return this.actions[ name ];
    },
    
<div id="method-Xwb.ax.ActionMgr-addFilter"></div>/**
 * 增加动作拦截器，可拦截来自当前管理器或所有管理器的每个动作。
 *  @param {Function} filter
 * @param {Boolean} [global] 是否为所有动作的拦截器，默认只拦截当前管理器的动作
 * @return this
 */
    addFilter : function(filter, global){
        global ? globalFilters.push(filter) : this.filters.push(filter);
        return this;
    },
    
<div id="method-Xwb.ax.ActionMgr-bind"></div>/**
 * 如果不想通过{@link #target}配置绑定面板，可调用该方法将管理器绑定到指定元素
 * @param {Selector} target
 * @return this
 */
    bind : function(selector, evt){
        var scope = this;
        $(selector).bind(evt || this.trigEvent, function(e){
           var rels = X.ax.ActionMgr.collectRels(e.target, this, this.cacheNodeData);
           rels && scope.fireRels(rels, e);
        });
        return this;
    },

<div id="method-Xwb.ax.ActionMgr-doAct"></div>/**
 * 可以手动触发动作，从某个元素起，至某个父元素结束
 * @param {HTMLElement} sourceElement
 * @param {HTMLElement} stopElement
 */
    doAct : function(el, stopEl, cacheNodeData){
        var rels = X.ax.ActionMgr.collectRels(el, stopEl, cacheNodeData);
        return !(rels && this.fireRels(rels));        
    },

    // @return {Boolean} handled
    fireRels : function(rels, evt){
        var e = new ActionEvent(rels);
        e.evt = evt;
        if(__debug) console.log('act e:', e);
        
        var rel, data,
            hs = globalFilters.length,
            hg = this.filters.length,
            handled,
            prevented, stopPropagationed;
        
        while ( (rel = e._next()) ){
           // 存在action
           data = rel.data;
           if(data.e){
               e.src  = rel.src;
               e.data = data;
                // 如果当前操作已锁定，取消操作并返回，防止重复响应
                if(!e.lock()){
                   var act = this.actions[data.e];
                   if( hs ){
                      handled = true;
                      if( this._fireArray(globalFilters, e, act) === false ){
                        stopPropagationed = e.stopPropagationed;
                        prevented     = e.prevented;
                        break;
                      }
                   }
                   
                   if( hg ){
                        handled = true;
                        if( this._fireArray(this.filters, e, act) === false ){
                            break;
                        }
                   }
                   stopPropagationed = e.stopPropagationed;
                   prevented     = e.prevented;
                   if(act){
                        // clone e
                        var hdE  = e.clone();
                        hdE.src  = e.src;
                        hdE.data = data;
                        hdE.evt  = evt;
                        if(__debug) console.log('act e:',hdE);
                        if(!handled)
                            handled = true;
                        if( act.h.call(this, hdE) === false){
                            if(hdE.stopPropagationed !== undefined)
                                stopPropagationed = hdE.stopPropagationed;
                            if(hdE.prevented !== undefined)
                                prevented = hdE.prevented;
                            break;
                        }
                        if(hdE.stopPropagationed !== undefined)
                            stopPropagationed = hdE.stopPropagationed;
                        if(hdE.prevented !== undefined)
                            prevented = hdE.prevented;
                   }
                }else { // marked
                    if(__debug) console.warn('action e:'+e.data.e+' has been locked for resubmiting');
                    handled = true;
                    stopPropagationed = true;
                    prevented = true;
                    break;
                }
           }
        }
        
        if(evt && handled){
            // we defaultly preventDefault and stopPropagation
            if(prevented === undefined)
                prevented = true;
            if(stopPropagationed === undefined)
                stopPropagationed = true;
            
            if(prevented)
                evt.preventDefault();
    
            if(stopPropagationed)
                evt.stopPropagation();
        }
    },
    
    // 如果未注册action:，act有可能为空，所以act应用时要作空检查
    _fireArray : function(gs, e, act){
        for(var i=0,len=gs.length;i<len;i++)
            if( gs[i].call( this, e, act) === false )
                return false;
    }
};

// 页面action
X.reg('action', X.use('ActionMgr'));


})(Xwb, Xwb.util, $);
(function(){

<div id="cls-Xwb.ax.ElementValidationContext"></div>/**
 * @class Xwb.ax.ElementValidationContext
 */

<div id="method-Xwb.ax.ElementValidationContext-nextValidatorData"></div>/**
 * 获得第i个验证器,无对应下标值返回空。
 * @param {Number} index
 * @param {HtmlElement} element
 * @method nextValidatorData
 */

<div id="method-Xwb.ax.ElementValidationContext-report"></div>/**
 * 验证器报告验证结果。
 * @param {Boolean} result
 * @param {Object} data
 * @param {HtmlElement} element
 * @param {Xwb.ax.ElememtValidatorChain} elementChain
 * @method report
 */

<div id="method-Xwb.ax.ElementValidationContext-getValidator"></div>/**
 * 根据名称返回验证方法。
 * @param {String} name
 * @method getValidator
 */

<div id="method-Xwb.ax.ElementValidationContext-onerror"></div>/**
 * callback，每个验证器验证失败后都触发一次。
 * @param {HtmlElement} element
 * @param {Object} data
 * @param {Xwb.ax.ElememtValidatorChain} chain
 * @method onerror
 */

<div id="method-Xwb.ax.ElementValidationContext-onpass"></div>/**
 * callback，在验证元素过程中成功后只会触发一次。
 * @param {HtmlElement} element
 * @param {Xwb.ax.ElememtValidatorChain} chain
 * @method onpass
 */

<div id="method-Xwb.ax.ElementValidationContext-getMgr"></div>/**
 * 返回表单管理器。
 * @param {Xwb.ax.Validator} mgr
 * @method getMgr
 */

var X = Xwb;
var Util = X.util;

// getElememtExtraValidator ( elemName ) {}
// report(elem ,elem.value)
function ElememtValidatorChain(context, elem){
    this.elem = elem;
    this.context = context;
    this.nextChain = Util.bind(this._doNextChain, this);
}

ElememtValidatorChain.prototype = {
    <div id="prop-Xwb.ax.ElementValidationContext-error"></div>/**
     * @property error
     * 错误次数，可在callback调用时检测当前验证后的错误次数
     * @type Number
     */
     
    // error : 0,
    
    <div id="prop-Xwb.ax.ElementValidationContext-validating"></div>/**
     * @property validating
     * 是否验证中
     * @type Boolean
     */
     
    // validating : false,
    
    <div id="method-Xwb.ax.ElementValidationContext-validate"></div>/**
     *  元素进行验证。
     */
    validate : function(callback){
        // 禁止同时验证
        if(this.validating)
            throw 'Concurrent validation exception.';

        this.setValue(this._getRawValue( this.elem ));

        this._finalChain = callback;
        this.idx = -1;
        this.error = 0;
        this.msgs = [];

        this._doNextChain();
    },
    
    _getRawValue : function(elem){
        var v = elem.value;
        // 对字符串值做trim处理
        if( typeof v === 'string' )
            v = $.trim(v);
        return v;
    },
    

<div id="method-Xwb.ax.ElementValidationContext-getValue"></div>/**
 *  验证过程中，可以通过该方法获得元素最新值。
 */
    getValue : function(){
        return this.value;
    },
    
<div id="method-Xwb.ax.ElementValidationContext-setValue"></div>/**
 * 验证过程中，可通过该方法重置元素值。
 * @param {Mixed} value 元素值
 */
    setValue : function(v){
        this.value = v;
    },

<div id="method-Xwb.ax.ElementValidationContext-getErrors"></div>/**
 * 获得验证过程中出现的所有错误。
 * @return {Array}
 */
    getErrors : function(){
        return this.msgs;
    },
    
    addError : function(msg){
        this.msgs.push(msg);
    },

    <div id="method-Xwb.ax.ElementValidationContext-doPrehandling"></div>/**
     * 执行预处理。
     */
    doPrehandling : function(){
        var ctx = this.context;
        var idx = 0;
        var cmd; // cmd[name, data]
        
        while( (cmd = ctx.nextValidatorData(idx++, this.elem)) && cmd.isPreCmd){
            if(typeof cmd[0] === 'string'){
                var vd = ctx.getValidator(cmd[0]);
                if(!vd)
                    throw 'ValidationException:Undefined validator \''+cmd[0]+'\' in element '+this.elem.name;
                vd.call(this, this.elem, cmd[1]);
            }else cmd[0].call(this, this.elem, cmd[1]);
        }
    },
    
    // @private
    _doNextChain : function(){
        this.idx++;
        var vds = this.context.nextValidatorData(this.idx, this.elem);
        if(vds){
            // 跳过预处理
            if(vds.isPreCmd) {
                this.nextChain();
            }else{
                 // 单个验证器
                 if (typeof vds === 'function'){
                     // 寄存数据
                     vds[1] = {};
                     vds.call(this, this.elem, this.getValue(), vds[1] , this.nextChain);    
                 }else {
                    // 验证器标识字符串
                    // 结构为[sid, data]
                    // 验证器回调参数为 this.validator(elem, value, data, next)
                    if(typeof vds[0] === 'string'){
                        var vd = this.context.getValidator(vds[0]);
                        if(!vd)
                            throw 'ValidationException:Undefined validator ['+vds[0]+'] in element '+this.elem.name;
                        vd.call(this, this.elem, this.getValue(), vds[1], this.nextChain);
                    }else vds[0].call(this, this.elem, this.getValue(), vds[1], this.nextChain);
                 }
            }
        }else {
            if(!this.error){
                if(__debug) console.log('onpass', this.elem, this);
                this.context.onpass(this.elem, this);
            }
            // 结束
            this._finalChain &&  this._finalChain();
            this._finalChain = null;
        }
    },
    
    // 该方法会被验证器自动回调。
    report : function(result, data){
        if(!result)
            this.error++;

        var elem = this.elem;
        
        // 传递给context
        this.context.report(result, data, elem, this);
        
        if(!result){
            if(__debug) console.log('onerror', elem, data);
            this.context.onerror(elem, data, this);
        }
    }
};


<div id="prop-Xwb.ax.ElementValidationContext-handlingElem"></div>/**
 * @property handlingElem
 * @type HTMLElement
 */
 
<div id="prop-Xwb.ax.ElementValidationContext-data"></div>/**
 * @property data
 * 验证通过后表单提交的键值对
 * @type Object
 */

var validators;

X.ax.Validator = function(cfg){
    $.extend(this, cfg);
    this.init();
};

<div id="cls-Xwb.ax.ValidatorMgr"></div>/**
 * @class Xwb.ax.ValidatorMgr
 * @extends Xwb.ax.ElementValidationContext
 */

<div id="prop-Xwb.ax.ValidatorMgr-useCache"></div>/**
 * @property useCache
 * 是否缓存rel值
 * @type Boolean
 */
X.ax.Validator.prototype = {
    
    // implemention
    nextValidatorData : function(idx, elem){
        var vds = this._getBindingValidators(elem);
        return vds && vds[idx];
    },
    
    // implemention
    getValidator : function( name ){
        // 先自身查找，再全局查找。
        var selfVds = this.validators;
        var fnd;
        if(selfVds)
            fnd = selfVds[name];
        
        // 全局
        if(!fnd && validators)
            fnd = validators[name];
        return fnd;
    },
    
    // implemention    
    report : function(result, data, elem, chain){
        if(!result) {
            // 只有在表单验证时计算，单个元素验证忽略
            if(chain.multival){
                // 全局累计error
                this.error++;
                if( this.error === 1 && // 首次出错
                    this.autoFocus){
                    try{elem.focus();}catch(e){}
                }
            }
        }
    },
    
    // implemention
    getMgr : function(){ return this; },
    
    <div id="cfg-Xwb.ax.ValidatorMgr-trigOnSubmit"></div>/** @cfg {Boolean} trigOnSubmit 是否提交时触发验证，默认true*/
    trigOnSubmit : true,
    
    onfinal   : $.noop,
    
    <div id="cfg-Xwb.ax.ValidatorMgr-autoFocus"></div>/**
     * @cfg {Boolean} autoFocus 验证失败时是否聚焦到元素上，默认true
     */
    autoFocus : true,
    
    init : function(){
        if(!validators)
            validators = {};
        
        this.nextChain = Util.getBind( this, '_doNextChain' );
        
        this.form = $(this.form)[0];
        
        var self = this;
        
        // 执行预处理
        
        $.each(this._getElements(), function(){
            var chain = new ElememtValidatorChain(self, this);
            chain.doPrehandling();
        });
        
        var trigFn = function(){
                self.validate();
                return false;
        };
        
        if( this.trigOnSubmit )
            this.form.onsubmit = trigFn;
        
        if( this.trigger ){
            this.trigger = $(this.trigger)[0];
            $(this.trigger).click(function(){
               return trigFn();
            });
        }
    },
    
    <div id="method-Xwb.ax.ValidatorMgr-validateElement"></div>/**
     * 
     */
    validateElement : function(elem){
        if(!this.isGlobalVal){
            this._validateElem(elem);
        }
    },
    
    validate : function(){
        // 防止重复提交
        if (!this.isGlobalVal) {
            // 寄存所有需要验证的元素
            this.elems = this._getElements();
            // 当前验证的元素下标
            this.currElIdx = -1;
            // 全局错误次数
            this.error = 0;
            // 是否验证中
            this.isGlobalVal = true;
            // 存放元素值
            this.data = {};
            // 预定义参数
            if( this.param )
               $.extend( this.data, this.param );
            
            // 当前验证周期ID
            this.uniqueId = Util.uniqueId();
        
            if(this.decorateTrigger && this.trigger)
                Util.disable(this.trigger, true);
            this._doNextChain();
        }
        return false;
    },
    
    reg : function(cmd, validator) {
        if(!validators)
            validators = {};
        if($.isArray(cmd)){
            for(var i=0,len=cmd.length;i<len;i++){
                this.reg.apply(this, cmd[i]);
            }
        }else validators[cmd] = validator;
        return this;
    },
    
    onsuccess : function(data, finalChain){
        finalChain();
    },

    _getElements : function(){
        return  this.elements || this.form.elements;
    },

    // @private
    _doNextChain : function(){
        // collect pre data here
        // 部份可能无需验证
        var len = this.elems.length;
        
        if(this.currElIdx >= 0 && this.currElIdx < len && !this.error)
            this._collectValue(this.elems[this.currElIdx]);
        
        this.currElIdx++;
        if(this.currElIdx === len){
            if(!this.error){
                if(__debug) console.log('onsuccess', this.data);
                // 返回非false进行表单form提交
                // 返回false表示忽略FORM进行自定义提交（或ajax或其它）...
                // form submit后 nextChain不再生效，进行页面提交
                if( this.onsuccess(this.data, this.nextChain) !== false )
                    this.form.submit();
            // 所有结束并失败后
            } else this._finalChain();
        }else if(this.currElIdx > len){
            // 成功callback调用后的chain
            this._finalChain();
        }else {
            var el = this.elems[this.currElIdx];
            if(el.disabled)
                this._doNextChain();
            else this._validateElem(el, this.nextChain, true);
        }
    },
    
    _validateElem : function(el, callback, multival){
        if($(el).attr('vrel')){
            var chain = new ElememtValidatorChain(this, el);
            // 是否独立验证或者来自FORM验证
            // 如果来自FORM验证，添加引用currentChain到chain
            if(multival){
                chain.multival = true;
                this.currentChain = chain;
            }
            chain.validate(callback);
        }else { callback && callback(); }
    },

    _finalChain : function(){
        this.onfinal();
        this.isGlobalVal = false;
        
        if(this.data)
            delete this.data;
        delete this.currentChain;
        
        if(this.decorateTrigger && this.trigger)
            Util.disable(this.trigger, false);
    },
    
    // 验证通过无错情况下收集表单元素数据
    // @private
    _collectValue : function(elem){
        // 优先应用元素自身的chain.getValue()
        if(this.currentChain && this.currentChain.elem===elem){
            this.data[elem.name] = this.currentChain.getValue();
        }else {
            if (elem.tagName === 'INPUT'){
               if( elem.type === 'radio' || elem.type === 'checkbox' ){
                    if(!elem.checked)
                        return;
               }else if(elem.type === 'submit'){
                    return;
               }
            }
            
            this.data[elem.name] = elem.value;
        }
    },
    
    
    // 从元素中读出相关的验证信息。
    _getBindingValidators : function(elem){
        var cmds,
            jq = $(elem);

        if( this.useCache ){
            if( jq.data('xwb_vd_cmds') ){
                cmds = jq.data('xwb_vd_cmds');
            }else {
                cmds = this.parseCmd(jq.attr('vrel'));
                this._mergeExtraValidators(cmds, elem);
                jq.data('xwb_vd_cmds', cmds);
            }
        }
        else {
            cmds = this.parseCmd(jq.attr('vrel'));
            jq.data('xwb_vd_cmds', cmds);
            this._mergeExtraValidators(cmds, elem);
        }
        return cmds;
    },
    
    // 如已定义元素额外的验证器，合并验证器。
    _mergeExtraValidators : function(cmds, elem){
        // 额外来自Manager针对该元素的验证器
        // 加入到当前集合中
        var extra = this.extraValidators;
        if( extra && extra[elem.name||elem.id] )
            $.merge(cmds, extra[elem.name||elem.id]);
    },
    
    /**
     * 返回一个指令数组，可为指令字符串或数组。预处理保存在返回数组的preCmds属性
     * 为数组时，第一个为指令字符串，第二个为指令数据map结构。
     * 格式为 cmd=k:v,k2:v2|cmd2=k:v,k2:v2 ...
     * 返回数据格式为 [ [name, attr], [name, attr], ...]
     * @private
     */
    parseCmd : function(strRel){
        
        if(!strRel)
            return [];

        var cmds = [], arr = Util.split(strRel, '|'), kd;
        for(var i=0,len=arr.length;i<len;i++){
            // 无属性数据
            if( arr[i].indexOf('=') === -1 ){
                kd = [arr[i],{}];
            }
            // 含属性数据
            else {
                kd = Util.split(arr[i], '=');
                kd[1] = Util.parseKnV(kd[1]);
            }
            // 识别为预处理指令
            if(kd[0].charAt(0) === '_'){
                kd.isPreCmd = true;
                kd[0] = kd[0].substr(1);
            }
            
            cmds[cmds.length] = kd;
        }            
        return cmds;
    },
    
//
//  验证失败与成功处理
//
    errTipName : 'warntip',
    tipTextNode : '#tle',
    // 1 单个提醒, 0 连续提醒
    warnType : 1,
    // html, text, default html
    tipTextType:'',
    okTip   : 'oktip',
    
    <div id="method-Xwb.ax.ValidatorMgr-onerror"></div>/**
     * @implemention
     */ 
    onerror : function(elem, data, chain){
        var tipId = $(elem).attr(this.errTipName);
        if(tipId){
           chain.addError(data.m);
           var jqTip = $(tipId);
           // 是否更新并显示错误提示
           var needed = true;
           if(this.isGlobalVal && chain.error == 1){
                // 可能存在多个验证器共用一个提示元素的情况
                // 必须加以区别
                // 上一个全局验证期，表明当前的状态是否有效
                var previd = jqTip.data('vrel_previd');
                // 当前tip错误次数,如果为０则提示值为当前元素提示。
                var times =  jqTip.data('vrel_errors') || 0;
                if(this.uniqueId != previd){
                    // 验证刚开始，当前tips寄存数据为无效，重置
                    jqTip.data('vrel_previd', this.uniqueId);
                    times = 0;
                }else needed = times == 0;
                // 增加当前tip错误计数
                jqTip.data('vrel_errors', ++times);
           }
           // 当前未占用提示或提示为自身时，可使用提示元素
           if(needed){
               var jqTxt = jqTip.cssDisplay(true)
                           .find(this.tipTextNode);
               var msgs = chain.getErrors();
               
               if(!jqTxt.length)
                    jqTxt = jqTip;
    
               if(this.warnType === 1){
                    if(msgs.length == 1){
                        this.tipTextType==='text'?jqTxt.text(msgs[0]):jqTxt.html(msgs[0]);
                    }
               }else {
                    this.tipTextType==='text'?jqTxt.text(msgs.join('，')):jqTxt.html(msgs.join('，'));
               }
           }
        }
        
        // 出错了，就隐藏oktip
        var okTip = $(elem).attr(this.okTip);
        // 用visiblity是CSS要求占位
        if (okTip){
        	$(okTip).css('visibility', 'hidden');
        }
    },
    
    <div id="method-Xwb.ax.ValidatorMgr-onpass"></div>/**
     * @implemention
     */
    onpass : function(elem, chain){
        var tipId = $(elem).attr(this.errTipName);
        var needed = true;
        if(tipId){
            var jqTip = $(tipId);
            // 可能存在多个验证器共用一个提示元素的情况
            // 必须加以区别
            if(this.isGlobalVal){
                // 当前tip错误次数,如果为０则提示值为当前元素提示。
                var times = jqTip.data('vrel_errors');
                needed = !times;
            }
            if(needed){
                jqTip.cssDisplay(false);
            }
        }
        
    	var okTip = $(elem).attr(this.okTip);
    	if (okTip)
    		$(okTip).css('visibility', '');
    }
};

X.reg('Validator', X.ax.Validator);

})();
(function(X, $){

var Util = X.util;
var undefined;
var T = X.Tpl;
var doc = document;
    
// hidden style class
var hidCls   = 'hidden';
var jqWin = $(window);
var jqDoc = $(doc);
<div id="cls-Xwb.ui"></div>/**
 * @class Xwb.ui
 */
var ui   = X.ui = {
    Base : Util.create()
};

var Base = ui.Base;

<div id="cls-Xwb.ui.Base"></div>/**
 * UI基类
 * @class Xwb.ui.Base
 * @constructor
 * @param {Object} config  该配置信息将被完全地复制到当前实例中，并会覆盖相同属性名的默认值。
 */
<div id="cfg-Xwb.ui.Base-closeable"></div>/**
 * @cfg {Boolean} closeable
 * 指示控件是否可关闭，可关闭的控件上存在一个{@link #clsNode}结点，
 * 当点击该元素时关闭控件，这过程由控件实现。
 */

<div id="cfg-Xwb.ui.Base-titleNode"></div>/**
 * @cfg {String} titleNode 标题结点选择器，如果控件存在“标题”，
 * 调用{@link #setTitle}方法时会用标题结点选择器获得标题结点，
 * 并在该结点上打印标题。默认值为"#xwb_title"
 */

<div id="cfg-Xwb.ui.Base-clsNode"></div>/**
 * @cfg {String} clsNode
 * 用该选择器查找关闭事件触发结点。默认值为"#xwb_cls"
 */
 
<div id="cfg-Xwb.ui.Base-onViewReady"></div>/**
 * @cfg {Function} onViewReady
 * 这是个接口方法，当控件html元素生成后回调该接口，参数传递控件html元素。
 
* <pre><code>
    {
        onViewReady : function(viewElement){
            alert(viewElement.tagName);
        }
    }
 </code></pre>

 */
 
<div id="cfg-Xwb.ui.Base-title"></div>/**
 * @cfg {String} title 存在标题值时，控件初始化时会调用{@link #setTitle}方法输出标题
 */

<div id="cfg-Xwb.ui.Base-view"></div>/**
 * @cfg {String|HTMLElement|HtmlTemplate} view
 * 指定控件生成html视图的模板，它可以是一段HTML字符串，也可以是HTML模板名称，也可为一个html元素。<br/>
 * 如果view来自字符串模板，将调用{@link Xwb.Tpl.parse}方法解析模板。<br/>
 * 如果未指定{@link #tplData}数据，将控件自身数据作为模板解析的key->value数据。
 */
 
<div id="cfg-Xwb.ui.Base-actionMgr"></div>/**
 * @cfg {Boolean} actionMgr
 * 指示是否启用{@link Xwb.ax.ActionMgr}动作处理，
 * 初始化后actionMgr属性指向实例化的{@link Xwb.ax.ActionMgr}类实例。
 */
<div id="cfg-Xwb.ui.Base-onactiontrig"></div>/**
 * @cfg {Function} onactiontrig 接口方法，开始{@link #actionMgr}后，可实现该接口统一处理来自{@link #actionMgr}实例的各种动作
 
* <pre><code>
    {
        actionMgr : true,
        onactiontrig : function(act){
            switch(act.data.e){
                case 'sd' :
                // do something
                break;
                // ...
            }
        }
    }
 </code></pre>

 */
 
<div id="cfg-Xwb.ui.Base-destroyOnClose"></div>/**
 * @cfg {Boolean} destroyOnClose 当关闭控件时，
 * 是否销毁({@link #destroy})控件，否则只隐藏控件。默认值false，只隐藏。
 */

<div id="cfg-Xwb.ui.Base-onclose"></div>/**
 * @cfg {Function} onclose 接口方法，关闭控件({@link #close})时，将回调该方法，如果方法返回false值取消关闭
 */

<div id="cfg-Xwb.ui.Base-contexted"></div>/**
 * @cfg {Boolean} contexted 指示控件显示后是否具有“内外切换”类菜单的效果。“内外切换”即点击控件内部区域时一切正常，但点击非控件区域时就关闭控件。
 */

<div id="cfg-Xwb.ui.Base-hidden"></div>/**
 * @cfg {Boolean} hidden 初始化时是否显示控件，默认显示
 */
 
<div id="cfg-Xwb.ui.Base-autoRender"></div>/**
 * @cfg {Boolean} autoRender
 * 指示是否在类初始化时生成视图元素，默认false，按需才生成。<br/>
 * 如果该项为false，即控件在初始化后，并未立即生成视图结点，触发{@link #onViewReady}回调，
 * 而是直至直接或间接调用{@link #getView}方法后生成，即按需时才生成HTML视图。<br/>
 * 如果未生成视图结点，{@link #onViewReady}方法是不会触发的，
 * 但有时候需要提前生成，此时就可以设置该项为true，即在初始化时就生成HTML视图，
 * 从而触发{@link #onViewReady}。
 */

<div id="prop-Xwb.ui.Base-cacheId"></div>/**
 * @property cacheId
 * 控件全局唯一ID
 * @type String
 */
 
// 该方法会覆盖原有getView()当view结点生成后。
function getReadyView(){
    return this.view;
}

ui.Base.prototype = {
        
        autoRender : false,
        
        titleNode : '#xwb_title',
        
        // 类初始化入口
        init : function(opt){
            this.cacheId = 'c' + Util.uniqueId();
            opt && $.extend(this, opt);
            // UI初始化入口
            this.initUI();
            
            if(this.autoRender)
                this.getView();
        },
        
        // 接口方法
        initUI : $.noop,
        
        clsNode : '#xwb_cls',
        
        // 绑定关闭事件
        initClsBehave : function(cls){
            this.jq(this.clsNode).click(Util.bind(this.onClsBtnClick, this));
            this.setCloseable(cls);
        },
        
        <div id="method-Xwb.ui.Base-setCloseable"></div>/**
         *  设置是否可关闭
         * @param {Boolean} closable
         */
        setCloseable : function(cls){
            $(this.clsNode).cssDisplay(cls);
            this.closeable = cls;
        },
        
        onClsBtnClick : function(){
            this.close(true);
            return false;
        },
<div id="method-Xwb.ui.Base-close"></div>/**
 * 关闭控件，关闭前触发{@link #onclose}回调，如果开始{@link #destroyOnClose}，关闭后销毁({@link #destroy})该控件
 */
        close : function(){
            if(!this.onclose || this.onclose() !== false){
                if(this.destroyOnClose)
                    this.destroy();
                else this.display(false);
            }
        },
<div id="cfg-Xwb.ui.Base-tplData"></div>/**
 *  @cfg {Object} tplData 默认控件的模板数据来自控件自身，也可以通过该属性重定义模板数据
 */
        tplData : false,
        
/**
 * 由html创建或选择器定位UI图视结点
 * @private
 */
        createView : function(){
            var v = this.view;
            if(typeof v === 'string'){
                v = this.view = T.forNode(T[v], this.tplData || this, true);
            }else this.view = v = doc.createElement('DIV');
            return v;
        },
        
/**
 * 子类应重载该方法替代onViewReady
 * @private
 */
        innerViewReady : $.noop,

<div id="method-Xwb.ui.Base-setTitle"></div>/**
 * 设置控件标题。
 * 查找标题所在结点参见{@link #titleNode}配置。
 * @param {String} title
 * @return this
 */
        setTitle : function(tle){
            this.jq(this.titleNode).html(tle);
            return this;
        },
        
    <div id="method-Xwb.ui.Base-getView"></div>/**
     * 获得窗口视图DOM结点，如果结点未创建，立即创建并返回结点，创建后触发{@link #onViewReady}接口回调。
     * 子类不能重写该方法。
     * @return {HTMLElement}
     */ 
        getView : function(){
          var v = this.view;
          
          // 未创建
          if(!v || !v.tagName)
            v = this.createView();

          // 重写，下载调用时就直接返回结点
          this.getView = getReadyView;
          
          if(this.appendTo){
              $(this.appendTo).append(v);
              delete this.appendTo;
          }
          
          if(this.closeable !== undefined)
              this.initClsBehave(this.closeable);

          if(this.actionMgr){
              this.actionMgr = X.use('ActionMgr', this.actionMgr);
              this.actionMgr.bind( v );
              if(this.onactiontrig){
                  var self = this;
                  this.actionMgr.addFilter(function(e){
                      return self.onactiontrig(e);
                  });
              }
          }
          
          // interval method
          this.innerViewReady(v);
          
          // config method，回调接口方法
          this.onViewReady && this.onViewReady(v);
          
          // 将display放到onViewReady之后，
          // 正常执行
          if(this.hidden !== undefined){
              var tmp = this.hidden;
              this.hidden = undefined;
              this.display(!tmp);
          }
          return v;
        },

<div id="cfg-Xwb.ui.Base-beforeShow"></div>/**
 * @cfg {Function} beforeShow 接口方法，在控件显示前回调，如果子类实现该方法，请确保调用回父类方法。<br/>
 * 回调方法时，视图状态已是 visibility:'hidden', display:true，所以如果视图已在DOM上，控件在DOM流上占位，
 * 可以正确获得控件宽高和位置等等信息。
 */
        beforeShow : $.noop,
<div id="cfg-Xwb.ui.Base-afterShow"></div>/**
 * @cfg {Function} afterShow 接口方法，控件显示后回调，如果子类实现该方法，请确保调用回父类方法
 */
        afterShow  : $.noop,

<div id="cfg-Xwb.ui.Base-beforeHide"></div>/**
 * @cfg {Function} beforeHide 接口方法，控件隐藏前回调，如果子类实现该方法，请确保调用回父类方法
 */
        beforeHide : $.noop,

<div id="method-Xwb.ui.Base-jqExtra"></div>/**
 * 以通用JavaScript变量命名风格生成ID元素对应的jq对象。
 * 如 
* <pre><code>
     this.jqExtra('inputor', 'title');
     alert( this.jqInputor );
     alert( this.jqTitle );
 </code></pre>
 * @param {Array} args 参数列表，它并不是一个数组，而是可变参数列表，如 jqExtra('a','b','c',...)
 * @return this
 */
        jqExtra : function(ids){
            for(var args = arguments,i=0,len=args.length;i<len;i++){
                var k    = args[i];
                var jqEl = this.jq('#'+k);
                if( jqEl ){
                    // 首字母大写
                    k = k.charAt(0).toUpperCase() + k.substring(1);
                    this['jq'+k] = jqEl;
                }
            }
            return this;
        },
<div id="method-Xwb.ui.Base-display"></div>/**
 * 显示/隐藏或获得UI的显示或隐藏属性
 * @param {Object} show
 * @return this
 */
        display : function(b){
            var j = this.jq();

            if(b === undefined)
                return !j.hasClass(hidCls);
            b = !b;
            if(this.hidden !== b){
                if(!b) {
                    this.hidden = b;
                    j.css('visibility', 'hidden').removeClass(hidCls);
                    this.beforeShow();
                    j.css('visibility', '');
                    if( this.contextable && !this.contexted)
                        this.setContexted(true);

                    this.afterShow();
                }else {
                    if(this.beforeHide() !== false){
                        this.hidden = b;
                        j.addClass(hidCls);
                        this.afterHide && this.afterHide();
                        // release contexted on hide
                        if(this.contexted)
                           this.setContexted(false);
                    }
                }
            }
			return this;
        },
        
        onContextRelease : function(){
            this.display(false);    
        },
<div id="method-Xwb.ui.Base-appendAt"></div>/**
 * 控件视图追加到在指定jQuery对象中
 * @param {jQuery} jQuery对象
 */
        appendAt : function(a){
            $(a).append(this.getView());
            return this;
        },
        
    <div id="method-Xwb.ui.Base-ancestorOf"></div>/**
     * 是否包含某元素
     * @param {Xwb.ui.Base|HTMLElement} target
     * @param {Number} [depth] 搜索深度
     */
        ancestorOf :function(a, depth){
          a = a.view || a;
          return Util.ancestorOf(this.view, a, depth);
        },
<div id="method-Xwb.ui.Base-jq"></div>/**
 * 获得控件或控件子元素的jQuery对象
 * @param {jQuery} selector jQuery选择器，未设置时返回控件视图的jQuery对象
 * @return {jQuery}
 */
        jq : function(selector){
            return selector === undefined ? $(this.getView()) : $(this.getView()).find(selector);
        },
<div id="method-Xwb.ui.Base-destroy"></div>/**
 * 销毁控件，将视图从DOM上移除
 */
        destroy : function(){
            this.display(false);
            this.jq().remove();
        },

<div id="method-Xwb.ui.Base-domEvent"></div>/**
 * 添加DOM事件处理，大部份事件可直接调用jQuery方法处理，但mousedown是例外的，如果想监听mousedown事件，请调用本方法进行绑定。<br/>
 * 为什么mousedown事件是例外的？参见{@link Xwb.ax.contextMgr}
 * @param {String} eventName
 * @param {Function} handler
 * @param {String|HTMLElement} [childElementToBind] 如果指定该项，事件将绑定到该项元素上
 */
        domEvent : function(evt, fn, child){
            if(evt === 'mousedown'){
                var comp = this;
                var wrapper = function(e){
    	           	if(!comp.contexted)
    					X.use('contextMgr').releaseAll(e);
    			    fn.apply(comp, arguments);
                };
                
                if(!this._mousedownFns)
                    this._mousedownFns = {};
                this._mousedownFns[fn] = wrapper;
                
                this.jq(child).bind(evt, wrapper);
            }else this.jq(child).bind(evt, fn);
        },
<div id="method-Xwb.ui.Base-移除DOM事件处理"></div>/***
 *  移除由{@link #domEvent}绑定的事件
 * @param {String} eventName
 * @param {Function} handler
 * @param {String|HTMLElement} [childElementToBind]
 */
        // 移除DOM事件处理
        unDomEvent : function(evt, fn, child){
            if(evt === 'mousedown'){
                var wrapper = this._mousedownFns[fn];
                this.jq(child).unbind(evt, wrapper);
                delete this._mousedownFns[fn];
            }else this.jq(child).unbind(evt, fn);
        },
     
        <div id="method-Xwb.ui.Base-setContexted"></div>/**
         * 添加上下文切换效果,当点击控件区域以外的地方时隐藏控件。
         * @see #onContextRelease
         * @return {Xwb.ui.Base} this
         */
        setContexted : function(set){
        	if(this.contexted !== set)
        		set ? X.use('contextMgr').context(this) : 
        		      X.use('contextMgr').release(this);
        	return this;
        },
        <div id="method-Xwb.ui.Base-templ"></div>/**
         * 批量对子元素应用innerHTML
         * @param {Object} childSelectorHtmlMap 结点为{childSelector:strHtml}
         
        * <pre><code>
            var data = {
                '#text_a':'字符串A',
                '#text_b':'字符串B',
                '#text_c':'字符串C'
            };
         </code></pre>

         */
        templ : function(obj){
            for(var selector in obj){
                this.jq(selector).html(obj[selector]);
            }
            return this;
        },
		
		offset : function(){
			if(arguments.length){
				this.jq().css(arguments[0]);
				return this;
			}
			return this.jq().offset();
		},
		
    <div id="method-Xwb.ui.Base-offsetsTo"></div>/**
     * 得到相对位移
     * @param {DOMElement|jQuery} offsetToTarget
     * @return [offsetX, offsetY]
     */
        offsetsTo : function(tar){
            var o = this.jq().offset(),
                e = $(tar).offset();
            return [o.left-e.left,o.top-e.top];
        },
    
		// pa:t,b,c, pb:l,c,r
		<div id="method-Xwb.ui.Base-anchor"></div>/**
		 * 定位控件到指定元素边沿。<br/>
		 * 定位方位分为上，中，下，左，右，用字母分别表达t,c,b,l,r。<br/>
		 * 计算顺序为：上中下
        * <pre><code>
            // 将控件定位于元素的上方并居中
            component.anchor(anchorElement, 'lc');
         </code></pre>
         * 例子可参见demo/anchor.html
		 * @param {HTMLElement|jQuery} anchorElement 作为锚点的元素
		 * @param {String} direction 对齐方向，上下，左右与中间的结合，上下：t,b；左右l,r，中间c
		 * @param {Function} [prehandler] 计算出对齐数据后至应用数据前可通过该方法对数据进行二次处理
		 * @param {Boolean} [restrictIntoView] 如果控件超出可视区域，是否调整到可视区域内
		 */
		anchor : function(targetEl, pos, prehandler, intoView){
		    var jqT  = $(targetEl), jq = this.jq();
		    var toff = jqT.offset(),
		        tw   = jqT.width(),
		        th   = jqT.height(),
		        sw   = jq.width(),
		        sh   = jq.height();
		    var pa = pos.charAt(0), pb = pos.charAt(1);

		    var l = toff.left, t = toff.top;
		    switch(pa){
		        case 't' :
		            t-=sh;
		        break;
		        case 'b':
		            t+=th;
		        break;
		        case 'c':
		            t+= Math.floor((th-sh)/2);
		        break;
		    }
		    
		    switch(pb){
		        case 'c' :
		            l+= Math.floor((tw-sw)/2);
		        break;
		        case 'r':
		            l+=tw-sw;
		        break;
		    }
		    
		    if(prehandler){
		        var ret = ret = [l, t];
		        prehandler(ret, sw, sh);
		        l = ret[0];
		        t = ret[1];
		    }
		    // 限制宽在可见范围内
		    if(intoView){
		        if(t<0) t=0;
		        else {
    		        var vph = jqWin.height();
    		        if(t+sh-jqDoc.scrollTop()>vph){
    		            t = vph-sh+jqDoc.scrollTop();
    		        }
		        }
		        if(l<0)
		            l=0;
		        else {
    		        var vpw = jqWin.width();
    		        if(l+sw-jqDoc.scrollLeft()>vpw){
    		            l = vpw-sw+jqDoc.scrollLeft();
    		        }
		        }
		    }
		    
		    jq.css('left', l+'px')
		      .css('top', t+'px');
		},
		<div id="method-Xwb.ui.Base-center"></div>/**
		 * 控件相对当前文档视图居中
		 */
        center : function(){
          var jq  = this.jq(),
              sz  = [jqWin.width(), jqWin.height()],
              dsz = [jq.width(), jq.height()],
              off = (sz[1] - dsz[1]) * 0.8;
          this.view.style.left = Math.max((((sz[0] - dsz[0]) / 2) | 0), 0) + jqDoc.scrollLeft() + 'px';
          this.view.style.top  = Math.max(off - off/2|0, 0)+jqDoc.scrollTop() + 'px';
          return this;
        },
        
        // 调用前设置view, visibility:hidden, display:NOT HIDDEN
        // clip后wrapper是visiblity隐藏的
        <div id="method-Xwb.ui.Base-clip"></div>/**
         * 控件视图从当前DOM父元素脱离，外包一层DIV元素，绝对定位置于document.body层，但控件的位置长度保持不变。<br/>
         * 控件视图只能在外包DIV层内活动，DIV层display:hidden，所以超出DIV层控件视图部份将被剪切。<br/>
         * 该函数主要作用是，方便相对外包DIV层内控制控件的位置，使得控件滑动时具有剪切效果。
         */
        clip : function(){
            if(!Base.CLIP_WRAPPER_CSS){
                Base.CLIP_WRAPPER_CSS = {
                    position:'absolute',
                    clear : 'both',
                    overflow:'hidden'
                };
                Base.CLIPPER_CSS = {
                    position:'absolute',
                    left:0,
                    top:0
                };
            }
            // 防止多次调用时产生多层包裹
            if(!this.jqClipWrapper){
                var jqWrap = $(Util.Cache.get('div')),
                    v      = this.getView(),
                    jq     = this.jq(),
                    pNode  = v.parentNode,
                    voff   = jq.offset();
                    
                jqWrap.css(Base.CLIP_WRAPPER_CSS)
                      .css(voff)
                      .css('width', jq.width()+'px')
                      .css('height', jq.height()+'px')
                      .css('z-index', jq.css('z-index'))
                      .append(v);
    
                // 保存状态，clip结束恢复
                var tmpCps = this._tmpClipedCss = {};
                for(var k in Base.CLIPPER_CSS){
                    tmpCps[k] = v.style[k];
                }
                jq.css(Base.CLIPPER_CSS);
                
                pNode && jqWrap.appendTo(pNode);
                this.jqClipWrapper = jqWrap;
            }
            return this.jqClipWrapper;
        },
        <div id="method-Xwb.ui.Base-unclip"></div>/**
         *  恢复{@link #clip}前控件状态
         */
        unclip : function(){
            if(this.jqClipWrapper){
                var wr = this.jqClipWrapper[0],
                    wrst = wr.style,
                    jq = this.jq(),
                    st = jq[0].style;
                
                for(var k in Base.CLIP_WRAPPER_CSS)
                    wrst[k] = '';
    
                this.jqClipWrapper
                    .css('overflow','')
                    .css('width','')
                    .css('height','');
                
                var tmpCps = this._tmpClipedCss;
                for(k in tmpCps)
                    st[k] = tmpCps[k];
                delete this._tmpClipedCss;
                
                wr.removeChild(jq[0]);
                if(wr.parentNode)
                    this.jqClipWrapper.replaceWith(jq);
                Util.Cache.put('div', wr);
                delete this.jqClipWrapper;
           }
        },
        
        <div id="method-Xwb.ui.Base-slide"></div>/**
         * 滑动显示或隐藏。<br/>
         * 如果是隐藏，调用前要设置控件的visiblity:hidden,display:NOT HIDDEN样式。
         * @param {String} fromTo l,r,t,b|l,r,t,b，两位字母表示
         * @param {Boolean} visible 显示或隐藏
         * @param {Function} [callback]
         * @param {Object} [props] jquery动画配置
         * @param {Object} [duration]
         * @param {Function} [easing]
         */
        slide : function(fromto, show, fn, props, duration, easing){
            var jq = this.jq(),
                l  = 0, t  = 0,
                w  = jq.width(),
                h  = jq.height(),
                fl = l,ft = t,tl = l,tt = t,
                jqWr = this.clip();
            var from = fromto.charAt(0), 
                to = fromto.charAt(1);
            switch(from){
                case 'l' :
                    fl = l-w;
                break;
                case 'r':
                    fl = l+w;
                break;
                case 't':
                    ft=t-h;
                break;
                case 'b':
                    ft=t+h;
                break;
            }
            
            switch(to){
                case 'l' :
                    tl = l-w;
                break;
                case 'r':
                    tl = l+w;
                break;
                case 't':
                    tt=t-h;
                break;
                case 'b':
                    tt=t+h;
                break;
            }
            jq.css('left',fl)
              .css('top',ft);
            if(!props) props = {};
            if(tl!=fl){
                props.left = props.left === undefined?tl:props.left + tl;
            }
            if(tt!=ft){
                props.top  = props.top===undefined?tt:props.top+tt;
            }
            if(show)
                jq.css('visibility','');
            var self = this;
            jq.animate(props, duration||'fast', easing , function(){
                if(!show){
                    self.display(false);
                    jq.css('visibility', '');
                }
                setTimeout(function(){
                    self.unclip();
                    fn && fn(self);
                }, 0);
            });
        }
};

X.reg('base', Base);


})(Xwb, $);
Xwb.reg('contextMgr', function(){
    
    var X = Xwb;
    var Util = X.util;
    var doc  = document;
    
    var contextMgr = {
    
    	context : function(comp){
    
    		if(comp.contexted)
    			this.release(comp);
    
    		var q = this.q;
    		if(!q)
    			this.q = q = [];
    
    	    if(!q.length)
    	        $(doc).mousedown(this._getDocEvtHandler());
    	  
    	    q[q.length] = comp;
    	  
    	    this._setCompEvtHandler(comp, true);
    	    comp.contexted = true;
    	    if(__debug) console.log('contexted', comp);
    	},
    	
    	release : function(comp, e){
    		comp.contexted = false;
    		if( comp.onContextRelease(e) !== false ) {
        		this._setCompEvtHandler(comp, false);
        		Util.arrayRemove(this.q, comp);
    			if(!this.q.length)
    			    $(doc).unbind('mousedown', this._getDocEvtHandler());
    		} else comp.contexted = true;
    		
    		if(__debug) console.log('release context', comp);
    	},
    <div id="method-Xwb.ui.Base-releaseAll"></div>/**
     * 释放所有已上下文绑定的控件，释放对于传递事件event由控件自身或控件子结点发出控件无效。
     * @param {DOMEvent} [event] 如果释放由DOM事件引发，传递该事件，如果事件由控件发出，包括子结点，则取消释放该控件。
     * @inner
     */
    	releaseAll : function(e){
    		var q = this.q;
    		if (q) {
    			var len = q.length;
    			if(e)
    			    var src = e.target;
    			for (var s = len - 1; s >= 0; s--) {
    				if(!src || !q[s].ancestorOf(src))
    				    this.release(q[s], e);
    			}
    		}
    	},
    	
    	_setCompEvtHandler : function(comp, set){
    		set ? comp.domEvent('mousedown', this._compEvtStopHandler)
    		    : comp.unDomEvent('mousedown', this._compEvtHandler);
    	},
    	
    	_getDocEvtHandler : function(){
    		 var hd = this.docEvtHd;
    		 if(!hd)
    		 	hd = this.docEvtHd = Util.bind(this._docHandler, this);
    		 return hd;
    	},
    
    	_releaseFollower : function(curr, e){
    		var q = this.q;
    		if(q){
    			var last = q.length - 1;
    			// not the last one itself
    			if(last !== -1 && q[last] !== curr){
    				var len = last;
    				for(;last>=0;last--){
    					if(q[last] === curr)
    						break;
    				  this.release(q[last], e);
    				}
    		  }
    		}
    	},
    	
    	// component mouse down handler & stop event
    	// scope : component	
    	_compEvtStopHandler : function(e){
    	    contextMgr._releaseFollower(this, e);
            return false;
        },
        
    	// component mouse down handler
    	// scope : component
    	_compEvtHandler : function(e){
    		// cancel 后来者
    		contextMgr._releaseFollower(this, e);
    	},
    	
    	// document mouse down handler
    	_docHandler : function(e){
    		this.releaseAll(e);
    	}
    };
    
    X.ax.contextMgr = contextMgr;
    X.reg('contextMgr', contextMgr, true);
    
    return contextMgr;
});
(function(X, $){

var Util = X.util;
var undefined;
var T = X.Tpl;
var doc = document;
var Base = X.ui.Base;
var ui = X.ui;
// 记录弹出浮层zIndex
var currentZ = 10001;
var jqWin = $(window);

var PopupKBMonitor = {
	
	layers : [],
	
	hash : {},
	
	keyListeners : 0,
	
	add : function(layer){
		var cid = layer.cacheId;
		if(!this.hash[cid]){
			this.layers.push(layer);
			if(layer.keyEvent){
				if(this.keyListeners === 0){
					if(__debug) console.log('bind key listener');
					$(doc).bind('keydown', this.getEvtHandler());
				}
				this.keyListeners++;
			}
			this.hash[cid] = true;
	  }
	},
	
	remove : function(layer){
		var cid = layer.cacheId;
		if(this.hash[cid]){
			var ly = this.layers;
			if(ly[ly.length - 1] === layer)
				ly.pop();
		  else Util.arrayRemove(ly, layer);
			
			this.keyListeners--;
			if(this.keyListeners===0){
				if(__debug) console.log('remove key listener');
				$(doc).unbind('keydown', this.getEvtHandler());
			}
			delete this.hash[cid];
	  }
	},
	
	getEvtHandler : function(){
		  var kh = this._onDocKeydown;
		  if( !kh )
		  	kh = this._onDocKeydown = Util.bind( this.onDocKeydown, this );
		  return kh;
	},
	
	onDocKeydown : function(e){
			var top = this.layers[this.layers.length-1];
			if(top && top.keyEvent)
				return top.onKeydown(e);
	}
};

<div id="cls-Xwb.ui.Layer"></div>/**
 * @class Xwb.ui.Layer
 * 浮层基类。<br/>
 * 所有浮层不用设置zIndex值，均由库自行管理。
 * 如有需要，可通过{@link #setCurrentZ}均始化zIndex值。
 * @extends Xwb.ui.Base
 */

var Layer = ui.Layer = Util.create(Base, {
    
    <div id="cfg-Xwb.ui.Layer-autoCenter"></div>/**@cfg {Boolean} autoCenter 当显示或显示后窗口resize时，是否自动居中*/
    
    <div id="cfg-Xwb.ui.Layer-hidden"></div>/**@cfg {Boolean} hidden 默认隐藏*/
    hidden : true,
    
    onViewReady : $.noop,
    
    <div id="cfg-Xwb.ui.Layer-显示时是否应用IFRAME层作遮罩层，IE6时默认为true，其它浏览器默认false"></div>/**
     * @cfg {Boolean} 显示时是否应用IFRAME层作遮罩层，IE6时默认为true，其它浏览器默认false
     */
    frameMask : $.browser.msie && $.trim($.browser.version) == "6.0",
    
<div id="method-Xwb.ui.Layer-trackZIndex"></div>/**
 * 手动更新窗口zindex，默认是自动更新。
 * 当同时显示多个窗口时,调用该方法可使窗口置顶。
 * 适用于position:absolute, fixed面板。
 * @see Xwb.ui.Layer#setCurrentZ
 */
    trackZIndex : function(){
      if(this.z !== currentZ){
         currentZ += 3;

        if(this.mask)
            $(this.mask).css('z-index', currentZ - 1);
        
        if(this.frameMask)
            $(this.getFrameMask()).css('z-index', currentZ - 2);
        
        this.jq().css('z-index', currentZ);
        this.z = currentZ;
      }
    },
    
    <div id="cfg-Xwb.ui.Layer-是否开启键盘监听，默认true，将处理ESC键。"></div>/**
     * @cfg {Boolean} 是否开启键盘监听，默认true，将处理ESC键。
     */
    keyEvent : true,
    
    <div id="method-Xwb.ui.Layer-onKeydown"></div>/**
     * 如果监听浮层按键事件，可重写本方法。默认处理是监听ESC键，当ESC按下时关闭浮层。
     * @param {DOMEvent} event
     */
    onKeydown : function(e){
    	// esc
    	if(e.keyCode === 27 && !this.cancelEscKeyEvent){
    		this.close();
    		return false;
    	}
    },
    
    // override
    beforeShow : function(){
        if(this.mask)
            this._applyMask(true);
        var pos = this.jq().css('position');
        if( pos === 'absolute' || pos === 'fixed' )
            this.trackZIndex();
        PopupKBMonitor.add(this);
        
        if(this.autoCenter)
            this.center();
    },
    
    
    // override
    afterHide : function(){
        if(this.mask)
            this._applyMask(false);
        PopupKBMonitor.remove(this);
    },
	
	getFrameMask : function(){
	    if(this.frameMaskEl)
	        return this.frameMaskEl;
	    // 因为iframe层比较特殊，较少变动，所以直接写在这里而不必JS HTML模板里。
	    this.frameMaskEl = T.forNode('<iframe class="shade-div shade-iframe" frameborder="0"></iframe>');
	    return this.frameMaskEl;
	},
    <div id="cfg-Xwb.ui.Layer-mask"></div>/**
     * @cfg {Boolean} mask 显示时是否应用遮罩层，默认false
     */
    _applyMask : function(b){
      var mask = this.mask;
      if(!mask || mask === true)
        mask = this.mask = T.forNode(T.Mask);
      
      var wh = jqWin.height();
      if(b){
        $(mask)
            .height( wh )
            .appendTo(doc.body);
        if(this.frameMask)
            $(this.getFrameMask()).height(wh).appendTo(doc.body);
        // window resize event handler
        $(window).bind('resize', Util.getBind(this, 'onMaskWinResize'));
      }else {
        $(mask).remove();
        if(this.frameMask)
            $(this.getFrameMask()).remove();
        $(window).unbind('resize', Util.getBind(this, 'onMaskWinResize'));
      }
    },
    
    onMaskWinResize : function(){
      var mask = this.mask, wh = jqWin.height();
      if(mask)
        $(mask).height( wh );
        
        if(this.frameMask)
            $(this.getFrameMask()).height(wh);
      
      if(this.autoCenter)
            this.center();
    }
});
<div id="method-Xwb.ui.Layer-setCurrentZ"></div>/**
 * @param {Number} zIndex
 * @method setCurrentZ
 * @static
 */
Layer.setCurrentZ = function(z){
    currentZ = z;
};

<div id="prop-Xwb.ui.Layer-layer"></div>/**
 * @property layer
 * @member Xwb.Types
 */
X.reg('Layer', Layer);

<div id="cls-Xwb.ui.Switcher"></div>/**
 * @class Xwb.ui.Switcher
 * @constructor
 * @param {Object} config
 */

<div id="cfg-Xwb.ui.Switcher-items"></div>/**
 * @cfg {DOMCollection|jQuery} items tab items
 */

<div id="cfg-Xwb.ui.Switcher-contents"></div>/**
 * @cfg {DOMCollection|jQuery} contents tab contents
 */

<div id="cfg-Xwb.ui.Switcher-autoRecover"></div>/**
 * @cfg {Boolean} autoRecover 当鼠标离开时是否自动复原
 */

<div id="cfg-Xwb.ui.Switcher-delaySelect"></div>/**
 * @cfg {Boolean} delaySelect 在{@link #trigMode}为hover情况下鼠标划过时延迟选择，单位ms，默认不延迟
 */

<div id="cfg-Xwb.ui.Switcher-delayHide"></div>/**
 * @cfg {Boolean} delayHide
 */

<div id="cfg-Xwb.ui.Switcher-trigMode"></div>/**
 * @cfg {String} trigMode click，hover，默认click，点击时才触发选择，如果设为hover时，鼠标移上就会触发。
 */

<div id="cfg-Xwb.ui.Switcher-clickEvent"></div>/**
 * @cfg {String} clickEvent 如果触发选择的方式为'click'，设置选择触发事件，默认为mousedown，可以改为'click'事件。
 */

<div id="cfg-Xwb.ui.Switcher-onselect"></div>/**
 * @cfg {Function} onselect 选择项时触发。onselect(selectedItem)，仍可以通过 switcher.selectedItem访问上一个选择项。
 */
ui.Switcher = function(opt){
	opt && $.extend(this, opt);
	this.initUI();
};

<div id="prop-Xwb.ui.Switcher-switcher"></div>/**
 * @property switcher
 * @member Xwb.Types
 */
X.reg('Switcher', ui.Switcher);

ui.Switcher.prototype = {
	trigMode : 'click',
	initUI : function(){
		if (this.items)
			this.add(this.items, this.contents);
	},
<div id="method-Xwb.ui.Switcher-select"></div>/**
 * @param {HTMLElement} item
 */
	select : function(item){

        var pre = this.selectedItem;
		
		if (this.autoRecover)
            this.clearTimer(1);
        
        //先显示当前项再隐藏先前的,使得过渡平滑,而不造成闪烁
        if(this.selectedCS){
            pre && $(pre).removeClass(this.selectedCS);
			$(item).addClass(this.selectedCS);
		}

		// select callback
		this.onselect && this.onselect(item);
		
        this.selectedItem = item;
		
		if (item.contentEl) {
            var cp = item.contentEl;
            // 把显示延迟至上一次界面更新之后,
			// 可保持用户操作流畅响应
			// 如果不需要这效果，可直接调用unselect(pre)
            setTimeout( function(){
                if (pre && pre.contentEl)
                    $(pre.contentEl).cssDisplay(false);
                $(cp).cssDisplay(true);
            }, 0 );
        }
	},

<div id="method-Xwb.ui.Switcher-unselect"></div>/**
 * @param {HTMLElement} item
 */	
	unselect : function(item){
        if(this.selectedCS)
            $(item).removeClass(this.selectedCS);
        
        if(item.contentEl)
            $(item.contentEl).cssDisplay(false);
		
		if(this.mouseoutTimer)
		    this.clearTimer(1);
	
        this.selectedItem = NULL;
	},
	
	// private , type=0, mouseover; 1, mouseout
	clearTimer : function(type){
		if (type !== 0) {
			if (this.mouseoutTimer) {
				clearTimeout(this.mouseoutTimer);
				this.mouseoutTimer = false;
				this.mouseoutTimerFn = false;
			}
		}else {
			if (this.mouseoverTimer) {
				clearTimeout(this.mouseoverTimer);
				this.mouseoverTimer = false;
				this.mouseoverTimerFn = false;
			}
		}
	},
<div id="method-Xwb.ui.Switcher-add"></div>/**
 * @param {HTMLElement|Array} item
 * @param {HTMLElement|Array} panel
 */
    add: function(item, panel){
		if(item.length){
		    if(panel){
			    for(var i=0,len=item.length;i<len;i++)
				    this.add(item[i], panel[i]);
		    }else for(var i=0,len=item.length;i<len;i++)
				    this.add(item[i]);
			return;
		}
		
		var jq = $(item);
        var switcher = this;
		
		// 在录入时已标记选择
        if(jq.hasClass(this.selectedCS)){
            if(this.selectedItem)
                this.unselect();
            this.selectedItem = item;
        }
        
		if(panel) 
		    item.contentEl = panel;
		
		// install hover event handler
        if (this.trigMode === 'hover' || this.autoRecover) {
			jq.hover(	// mouse over
			function(e){
				if (switcher.autoRecover && switcher.mouseoutTimer) {
					switcher.clearTimeout(1);
				}
				
				// trig mode
				if (switcher.trigMode === 'hover') {
					var pre = switcher.selectedItem;
					if (this !== pre) {
						if (switcher.delaySelect) {
							// 重置定时
							if (switcher.mouseoverTimer) 
								switcher.clearTimeout(0);
							switcher.mouseoverTimer = setTimeout(function(){
								switcher.select(item);
							}, switcher.delaySelect);
						}
						else 
							switcher.select(this);
					}
				}
				
				return !switcher.enableBubble;
			}, 
			// mouse out
			function(e){
			
				if (switcher.mouseoverTimer) 
					switcher.clearTimeout(0);
				
				if (switcher.trigMode === 'hover') {
					var pre = switcher.selectedItem;
					if (this !== pre && switcher.mouseoutTimerFn) {
						switcher.mouseoutTimerFn();
						switcher.mouseoutTimerFn = NULL;
					}
					
					var el = e.target;
					if (switcher.autoRecover && (el === this || Util.ancestorOf(this, el))) {
						if (!switcher.mouseoutTimer) {
							var nd = this;
							switcher.mouseoutTimerFn = function(){
								switcher.unselect(nd);
							};
							switcher.mouseoutTimer = setTimeout(switcher.mouseoutTimerFn, switcher.delayHide || 500);
						}
					}
				}
				return !switcher.enableBubble;
			});
		}
		
	   // install click event handler
	   if(this.trigMode === 'click'){
	   		jq.bind(this.clickEvent||'mousedown', function(){
				switcher.select(this);
			});
	   }
    }
};

<div id="cls-Xwb.ui.Box"></div>/**
 * @class Xwb.ui.Box
 * Box与Layer只是模板上的不同。
 * @extends Xwb.ui.Layer
 */
ui.Box = X.reg('Box', Util.create(ui.Layer, {
    view : 'Box'
}));

<div id="cls-Xwb.ui.Tip"></div>/**
 * @class Xwb.ui.Tip
 * 提示类，提供超时处理。
 * @extends Xwb.ui.Box
 */

 
ui.Tip = X.reg('Tip', Util.create(ui.Box, {
    
    cs : 'win-fixed',
<div id="cfg-Xwb.ui.Tip-autoHide"></div>/**
 * @cfg {Boolean} autoHide defaults true
 */      
    autoHide : true,
<div id="cfg-Xwb.ui.Tip-timeoutHide"></div>/**
 * @cfg {Number} timeoutHide defaults to 1000 ms
 */    
    timeoutHide : 1000,
<div id="prop-Xwb.ui.Tip-timeoutShow"></div>/**
 *  该属性是{@link setShowTimer}延迟显示时设置的超时时间，
 *  {@link setShowTimer}常用在mouseover时延迟提示的显示，mouseout时清除延迟以提高用户体验。
 */
    timeoutShow : 200,

<div id="cfg-Xwb.ui.Tip-stayHover"></div>/**
 * @cfg {Boolean} stayHover stay on mouseover and hide on mouseout, defaults to false
 */
 
    stayHover : false,
<div id="cfg-Xwb.ui.Tip-offX"></div>/**
 * @cfg {Number} offX 面板定位时往瞄点X方向的偏移增量，默认25
 */
    offX : 25,
    
<div id="cfg-Xwb.ui.Tip-offX"></div>/**
 * @cfg {Number} offX 面板定位时往瞄点Y方向的偏移增量，默认-10
 */
    offY : -10,
    
    // override
    innerViewReady : function(v){
        var jq = this.jq();
        if(this.stayHover){
            jq.hover(
                Util.bind(this.onMouseover, this),
                Util.bind(this.onMouseout, this)
            );
        }
    },
    
    onMouseover : function(){
        this.clearHideTimer();
    },
    
    onMouseout : function(){
        this.setHideTimer();
    },
    
<div id="method-Xwb.ui.Tip-clearHideTimer"></div>/**
 * 清除超时隐藏
 */
    clearHideTimer : function(){
        if(this.hideTimerId){
            clearTimeout(this.hideTimerId);
            this.hideTimerId = false;
        }
    },
    
    beforeShow : function(){
        if( Layer.prototype.beforeShow.apply(this, arguments) === false )
            return false;
        
        if(this.autoHide)
            this.setHideTimer();
    },

<div id="method-Xwb.ui.Tip-setShowTimer"></div>/**
 *  设置或清除显示超时。
 *  该方法是#setHideTimer与clearHideTimer对应延迟显示方法，已集中在一个函数调用。
 *  常用在mouseover时延迟提示的显示，mouseout时清除延迟，
 *  可有效防止用户只是掠过鼠标但并非查看时取消显示提示以提高用户体验。
 * @param {Boolean} set
 */
    setShowTimer : function(b){
        if(b){
            this.showTimerId = setTimeout(Util.getBind(this, 'onTimerShow'), this.timeoutShow);
        }else if(this.showTimerId){
            clearTimeout(this.showTimerId);
            this.showTimerId = false;
        }
    },
    
<div id="method-Xwb.ui.Tip-setHideTimer"></div>/**
 * 开始超时隐藏,在指定时间内隐藏
 */
    setHideTimer : function(){
        this.clearHideTimer();
        this.hideTimerId = setTimeout(Util.getBind(this, 'onTimerHide'), this.timeoutHide);
    },
    
    onTimerHide : function(){
        this.display(false);
        this.clearHideTimer();
    },
    
    onTimerShow : function(){
        this.display(true);
        this.setShowTimer(false);
    }
}));

})(Xwb, $);
(function(X, $){

var Util = X.util;
var undefined;
var T = X.Tpl;
var doc = document;

var ui = X.ui;

<div id="cls-Xwb.ui.Dialog"></div>/**
 * @class Xwb.ui.Dialog
 * @extends Xwb.ui.Box
 * 对话框
 */

<div id="cfg-Xwb.ui.Dialog-buttonTpl"></div>/**
 * @cfg {String} buttonTpl 指定单个按钮的HTML模板
 */

<div id="cfg-Xwb.ui.Dialog-buttonHtml"></div>/**
 * @cfg {String} buttonHtml 指定所有按钮的HTML模板
 */
<div id="cfg-Xwb.ui.Dialog-defBtn"></div>/**
 * @cfg {String} defBtn default focused button id
 */
ui.Dialog = X.reg('Dlg', Util.create(ui.Box, function(father){
    return {
        
        cs : 'win-tips win-fixed',
        
        contentHtml : 'DialogContent',
        
        focusBtnCs : 'highlight',
        
        mask : true,
        
        closeable : true,
        
        // 创建按钮html
        initUI : function(){
            if(this.buttons && !this.buttonHtml){
                var htmls = [];
                for(var i=0,btns=this.buttons,len=btns.length;i<len;i++){
                    htmls.push(T.parse(this.buttonTpl || 'Button', btns[i]));
                }
                this.buttonHtml = htmls.join('');
            }
            father.initUI.call(this);
        },
        <div id="method-Xwb.ui.Dialog-setFocus"></div>/**
         * 聚焦到指定按钮
         * @param {String} buttonId
         */
        setFocus : function(btn){
            if(btn || this.defBtn)
                this.jq('#xwb_btn_' + (btn||this.defBtn)).focus().addClass(this.focusBtnCs);
        },
        
        afterShow : function(){
            father.afterShow.call(this);
            if(this.defBtn)
                this.setFocus();
        },
        <div id="cfg-Xwb.ui.Dialog-onbuttonclick"></div>/**
         * @cfg {Function} onbuttonclick 当按钮点击时回调，参数:buttonId
         */
        onbuttonclick : function(eid){
            if(__debug) console.log(eid+' clicked');
        },
    <div id="method-Xwb.ui.Dialog-setHandler"></div>/**
     * 重定义{@link #onbuttonclick}处理
     * @param {Function} handler
     */
        setHandler : function(handler){
            this.onbuttonclick = handler;
            return this;
        },
    <div id="method-Xwb.ui.Dialog-getButton"></div>/**
     * 获得指定按钮
     * @return {jQuery}
     */
        getButton : function(bid){
            return this.jq('#xwb_btn_' +bid);
        },
         
        innerViewReady : function(v){
            father.innerViewReady.call(this, v);
            var w = this;
            $(v).find('#xwb_dlg_btns').click(function(e){
                var btn = Util.domUp(e.target, function(el){
                        return el.id && ( el.id.indexOf('xwb_btn_') ===0 );
                    }, this);
                if(btn){
                    var eid = btn.id.substr('xwb_btn_'.length);
                    if( w.buttons ){
                        $.each( w.buttons, function(){
                            if(this.id === eid){
                                var ret;
                                if(this.onclick)
                                    ret = this.onclick(w);
                                
                                if(ret !== false && w['on'+eid])
                                    ret = w['on'+eid]();
                                    
                                if(ret !== false)
                                   if( w.onbuttonclick(eid) !== false )
                                    w.close();
                            }
                        });
                    }
                    return false;
                }
            });
        }
    };
}));

<div id="cls-Xwb.ui.MsgBox"></div>/**
 * @class Xwb.ui.MsgBox
 * 常用对话框集合
 * @static
 */

ui.MsgBox = X.reg('msgbox', {
    <div id="method-Xwb.ui.MsgBox-getSysBox"></div>/**
     * 获得库中公用对话框实例
     * @return {Xwb.ui.Dialog}
     */
    getSysBox : function(){
        var w = this.sysBox;
        if(!w){
            w = this.sysBox =  X.use('Dlg', {
                appendTo:doc.body,
                title:'提示',
                dlgContentHtml : 'MsgDlgContent',
                mask : true,
                //对话框默认按钮
                buttons : [
                  {title: '确&nbsp;定',     id :'ok'},
                  {title: '取&nbsp;消',     id :'cancel'},
                  {title: '&nbsp;是&nbsp;', id :'yes'},
                  {title: '&nbsp;否&nbsp;', id :'no'},
                  {title: '关&nbsp;闭',     id :'close'}
                ],
                
                <div id="method-Xwb.ui.MsgBox-setContent"></div>/***/
                setContent : function(html){
                    this.jq('#xwb_msgdlg_ct').html(html);
                },
                
                setIcon : function(icon){
                    var jq = w.jq('#xwb_msgdlg_icon');
                    jq.attr('className', jq.attr('className').replace(/icon\-\S+/i, 'icon-'+icon));
                },
                
                afterHide : function(){
                    ui.Dialog.prototype.afterHide.call(this);
                    // 复原callback
                    this.onbuttonclick = ui.Dialog.prototype.onbuttonclick;
                }
            });
        }
        return w;
    },
    <div id="method-Xwb.ui.MsgBox-getTipBox"></div>/**
     * 获得库中公用提示框实例
     * @return {Xwb.ui.Tip}
     */
    getTipBox : function(){
        var w = this.tipBox;
        if(!w){
            w = this.tipBox = X.use('Tip', {
                cs : 'win-tips win-fixed',
                contentHtml : 'DialogContent',
                appendTo:doc.body,
                title:'提示',
                timeoutHide:1200,
                dlgContentHtml : 'MsgDlgContent',

                setContent : function(html){
                    this.jq('#xwb_msgdlg_ct').html(html);
                },
                
                setIcon : function(icon){
                    var jq = w.jq('#xwb_msgdlg_icon');
                    jq.attr('className', jq.attr('className').replace(/icon\-\S+/i, 'icon-'+icon));
                },
                
                afterHide : function(){
                    ui.Tip.prototype.afterHide.call(this);
                    // 复原callback
                    if(this.onhide){
                        this.onhide();
                        this.onhide = false;
                    }
                }
            });
        }
        return w;
    },
    <div id="method-Xwb.ui.MsgBox-getAnchorDlg"></div>/**
     * 获得库中公用定向弹出框实例
     * @return {Xwb.ui.Dialog}
     */
    getAnchorDlg : function(){
        var w = this._anchorDlg;
        if(!w){
            w = this._anchorDlg = X.use('Dlg', {
                cs:'win-tips-ask',
                mask : false,
                dlgContentHtml:'AnchorDlgContent', 
                appendTo:doc.body,
                //对话框默认按钮
                defBtn:'ok',
                buttons : [
                  {title: '确&nbsp;定',     id :'ok'},
                  {title: '取&nbsp;消',     id :'cancel'}
                ],
                setAnchor : function(anchorElem){
                    this.anchorEl = anchorElem;
                    return this;
                },
                
                beforeShow : function(){
                    ui.Dialog.prototype.beforeShow.call(this);
                    if(this.anchorEl){
                        this.anchor(this.anchorEl, 'tc', function(ret, sw, sh){
                            ret[1]-=2;
                        });
                        var self = this;
                        this.slide('bc',true, function(){
                            ui.Dialog.prototype.afterShow.call(self);
                        });
                    }
                },
                
                // 置为空，在效果完成后再调用父类afterShow
                afterShow : $.noop,
                
                beforeHide : function(){
                    if(this.anchorEl){
                        this.slide('cb',false);
                        delete this.anchorEl;
                        return false;
                    }else ui.Dialog.prototype.beforeHide.call(this);
                },
                
                afterHide : function(){
                    ui.Dialog.prototype.afterHide.call(this);
                    // 复原callback
                    this.onbuttonclick = ui.Dialog.prototype.onbuttonclick;
                }
            });
        }
        return w;
    },
    <div id="method-Xwb.ui.MsgBox-getAnchorTip"></div>/**
     * 获得库中公用定向提示框实例
     * @return {Xwb.ui.Dialog}
     */
    getAnchorTip : function(){
        var w = this._anchorTip;
        if(!w){
            w = this._anchorTip = X.use('Tip', {
                view : 'Box',
                cs:'operate-success',
                contentHtml:'AnchorTipContent', 
                appendTo:doc.body,
                timeoutHide:1800,
                setAnchor : function(anchorElem){
                    this.anchorEl = anchorElem;
                    return this;
                },
                
                beforeShow : function(){
                    if(this.anchorEl){
                        this.anchor(this.anchorEl, 'tc', function(ret, sw, sh){
                            ret[1]-=8;
                        });
                        this.slide('bc',true);
                    }
                    ui.Tip.prototype.beforeShow.call(this);
                },
                
                beforeHide : function(){
                    if(this.anchorEl){
                        this.slide('cb',false);
                        delete this.anchorEl;
                        return false;
                    }else ui.Tip.prototype.beforeHide.call(this);
                },
                
                afterHide : function(){
                    ui.Tip.prototype.afterHide.call(this);
                    // 复原callback
                    if(this.onhide){
                        this.onhide();
                        this.onhide = false;
                    }
                }
            });
        }
        
        return w;
    },
    <div id="method-Xwb.ui.MsgBox-tipError"></div>/**
     * @param {String} message
     * @param {Function} callback
     */
    tipError : function(msg, fn){ this.tip(msg, 'error', fn); },
    <div id="method-Xwb.ui.MsgBox-tipOk"></div>/**
     * @param {String} message
     * @param {Function} callback
     */
    tipOk : function(msg, fn){ this.tip(msg, 'success', fn); },
    <div id="method-Xwb.ui.MsgBox-tipWarn"></div>/**
     * @param {String} message
     * @param {Function} callback
     */
    tipWarn : function(msg, fn){ this.tip(msg, 'alert', fn); },
    <div id="method-Xwb.ui.MsgBox-anchorTipOk"></div>/**
     * @param {HTMLElement} anchorElement
     * @param {String} message
     * @param {Function} callback
     */
    anchorTipOk : function(elem, msg, fn){ this.anchorTip(elem, msg,'',fn); },
    <div id="method-Xwb.ui.MsgBox-anchorConfirm"></div>/**
     * @param {HTMLElement} anchorElement
     * @param {String} message
     * @param {Function} callback
     */
    anchorConfirm : function(elem, msg, fn){
        var dlg = this.getAnchorDlg();
        dlg.setTitle(msg)
           .setHandler(fn||$.noop)
           .setAnchor(elem)
           .display(true);
    },
    <div id="method-Xwb.ui.MsgBox-tip"></div>/**
     * @param {String} message
     * @param {String} icon
     * @param {Function} callback
     */
    tip : function(msg, icon, fn){
        var tip = this.getTipBox();
        tip.setIcon(icon||'alert');
        tip.setContent(msg||'');
        tip.display(true);
        fn && (tip.onhide = fn);
    },
    <div id="method-Xwb.ui.MsgBox-anchorTip"></div>/**
     * @param {HTMLElement} anchorElement
     * @param {String} message
     * @param {String} icon
     * @param {Function} callback
     */
    anchorTip : function(anchorElem, msg, icon, fn){
        var tip = this.getAnchorTip();
        tip.setTitle(msg)
           .setAnchor(anchorElem)
           .display(true);
        fn && (tip.onhide = fn);
    },
    <div id="method-Xwb.ui.MsgBox-alert"></div>/**
     * @param {String} title
     * @param {String} message
     * @param {Function} [callback]
     * @param {String} [buttons]
     * @param {String} [icon]
     * @param {String} [defaultButton]
     */
    alert : function(title, msg, callback, buttons, icon, def){
        var w = this.getSysBox(), btns = w.buttons;
        if(!buttons)
            def = buttons = 'ok';
        if(!icon)
            icon = 'alert';
        for(var i=0,len=btns.length;i<len;i++){
            w.jq('#xwb_btn_'+btns[i].id).cssDisplay(buttons.indexOf( btns[i].id ) >= 0);
        }
        w.defBtn = def;
        title && w.setTitle(title);
        msg   && w.setContent(msg);
        icon  && w.setIcon(icon);
        callback && (w.onbuttonclick = callback);
        w.display(true);
        return w;
    },
    <div id="method-Xwb.ui.MsgBox-confirm"></div>/**
     * @param {String} title
     * @param {String} message
     * @param {Function} [callback]
     * @param {String} defaultButton
     */
    confirm : function(title, msg, callback, def){
        this.alert(title || '提示', msg, callback, 'ok|cancel', 'ask', def||'ok');
    },
    <div id="method-Xwb.ui.MsgBox-success"></div>/**
     * @param {String} title
     * @param {String} message
     * @param {Function} [callback]
     * @param {String} defaultButton
     */
    success : function(title, msg, callback, buttons, def){
        this.alert(title, msg, callback, buttons || 'ok', 'success', def||'ok');
    },
    <div id="method-Xwb.ui.MsgBox-error"></div>/**
     * @param {String} title
     * @param {String} message
     * @param {Function} [callback]
     * @param {String} defaultButton
     */
    error  : function(title, msg, callback, buttons, def){
        this.alert(title, msg, callback, buttons || 'ok', 'error', def||'ok');
    }
});

})(Xwb, $);
(function(X){
    //
    //  给Xwb加上事件处理功能
    //
    Xwb.util.Eventable.apply(X);
    /**
     * @class Xwb
     */
     
    <div id="event-Xwb-pipe.start"></div>/**
     * @event pipe.start
     * 页面块加载前发送
     * <pre><code>
        // 模块加载前做预处理
        Xwb.on('pipe.start', function(cfg){
            alert(cfg.page);
        });
     </code></pre>
     * @param {Object} cfg 全局配置信息，该信息可通过{@link Xwb.getCfg}方法获得
     */
     
    <div id="event-Xwb-pipe.end"></div>/**
     * @event pipe.end
     * 页面所有块加载结束后发送，可替代jQuery里的DOMReady处理。
     */
    
    <div id="event-Xwb-page.before"></div>/**
     * 加载每个块前发送
     * @event page.before
     * @param {Object} pageConfig 当前页面块配置信息
     */
    
    <div id="event-Xwb-page.after"></div>/**
     * @event page.after 块加载完成后发送
     * @param {Xwb.ax.Pagelet} pagelet 当前块实例
     */
    
    
    <div id="cls-Xwb.ax.PipeMgr"></div>/**
     * @class Xwb.ax.PipeMgr
     * 把一个页面划分为多个块，每个块有自身独立的数据与结构，数据可理解为与块相关的属性配置信息，结构可理解为输出到该块处的HTML代码。<br/>
     * 在Xwb库中用{@link Xwb.ax.Pagelet}类描述这种块。
     * 每个块的数据由后端生成，它的生命周期是，通过&lt;script&gt;标签输出到页面并触发该块的初始化，直至该块的视图(HTML元素)和交互就绪。
     * 这个过程是块的数据流由一个管道(pipe)由后端推送到前端的过程。<br/>
     * 创建一个页面块在前端可分为两个过程：
     *  <ul>
     * <li>注册指定块</li>
     * <li>等待库的回调执行初始化块信息</li>
     * </ul>
     * 注册块可通过{@link #reg}方法。
     * @singleton
     */
    
     
    Xwb.ax.PipeMgr = {
        
        // 页面已注册的{@link Xwb.ax.Pagelet}模块类
        pages : {},
        
        // 已实例化的pagelet
        instances : {},
        
        <div id="method-Xwb.ax.PipeMgr-reg"></div>/**
         * 注册一个页面块{@link Xwb.ax.Pagelet}。
         * @param {String} name
         * @param {Xwb.ax.Pagelet} pagelet
         * @param {Boolean} [override]　是否覆盖原有对象
         * @return this
         */
        reg : function(name, page, override){
            if(!override && this.pages[name])
                throw 'Object existed exception.['+name+']';
            this.pages[name] = page;
            
            return this;
        },
        
        // implements
        // 这个方法由后端输出的脚本回调。
        // pipe开始时调用。
        start : function( cfg ){
            X.cfg = cfg;
            X.fireOnce('pipe.start', cfg, this);
        },
        
        // 这个方法由后端输出的脚本回调。
        // pipe逐个加载Pagelet时调用。
        load : function(pagelet){
            X.fire('page.before', pagelet, this);
            // 优先应用pagelet.pagelet作类型，
            // 如果不存在，再应用pagelet.data.cls类型
            var pl = this.pages[pagelet.pagelet] || 
                     this.pages[pagelet.data && pagelet.data.cls];
            if(!pl)
                pl = Pagelet;
             
            if(typeof pl === 'function')
                pl = new pl();
            //　如果设置中有pipe属性，优先使用该属性作为pipe类
            else pl = new (pl.pipe||Pagelet)(pl);
            this.instances[pagelet.id] = pl;
            
            pl.load(pagelet);
            X.fire('page.after', pl, this);
        },
        
        // 这个方法由后端输出的脚本回调。
        // pipe结束时调用。
        end : function(){
            X.fireOnce('pipe.end', this);
        },
        
        <div id="method-Xwb.ax.PipeMgr-getPage"></div>/**
         *  获得页面实例
         * @param {String} id
         */
        getPage : function(id){
            return this.instances[id];
        }
    };
    
    X.reg('pipeMgr', Xwb.ax.PipeMgr);
    <div id="cls-Xwb.ax.Pagelet"></div>/**
     * @class Xwb.ax.Pagelet
     * 表征页面内某个块（区域）的类，所有块都应该应用或继承该类。关于该类的原理参见{@link Xwb.pipe}。
     * 一般来说，一个定制块只需实现{@link onViewReady}方法即可，这个是个回调方法，
     * 当块视图HTML元素生成并放到页面DOM上的时候，库就会回调该方法，定制块可在该方法里作所有的初始化。<br/>
     * 块间的通讯可通过调用{@link Xwb.fire}，{@link Xwb.on}方法来发送与监听事件。<br/>
     * 一个块后端返回的配置信息为：
     * <pre><code>
        {
            // 块ID
            id : '',
            
            // 块的HTML代码，生成HTML元素后替换到页面中块所在的位置，块无HTML时该项为null
            html : '',
            
            // 标识该块是属于哪种“类”，该类主要为方便后端识别
            pagelet : '',
            
            // 块自身的数据
            data : {
                // 约定为使用指定的Pagelet类实例化块
                cls : 'wblist'
            }
        }
     </code></pre>
     pipe初始化查找块配置所在的注册类过程为：
     <ul>
     <li>判断pagelet属性，如果存在注册类，则用该类实例化块
     <li>如果未找到，继续判断data.cls属性，如果存在注册类，则用该类实例化块
     <li>如果未找到，用{@link Xwb.ax.Pagelet}类实例化该块
     </ul>
     应用例子：
     * <pre><code>
     // 直接应用Pagelet类
     Xwb.ax.reg('TestPagelet', {
        // 实现接口
        onViewReady : function(){
            this.jq().css('background', 'red');
        } 
     });
    
     或继承Pagelet类
     Xwb.ax.WeiboList = Util.create(Pagelet, {
        ui : {cls:X.ui.WeiboList},
        onViewReady : function(){
            this.doSomething();
        },
        doSomething : function(){
            // ...
        }
     });
     
     Xwb.ax.reg('wblist', Xwb.ax.WeiboList);
     
     // 可直接利用Pagelet类，或通过pipe属性指定Pagelet类实例化该块
     Xwb.ax.reg('plTest.pg', {
     
        // 可指定使用某Pagelet类实例化该块
        pipe : MyPipeClass, 
        
        ui : {
            // 可通过cls指定该UI类，不指定时采用Xwb.ui.Base类实例化该UI
            cls:Xwb.ui.Box,
            // UI配置信息
            contextable:true
        },
        
        // 实现接口
        onViewReady : function(){
            this.jq()
                .css('background', '#ccc');
        }
     });
    
    X.on('pipe.end', function(){
        // alert('end');
    });
    
    X.on('page.before', function(cfg){
       // alert(cfg.id);
    });
     </code></pre>
     * 更详细用法参见ux/ready.js
     * @cfg {Function} pipe 指定当前配置实例化时的{@link Xwb.ax.Pagelet}类
     * @cfg {Xwb.ui.Base|Object} ui 指定Pagelet模板中当getUI()方法调用后返回的UI类，通常这个UI封装了当前Pagelet的视图部份
     */
     
    /**@property id*/
        var Pagelet = X.ax.Pagelet = X.util.create();
        
        Pagelet.prototype = {
            
            // 1为替换原有结点，
            // 2为对原有结点应用innerHTML
            htmlMode : 1,
            
            init : function(ext){
                if(ext)
                    $.extend(this, ext);
            },
            
            // 调用入口
            load : function(cfg){
                // 
                this.id = cfg.id;
                // 
                this.type = cfg.pagelet;
                if(cfg.data && cfg.data.cls)
                    this.cls  = cfg.data && cfg.data.cls;
    
                if(cfg.perch){
                    this.applyHtml(this.createContent(cfg));
                    // 生成对应的UI控件实现
                    if(this.ui)
                        this.getUI();
    
                    this.onViewReady(cfg);
                }
            },
            
            // protected
            // 可重写该方法生成HTML内容
            createContent : function(cfg){
                return cfg.html||'';
            },
            
            // protected
            applyHtml : function(html){
                var el = this._getHoldingEl();
                if(this.htmlMode === 1){
                    // 如果非标签，补全标签
                    if(html.charAt(0) !== '<')
                        html = '<div>'+html+'</div>'
        			//替换标签而不是填充内容
        			var rl = $(html);
        			$(el).replaceWith(rl);
        			this.contentView = rl[0];
        		}else if(this.htmlMode === 2){
        		    // 应用innerHTML后显示
        		    $(el).html(html).cssDisplay(true);
        		    this.contentView = el;
        		}
            },
            
            /**
             * 返回与该页面关联的UI控件，如果想通过{@link Xwb.ui.Base}的类或子类控制该块，可调用该方法返回块对应的UI类实例。<br/>
             * 库会根据注册块时的ui属性配置来初始化UI类。
             * @return {Xwb.ui.Base}
             */
            getUI : function(){
                var ui = this.ui;
                
                if(!ui || !ui.cacheId){
                    var cls = ui?ui.cls||X.ui.Base : X.ui.Base;
                    this.ui = ui = new cls($.extend({view:this.contentView},ui));
                    // 触发onViewReady
                    ui.getView();
                }
    
                // 已是实例
                return ui;
            },
            
            /**
             * 等同调用 this.getUI().jq()
             * @return {jQuery}
             */
            jq : function(){
                var ui = this.getUI();
                return ui.jq.apply(ui, arguments);
            },
            
            // 获得最初位置结点
            _getHoldingEl : function(){
                return document.getElementById(this.id);
            },
            
            /**
             * @cfg {Function} onViewReady 接口方法，在页面元素就绪后调用
             */
            onViewReady : $.noop
        };
        
    if(__debug) { Pagelet.prototype.toString = function(){ return '#'+this.id+'['+this.type+']'; } }
})(Xwb);
/*!
 * X weibo JavaScript Library v1.1
 * http://x.weibo.com/
 * 
 * Copyright 2010 SINA Inc.
 * Date: 2010/10/28 21:22:06
 */

// 当ready.js一些功能复用的比较多时可经重构后放到本JS文件来，再在ready.js里引用。

(function(X, $){

var 
	UNDEFINED,

	FALSE = false,

	TRUE = true,

	NULL = null,
	
	ui = X.ui, 
    Util = X.util, 
    doc = document, 
    Base = ui.Base, 
    T = X.Tpl, 
    Req = X.request,
	hideCls = 'hidden',
    exceedCS = 'out140',
    MB = X.use('msgbox'),
	getCfg = X.getCfg,
	getUid = X.getUid,
	getWb = X.getWb,
	setWb = X.setWb;

if(!X.mod)
    X.mod = {};

var mod = X.mod;

/**
 * @class Xwb.mod.emotion
 * 表情弹窗
 * @extends Xwb.ui.Box
 * @singleton
 */
X.reg('emotion', function(){

var inst = X.use('Box', {
    
	contentHtml: 'Loading',
    
    boxOutterHtml : 'ArrowBoxBottom',
    
    cs : 'win-emotion',
    
    appendTo : doc.body,
    
    closeable : TRUE,
        
    actName : 'em',
    
    contextable : TRUE,
    
    actionMgr : TRUE,

	emotions: NULL,

	//当前选中的分类
	$categorySelected: NULL,

	//当前显示的表情列表
	$categoryShowed: NULL,

	//分类索引->数据映射
	cateMaps: {},
    
    onactiontrig : function(e){
        switch(e.data.e){
            case 'em':
                if( this.onselect ){
                    if( this.onselect(this.findEmotionText(e), e) === FALSE)
                        return;
                }
                this.display(FALSE);
            break;

			case 'sc': //选择分类
				//console.debug(e);
				this.emSwitch(e.data.idx, e.src);
			break;
        }
    },
    
    setHandler : function(hd){
        this.onselect = hd;
        return this;
    },
    
    setSelectionHolder : function(selHolder, oninsert, scope){
        this.setHandler(function( selected ){
            selHolder.insertText(selected);
            oninsert && oninsert.call(scope||this, selHolder, selected);
        });
        return this;
    },
    
    showAt : function(anchor){
        var off = $(anchor).offset();
        off.left -= 24;
        off.top += 20;
        this.offset(off)
            .display(TRUE);
    },

	initEmotion: function(resp) {
		if (resp.isOk())
		{
			var data = resp.getData();
			
			var 

				emotions = {},
				hots = [],

				//模板值
				category = [],
				hotFaces = [],

				//分类索引ID
				cateIdx = 0,
				cateMaps = {};;


			$.each(data, function(i, e) {
				if (e.type != 'face')
				{
					return;
				}

				var cateName = e.category ? e.category: '默认';
				if (!emotions[cateName])
				{

					emotions[cateName] = [e];
					
					cateMaps[cateIdx] = emotions[cateName];

					category.push(['<a href="#" rel="e:sc,idx:',cateIdx,'">',cateName,'</a>'].join(''));

					cateIdx++;
					
				} else {
					emotions[cateName].push(e);
				}
				
				if (e.is_hot)
				{
					//hots.push(e);
					hots.push(['<a href="#" rel="e:em" title="' ,e['phrase'] ,'"><img width="22px" height="22px" src="', e['url'] ,'" /></a>'].join(''))
				}
			});

			var faceHtml = [];

		    // 过滤重复表情
		    var hot = 0;
    		$.each(emotions['默认'], function(i, fc) {
    			if(fc['is_hot']) hot++;
    			if(!fc['is_hot'] || hot>15)
    			    faceHtml.push(['<a href="#" rel="e:em" title="' ,fc['phrase'] ,'"><img width="22px" height="22px" src="', fc['url'] ,'" /></a>'].join(''));
    		});

			if (hots.length > 15)
			{ //热门的只显示１５个
				hots = hots.slice(0, 15);
			}

			var assigns = {
				category: category.join(''),
				faces: faceHtml.join(''),
				hotList: hots.join('')
			};
			
			var $show = $(T.parse('EmotionBoxContent', assigns));

			this.jq('#xweibo_loading').hide();
			this.jq('#xwb_dlg_ct').append($show);

			this.$categorySelected = this.jq('#cate>a:first').addClass('current');
			this.$categoryShowed = this.jq('#flist0');

			this.emotions = emotions;
			this.cateMaps = cateMaps;
		}
	},

	// 创建表情显示区
	createEmArea: function(i) {

		var faces = this.cateMaps[i];
		var html = ['<div class="e-list" id="flist' + i + '">'];

		$.each(faces, function(i, fc){
			html.push(['<a href="#" rel="e:em" title="' ,fc['phrase'] ,'"><img width="22px" height="22px" src="', fc['url'] ,'" /></a>'].join(''));
		});

		html.push('</div>');

		return $(html.join(''));
	},
	
	//切换分类
	emSwitch: function(i, src) {
		var $src = $(src);
		var current = 'current';

		if ($src.hasClass(current))
		{
			return;
		}
		this.$categorySelected.removeClass(current);
		this.$categorySelected = $src.addClass(current);

		this.$categoryShowed.addClass(hideCls);

		if (i > 0)
		{
			this.jq('#hotEm').addClass(hideCls);
		} else {
			this.jq('#hotEm').removeClass(hideCls);
		}
			

		var $show = this.jq('#flist'+i);

		if (!$show.length)
		{
			$show = this.createEmArea(i).appendTo(this.jq('#box'));
		}

		this.$categoryShowed = $show.removeClass(hideCls);
	},

	// 加载表情数据
	loadEmotion: function() {
		var self = this;
		Req.getEmotion(function(r) {
			self.initEmotion(r);
		});
	},

	onViewReady: function() {
		this.loadEmotion();
	},
  
    onInputRecev : function(){
        
    },
    
    findEmotionText : function(e){
        return e.src.title;
    }
});

// override function -> object
X.reg('emotion', inst, TRUE);

return inst;
});

/**
 * @class Xwb.mod.forwardBox
 * 转发对话框
 * @extends Xwb.ui.Dialog
 * @singleton
 */
X.reg('forwardBox', function(){
// TODO:实现reset，在关闭时重置所有状态
var inst = X.use('Dlg', {
    cs : 'win-forward',
    appendTo : doc.body,
    autoCenter : TRUE,
    dlgContentHtml : 'ForwardDlgContentHtml',
    title:'转发到我的微博',
    defBtn : 'forward',
    buttons : [
        {title:'转 发', id:'forward'},
        {title:'取 消', id:'cancel'}
    ],

    checkText : function(){
        var v = $.trim( this.jqInputor.val() );
        var left = Util.calWbText(v);
        if (left >= 0)
            this.jqWarn.html('您还可以输入'+left+'字')
                .removeClass(exceedCS);
        else
            this.jqWarn.html('已超出'+Math.abs(left)+'字')
                .addClass(exceedCS);
                
        return left>=0 && v;
    },
    
    
    onViewReady : function(){
        this.jq('#xwb_face_trig')
            .click(Util.bind( this.onFaceTrig, this ));
            
        this.jqInputor = this.jq('#xwb_fw_input');
        this.jqWarn    = this.jq('#xwb_warn_tip');
        this.jqContent = this.jq('#xwb_forward_text');
        this.jqLabelCt = this.jq('#xwb_fw_lbl');
        
        this.jqInputor.bind('keyup', Util.bind( this.onInputorKeyup, this ));
        this.selectionHolder = X.use('SelectionHolder', {elem:this.jqInputor[0]});
    },
    
    onInputorKeyup : function(){
        this.checkText();
    },
    
    onFaceTrig : function(e){
        X.use('emotion')
         .setSelectionHolder( this.selectionHolder , this.checkText, this)
         .showAt(e.target);
        return FALSE;
    },
    
    setContent : function(wbId, wbData, uid){
        
        this._predCfg = { id : wbId, data : wbData, uid : uid };
        
        // Make sure view node is created
        this.jq();
        
        var otherCmts = [], text, inputText;
        
        if( uid !== wbData.u.id )
            otherCmts.push( T.parse( 'ForwardDlgLabel', {uid:wbId, nick:wbData.u.sn}) );
        
        var rt = wbData.rt;
        if (rt) {
            text = rt.tx;
            inputText = '//@' + wbData.u.sn + ':' + wbData.tx;
            
            if (rt.u.id != uid) 
                otherCmts.push( T.parse('ForwardDlgLabel', { uid: rt.id, nick: rt.u.sn }) );
        }
        else {
            text = wbData.tx;
            inputText = '';
        }
        
        this.jqContent.text( Util.escapeHtml( text ) );
        //this.jqInputor.val( inputText );
        this.selectionHolder.setText( inputText );
        this.checkText();
        this.jqLabelCt.html( otherCmts.join('') );
        
        return this;
    },
    
    submit : function(){
        
        if( this.isLoading )
            return FALSE;

        this.isLoading = TRUE;
        
        var v = this.checkText();
        if( v  === '' ){
            v = '转发微博';
        }else if( !v ){
            this.jqInputor.focus();
            this.isLoading = false;
            return FALSE;
        }
        
        var uids = [];
        this.jq('input[type="checkbox"]:checked').each(function(){
            uids[uids.length] = $(this).val();
        });
        
        var d = this._predCfg;
        Util.disable( this.getButton('forward') , TRUE);
        Req.repost(d.id, v, uids.join(','), Util.getBind(this, 'onSubmitLoad'));
    },
    
    onSubmitLoad : function( e ){
        
        Util.disable( this.getButton('forward') , FALSE);
        this.close();
        // todo : 关闭在tip隐藏后
        if(e.isOk()){
            MB.tipOk('转发成功');
        }
        else MB.tipError(e.getMsg());
        this.isLoading = FALSE;
    },
    
    onbuttonclick : function(bid){
        if( bid === 'forward' ){
            this.submit();
            return FALSE;
        }
    }
});

X.reg('forwardBox', inst, TRUE);

return inst;

});

/*!
 * 
 * http://flowplayer.org/tools/toolbox/flashembed.html
 *
 * Since : March 2008
 * Date  :    Wed May 19 06:53:17 2010 +0000 
 * modify by : guolianghu
 * opts.height 高 （必须）
 * opts.width 宽 (必须）
 * opts.id dom-id
 * opts.name dom-name
 * opts.src flash地址 （必须）
 * opts.nocache 禁用cache （可选）
 * opts.w3c 
 * 
 * conf: 配置  （可选）
 */ 
ui.getFlash = function(opts, conf) {
	var IE = $.browser.msie;

	opts = opts || {};
	
	/******* OBJECT tag and it's attributes *******/
	var html = '<object width="' + opts.width + 
		'" height="' + opts.height + 
		(opts.id ? '" id="' + opts.id: '') + 
		(opts.name ? '" name="' + opts.name: '') + '"';
	
	if (opts.nocache) {
		opts.src += ((opts.src.indexOf("?") != -1 ? "&" : "?") + Math.random());		
	}
	
	if (opts.w3c || IE) {
		html += ' data="' +opts.src+ '" type="application/x-shockwave-flash"';		
	} else {
		html += ' classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"';	
	}
	
	html += '>'; 
	
	// nested PARAM tags
	if (opts.w3c || IE) {
		html += '<param name="movie" value="' +opts.src+ '" />'; 	
	} 
	
	// not allowed params
	opts.width = opts.height = opts.id = opts.w3c = opts.src = NULL;
	opts.onFail = opts.version = opts.expressInstall = NULL;
	
	for (var key in opts) {
		if (opts[key]) {
			html += '<param name="'+ key +'" value="'+ opts[key] +'" />';
		}
	}	

	// FLASHVARS 
	var vars = "";
	
	if (conf) {
		for (var k in conf) { 
			if (conf[k]) {
				var val = conf[k]; 
				vars += k +'='+ (/function|object/.test(typeof val) ? f.asString(val) : val) + '&';
			}
		}
		vars = vars.slice(0, -1);
		html += '<param name="flashvars" value=\'' + vars + '\' />';
	}
	
	html += "</object>";	
	
	return html;
}

ui.WbElement = X.reg('WbElement', Util.create(Base,{
	//this.$wb jQuery li微博对象
	//this.wbData 数据对象

	init: function() {
		Base.prototype.init.apply(this, arguments);

		this.picLoadState = 0;

		this.isFw = this.wbData.rt ? 1: 0;

		this.$preview = this.$wb.find('div.preview-img');

		//console.log(this);
	},

	playVideo: function(e) {
		var wid = e.get('w'),
		vid = e.get('i'),
		urls = getCfg('urls'),
		info = urls[vid],
			
		width = this.$wb.find('div.feed-content').width() - 35,
			
		height = parseInt(width / 1.25),

		flash = ui.getFlash({
				src: info.flash,
				width: width,
				height: height,
				w3c: 1,
				id: 'sinaVideo_'+(+new Date()),
				quality: 'high',
				allowScriptAccess: 'always',
				wmode: 'transparent',
				allowFullscreen: 'TRUE',
				flashvars: 'playMovie=TRUE'
			}); 

		if (this.$video)
		{
			this.$video.remove();
		}
		
		var selector,html,tpl;

		if (this.isFw)
		{
			selector = 'div.forward>p';
			tpl = 'VideoBoxForward';
		} else {
			selector = 'p.feed-main';
			tpl = 'VideoBox';
		}

		html = T.parse(tpl, {
			href: info.url,
			title: info.title,
			flash: flash
		});

		this.$video = $(html).insertAfter(this.$wb.find(selector));

		this.switchView('video', 1);
	},

	closeVideo: function() {
		this.switchView('video', 0);
	},

	loadPic: function() {
		this.picLoadState = 1;

		var self = this, wbData = this.wbData;

		var cfg = this.isFw ? {
			org: wbData.rt['op'],
			img: wbData.rt['mp']
		}: {
			org: wbData['op'],
			img: wbData['mp']
		};

//		cfg.fw = this.isFw;

		var $thumbImg = this.$thumbImg = this.$wb.find('img.zoom-move');

		this.$loadEl = $('<div class="loading-img"></div>').appendTo($thumbImg.parent());

		var tpl;

		if (this.isFw)
		{
			tpl = 'PictureBoxForward';
		} else {
			tpl = 'PictureBox';
		}

		this.$picBox = $(T.parse(tpl, cfg));

		//'<img src="{.img}" class="narrow-move">';
		var img = this.img = new Image();

		$(img).bind('load', function() {
			self.onPicLoaded();
		})
		.addClass('narrow-move')
		.attr('rel', 'e:zo')
		.attr('src', cfg.img);
	},

	onPicLoaded: function() {
		var conSelector = this.isFw ? 'div.forward': 'div.feed-content:first';
		var $container = this.$wb.find(conSelector),
			img = this.img,
			$picBox = this.$picBox;

		$container.css('visibility', hideCls);

		var width = this.$wb.find('div.feed-content').width() - 35;

		//图标追加到box对象
		$(img).appendTo($picBox.find('div[name=img]'));
		$container.children('div.preview-img').after($picBox);

		this.switchView('pic', 1);


		if (img.width > width)
		{
			if ($.browser.msie)
			{
				img.height = img.height * (width/img.width);
			}
			img.width = width;
		}

		$container.css('visibility', '');

//$(img).show();

		this.$loadEl.remove();
		

		this.picLoadState = 2;

	},
	
	//图片放大
	zoomIn: function() {
		if (this.picLoadState == 0) {
			this.loadPic();
		} else if (this.picLoadState == 2) {
			this.switchView('pic', 1);
		}
	},

	//还原缩略图显示
	zoomOut: function() {
		this.switchView('pic', 0);
	},

	//图片转向
	trun: function(pos) {
		$(this.img).imgRotate(pos)
	},

	// 切换显示区域
	switchView: function(type, isShow) {
		if (isShow)
		{
			if (type == 'pic')
			{
				this.$picBox.show();
		
				this.$video && this.$video.remove();
				this.$video = NULL;

			} else if(type == 'video') {
				this.$video.show();
				this.$picBox && this.$picBox.hide();
			}

			this.$preview.hide();
		} else {
			if (type == 'pic')
			{
				this.$picBox && this.$picBox.hide();
			} else if (type == 'video')
			{
				this.$video && this.$video.remove();
				this.$video = NULL;
			}

			this.$preview.show();
		}
		

	}
}));

/**
 * @class Xwb.mod.CmtBox
 * 页面内的评论框
 * @extends Xwb.ui.Base
 */
// pCt 接口方法：afterSend, postWeibo
mod.CmtBox = X.reg('CmtBox', Util.create(Base, {
    actionMgr : TRUE,
    view : 'CmtBox',
    autoH : TRUE,
    wbUid : NULL,
    headPicType:1,
    innerViewReady : function( v ){
		this.wbUid = X.getUid();

        Base.prototype.innerViewReady.call(this, v);
        this.jqExtra('inputor', 'warn', 'sync');
        this.selectionHolder = X.use('SelectionHolder', {elem:this.jqInputor[0]});
        
        var self = this;
        this.jqInputor
        .bind('keyup', function(e){
             self.onInputorKeyup(e);
        });
    },
    
    reset : function(){
        this.getView();
        this.selectionHolder.setText('');
        this.jqSync.attr('checked', FALSE);
        this.checkText();
    },
    

    checkText : function(){
        var ipt = this.jqInputor, val = $.trim( ipt.val() );
        var left = Util.calWbText(val);
        if (left >= 0)
            this.jqWarn.html('还可以输入'+left+'字');
        else
            this.jqWarn.html('已超出'+Math.abs(left)+'字');
        
        // 检查高度，自动适应
        if( this.autoH && ipt.height() !== ipt[0].scrollHeight ) 
            ipt.css('height', ipt[0].scrollHeight);
 
        return left>=0 && val;
    },
    
    
    send : function(){
        if(!this.sending){
            var v = this.checkText();
            if( !v )
                setTimeout( Util.bind(function() { this.jqInputor.focus();}, this), 0 );
            else {
                if(this.sndBtn) 
                    Util.disable( this.sndBtn , TRUE );
                this.sending   = TRUE;
                var replyCmtId = this.jqInputor.data('xwb_reply_cid');
                if( replyCmtId && /^回复@.*?:/.test(v) )
                    Req.reply(
                      this.wbId, 
                      replyCmtId, 
                      v, 
                      this.jqSync.attr('checked')?1:0, 
                      this.headPicType, 
                      Util.getBind(this, 'onSendLoad'),
                      { data:{_route:X.getModule()} }
                    );
                else Req.comment( 
                      this.wbId, 
                      v, 
                      this.jqSync.attr('checked')?1:0, 
                      this.headPicType, 
                      Util.getBind(this, 'onSendLoad'),
                      { data:{_route:X.getModule()} }
                     );
            }
        }
    },
    
    onSendLoad : function( e ){
        if( e.isOk() ){
            this.pCt.afterSend(e);
            this.reset();
            // 同时发一条微博
            var data = e.getData();
            if( data.html ){
                this.pCt.postWeibo(data.wb, data.html);
            }
        }else {
            MB.tipWarn(e.getMsg());
        }
        this.jqInputor.focus();
        if(this.sndBtn) 
            Util.disable( this.sndBtn , FALSE);
        this.sending = FALSE;
    },
    
    reply : function(cmtId, nick){
        var holder = this.selectionHolder, 
            jq     = this.jqInputor,
            rex    = /^回复@.*?:/;
        this.reset();
        holder.setText('回复@' + nick + ':' + jq.val().replace(rex, ''));
        jq.data('xwb_reply_cid', cmtId);
        this.checkText();
        setTimeout(function(){ holder.focusEnd(); }, 0);
    },
    
    onFaceTrig : function(e){
        X.use('emotion')
         .setSelectionHolder( this.selectionHolder , this.checkText, this)
         .showAt(e.src);
        return FALSE;
    },
        
    onInputorKeyup : function(e){
        this.checkText();
    },
    
    onactiontrig : function(e){
        switch ( e.data.e ){
            // 点击图标
            case 'ic' :
                this.onFaceTrig(e);
                break;
                
            // 点击评论按钮
            case 'sd' :
                if(!this.sndBtn)
                    this.sndBtn = e.src;
                this.send();
                break;
        }
    }
}));

/**
 * @class Xwb.mod.CommentArea
 * 页面内的单条微博的评论区域
 * @extends Xwb.ui.Base
 */
// parent container interface :
// function:afterSend
// postWeibo
mod.CommentArea = X.reg('CmtArea', Util.create(Base, {
    
    view : 'CommentArea',
    
    readSize : 10,
    
    cmtType : 1,
    
    hdPicSz : 30,
    
    cmtCount : 0,
    
    page : 1,
    
    cmtPageSz : 20,
	
    // html
    cmtBoxHtml:'CmtBox',
    commentHtml : 'Comment',
    // 开启action点击监听
    actionMgr : TRUE,
    cmtBox : 'CmtBox',
    
    initUI : function(){
        // prepare for templting
        this.cmtUrl = Req.mkUrl('show', '', 'id='+this.wbId);
        this.jqExtra('pre','first','next');
        Base.prototype.initUI.call(this);
    },
    
    getFromUser : function(){
        if(!this.wbUid) {
		  var wb = getWb(this.wbId);
          this.wbUid = wb && wb.u.id;
		}
        return this.wbUid;
    },
    
    innerViewReady : function( v ){
       Base.prototype.innerViewReady.call(this, v);
       this.jqExtra('cmtCt', 'more', 'lefCnt');
       this.initCmtBox();
    },
    
    decorateLoading : function(){
        if( this.isLoading ){
            $(T.get('Loading')).appendTo(this.getView().parentNode);
        }else $(this.getView().parentNode).find('#xweibo_loading').remove();
        this.display(!this.isLoading);
    },
    
    initCmtBox : function(){
       this.cmtBox    = X.use('CmtBox', {
            view : this.jq('#cmtBox')[0],
            wbId : this.wbId,
            pCt  : this,
            headPicType : this.hdPicSz==30?1:2
       });
       this.cmtBox.getView();
    },
    
    load : function(callback){
        // 确保view已创建
        this.getView();
        if( !this.isLoading ){
            this.isLoading = TRUE;
            this.decorateLoading();
            callback && ( this.onload = callback );
            Req.getComments(this.wbId, this.page, this.cmtType,  Util.getBind(this, 'onCmtsLoad'));
        }
    },
        
    // callback by cmtBox
    postWeibo : function(wbData, htmls){
       // X.fire('wb.create', {data:wbData, html:htmls});
    },
    
    // callback by cmtBox
    afterSend : function(e){
        this.jqCmtCt.prepend( $(this.createCmtUI(e.getData().comment)) );
        this.jqCmtCt.cssDisplay(TRUE);
        this.updateCmtCountUI(1, TRUE);
    },
    
    // 评论返回后
    onCmtsLoad : function( e ){
        
        if( e.isOk() ){
            this.createListUI( e );
			var total = e.getData().total;
            total && this.updateCmtCountUI( total );
            this.updateCmtPageUI(e.getData());
        }
        
        this.isLoading = FALSE;
        this.decorateLoading();
        if( this.onload )
            this.onload( e );
    },
    
    // 创建评论列表
    createListUI : function( e ){
        this.jqCmtCt.empty();
        var listData = e.getData();
        var lef = listData.total - Math.min( listData.limit, listData.total );
        var htmls = [];
        e.each(function(cmt){
            htmls[htmls.length] = this.createCmtUI(cmt);
        }, this);
        
        if(htmls.length){
            this.jqCmtCt.html( htmls.join('') );
            if( lef ){
                this.jqMore.cssDisplay(TRUE);
                this.jqLefCnt.text(lef);
            }else this.jqMore.cssDisplay(FALSE);
            this.jqCmtCt.cssDisplay(TRUE);
        }else {
            this.jqCmtCt.cssDisplay(FALSE);
            this.jqMore.cssDisplay(FALSE);
        }
    },
    
    createCmtUI : function(cmt){
        var wbUid = this.getFromUser(),
			UID = getUid();
        cmt.verifiedHtml = cmt.user.verified_html;
        cmt.usrUrl= cmt.user.profileUrl;
        cmt.picSz = this.hdPicSz;
        cmt.time  = cmt.create_at;
        if (wbUid === UID || cmt.uid === UID)
            cmt.canDel = TRUE;
        return T.parse( this.commentHtml, cmt );
    },
    
    updateCmtPageUI : function(pageInfo){
        // 如果存在分页按钮
        if(this.jqPre.length){
            this.jqPre.cssDisplay(this.page !== 1);
            // 第三页后显示首页按钮
            this.jqFirst.cssDisplay(this.page >= 3);
            this.jqNext.cssDisplay(pageInfo.total != 0);
        }
    },
    
    updateCmtCountUI : function(count, cal){
        if( this.trigEl ){
            if(cal===UNDEFINED){
                $ (this.trigEl).text('评论('+count+')');
                this.cmtCount = count;
            }else { 
                this.cmtCount += count;
                $ (this.trigEl).text('评论('+this.cmtCount+')');
            }
        }
    },
    
    onactiontrig : function(e){
        switch ( e.data.e ){
            // 点击回复
            case 'rp' :
                this.onReplyTrig(e);
                break;
            case 'dl':
                this.onDelTrig(e);
                break;
            case 'nx' :
                this.goPage(this.page+1);
                break;
            case 'pr' :
                this.goPage(this.page-1);
            break;
            case 'fi':
                this.goPage(1);
            break;
        }
    },
    
    onDelTrig : function(e){
        var self = this;
        MB.anchorConfirm(e.src, '确定要删除该评论吗？', function(bid){
            if(bid === 'ok' && !self.deletingCmt){
                self.deletingCmt = TRUE;
                Req.delComment(e.get('c'), function(re){
                    var cmtEl = e.getEl('c');
                    if(re.isOk()){
                        $(cmtEl).remove();
                        self.updateCmtCountUI(-1, TRUE);
                        if(self.cmtCount == 0)
                            self.cmtBox.jqInputor.focus();
                    }else MB.tipError(re.getMsg());
                    self.deletingCmt = FALSE;
                });
            }
        });
    },
    
    onReplyTrig : function( e ){
        var cmtId = e.get('c'),
            nick  = e.get('n');
        this.cmtBox.reply(cmtId, nick);
    },
    
    goPage : function(page){
        this.page = page;
        this.load();
    }
}));

/**
 * @class Xwb.mod.MBlogCmtArea
 * 具体微博的评论区域
 * @extends Xwb.mod.CommentArea
 */
mod.MBlogCmtArea = X.reg('MBlogCmtArea', Util.create(mod.CommentArea, {
    
    commentHtml:'MBlogCmt',

	cmtType: 2,
	
	hdPicSz : 50,
    
    // override
    createListUI : function(e){
        this.jqCmtCt.empty();
        var listData = e.getData();
        var htmls = [];

		var facesize = this.faceSize;

        e.each(function(cmt){
			if (facesize){
				cmt.profileImg = cmt.profileImg.replace('/30/', '/'+facesize+'/');
			}

            htmls[htmls.length] = this.createCmtUI(cmt);
        }, this);
        
        this.cmtCount = htmls.length;
        
        if(htmls.length){
            this.jqCmtCt.html( htmls.join('') );
            this.jqCmtCt.cssDisplay(TRUE);
        }else {
            this.jqCmtCt.cssDisplay(FALSE);
            this.jqMore.cssDisplay(FALSE);
        }
    },
    
    initCmtBox : function(){
       this.cmtBox    = X.use('CmtBox', {
            wbId : this.wbId,
            pCt  : this,
            view : 'MBCmtBox',
            headPicType : this.hdPicSz==30?1:2
       });
       this.cmtBox.getView();
       this.topCmtBox = X.use('CmtBox', {
            wbId : this.wbId,
            pCt  : this,
            autoH : FALSE,
            view : this.topCmtBox,
            headPicType : this.hdPicSz==30?1:2
       });
       this.topCmtBox.getView();
    },
    
    updateCmtCountUI : $.noop,
    
    onReplyTrig : function(e){
       this.cmtBox.jq().insertAfter( e.jq('c').find('#trigs') );
        var cmtId = e.get('c'),
            nick  = e.get('n');
        this.cmtBox.display(TRUE).reply(cmtId, nick);
    },
    
    // callback by cmtBox, override
    postWeibo : $.noop,
    
    // callback by cmtBox
    afterSend : function(e){
        this.jqCmtCt.prepend( $(this.createCmtUI(e.getData().comment)) ).cssDisplay(TRUE);
        this.cmtBox.display(FALSE);
        this.topCmtBox.jqInputor.focus();
    },
    
    onload : function(){
        this.jq('#pager').cssDisplay(true);
        this.topCmtBox.jqInputor.focus();
    }
}));

/**
 * @class Xwb.mod.videoBox
 * 视频地址输入框，目前用于发布微博功能。
 * @extends Xwb.ui.Box
 * @singleton
 */
X.reg('videoBox', function(){

var inst = X.use('Box', {
  	cs:' win-insert',
  	contentHtml:'MediaBoxContentHtml',
  	boxOutterHtml:'ArrowBoxBottom',
  	appendTo:doc.body,
  	actionMgr : TRUE,
    closeable : TRUE,
  	contextable : TRUE,
  	onViewReady:function(v){
  		this.jqInputor = this.jq('#xwb_inputor');
  		this.jqTip     = this.jq('#xwb_err_tip');
  		this.selectionHolder = X.use('SelectionHolder', {elem:this.jqInputor[0]});
  	},

  	onactiontrig : function( e ){
  		switch(e.data.e){
  			case 'ok':
                var v = this.checkText();
                if( v ){
                    this.onselect && this.onselect(v);
                    this.close();
                }else this.jqInputor.focus();
  			break;
  			// cancel
  			case 'cc':
  				this.close();
  			break;
  			// normal link
  			case 'nm':
  				this.onselect && this.onselect($.trim(this.jqInputor.val()));
  				this.close();
  			break;
  		}
  	},
  	
  	checkText : function(){
  	    var jqInputor = this.jqInputor, 
  	        holder = this.selectionHolder,
  	        v = $.trim(jqInputor.val());
  	    if(v == '' || v == 'http://'){
  	        setTimeout(function(){
  	            jqInputor.focus();
  	            holder.setText('http://');
  	            jqInputor.select();
  	        });
  	        return FALSE;
  	    }else if(!this.checkUrl(v)){
  	        this.jqTip.cssDisplay(TRUE);
  	        return FALSE;
  	    }
  	    return  v;
  	},
  	
  	
    checkUrl : function(url){
        return url.indexOf('http://') === 0;
    },
    
    showAt : function(anchor, onselect){
        this.onselect = onselect;
        var off = $(anchor).offset();
        off.left -= 140;
        off.top += 20;
        this.offset(off)
            .display(TRUE);
        var self = this;
        setTimeout( function(){
            self.selectionHolder.setText('http://');
            self.jqInputor.focus();
            self.jqInputor[0].select();
        }, 0);
        this.jqTip.cssDisplay(FALSE);
    }
});

X.reg('videoBox', inst, TRUE);

return inst;

});

/**
 * @class Xwb.mod.musicBox
 * 音乐地址输入框，目前用于发布微博功能。
 * @extends Xwb.ui.Box
 * @singleton
 */
X.reg('musicBox', function(){

var inst = X.use('Box', {
  	cs:' win-insert',
  	contentHtml:'MusicBoxContentHtml',
  	boxOutterHtml:'ArrowBoxBottom',
  	appendTo:doc.body,
    closeable : TRUE,
  	actionMgr : TRUE,
  	contextable : TRUE,
  	onViewReady:function(v){
  		this.jqInputor = this.jq('#xwb_inputor');
  		this.jqTip     = this.jq('#xwb_err_tip');
  		this.selectionHolder = X.use('SelectionHolder', {elem:this.jqInputor[0]});
  	},

    
  	checkText : function(){
  	    var jqInputor = this.jqInputor,
  	        v = $.trim(jqInputor.val()),
  	        holder = this.selectionHolder;
  	        
  	    if(v == '' || v == 'http://'){
  	        setTimeout(function(){
  	            jqInputor.focus();
  	            holder.setText('http://');
  	            jqInputor[0].select();
  	        });
  	        return FALSE;
  	    }else if(!this.checkUrl(v)){
  	        this.jqTip.cssDisplay(TRUE);
  	        return FALSE;
  	    }
  	    return  v;
  	},
  	
  	checkUrl : function(url){
        return url.indexOf('http://') === 0;
  	},
  	
  	onactiontrig : function( e ){
  		switch(e.data.e){
  			case 'ok':
                var v = this.checkText();
                if( v ){
                    this.onselect && this.onselect(v);
                    this.close();
                }else this.jqInputor.focus();
  			break;
  			// cancel
  			case 'cc':
  			    this.onselect && this.onselect();
  				this.close();
  			break;
  			// normal link
  			case 'nm':
  				this.onselect && this.onselect($.trim(this.jqInputor.val()));
  				this.close();
  			break;
  		}
  	},
  	
    showAt : function(anchor, onselect){
        this.onselect = onselect;
        var off = $(anchor).offset();
        off.left -= 140;
        off.top += 20;
        this.offset(off)
            .display(TRUE);
        var self = this;
        setTimeout( function(){
            self.selectionHolder.setText('http://');
            self.jqInputor.focus();
            self.jqInputor[0].select();
        }, 0);
        this.jqTip.cssDisplay(FALSE);
    }
});

X.reg('musicBox', inst, true);

return inst;
});

/**
 * @class Xwb.mod.PostBase
 * 发布微博功能基类，
 * 所有属性和方法被复制到子类，子类初始化后调用{@link #initEx}方法初始化基类。
 */
mod.PostBase = {
    
    actionMgr : TRUE,

    initEx : function(){
        var jqInputor = this.jqInputor = this.jq('#xwb_inputor');
        var jqSendBtn = this.jqSendBtn = this.jq('#xwb_send_btn');
		var jqInputorParent = this.jq(this.focusEl||'#focusEl');
        
        this.jqWarn      = this.jq('#xwb_word_cal');
        this.jqImgFile   = this.jq('#xwb_img_file');
        this.jqBtnImg    = this.jq('#xwb_btn_img');
        this.jqUploadTip = this.jq('#xwb_upload_tip');
        this.jqPhotoName = this.jq('#xwb_photo_name');
        this.jqForm      = this.jq('#xwb_post_form');
        
        this.selectionHolder = X.use('SelectionHolder', {elem:this.jqInputor[0]});
        
        var self = this;
        
        this.jqImgFile.change(function(e){
            self.onImgFileChange(e);
        });
        
        if( this.btnHoverCS )
            jqSendBtn.hover(
                function(){ jqSendBtn.addClass(self.btnHoverCS); }, 
                function(){ jqSendBtn.removeClass(self.btnHoverCS); }
            );

        jqInputor
        .bind('keyup', function(e){
            self.onInputorKeyup(e);
        })
		.bind('focus', function(e) {
			jqInputorParent.addClass('post-focus');
		})
		.bind('blur', function() {
			jqInputorParent.removeClass('post-focus');	
		});
    },

    getUploader : function(){
        if(!this.uploader)
            this.uploader = X.use('Uploader', {
                form:this.jqForm[0], 
                action : Req.mkUrl('api/weibo/action', 'upload_pic'),
                onload:Util.getBind(this, 'onUploadLoad')
            });
        return this.uploader;
    },
    
    reset : function(){
        this.jqUploadTip.cssDisplay(FALSE);
        this.jqPhotoName.cssDisplay(FALSE);
        this.jqBtnImg.cssDisplay(TRUE);
        this.jqForm.cssDisplay(TRUE);
        this.selectionHolder.setText('');
        this.jqForm[0].reset();
        this.uploadPic = FALSE;
        this.checkText();
        this.sending = FALSE;
        return this;
    },
    
    onactiontrig : function(e){
        switch(e.data.e){
            case 'sd' :
                this.post();
                break;
            case 'ic' :
                X.use('emotion')
                 .setSelectionHolder( this.selectionHolder , this.checkText, this)
                 .showAt(e.src);
            break;
            case 'vd' :
                 X.use('videoBox')
                  .showAt(e.src, Util.getBind(this, 'onBoxTextReturn'));
            break;
            case 'ms' :
                  X.use('musicBox')
                   .showAt(e.src, Util.getBind(this, 'onBoxTextReturn'));
            break;
            case 'tp' :
                this.insertTopic();
            break;
            // 删除已上传图片
            case 'dlp':
                this.uploadPic = FALSE;
                this.jqBtnImg.cssDisplay(TRUE);
                this.jqForm.cssDisplay(TRUE);
                this.jqPhotoName.cssDisplay(FALSE);
                this.jqInputor.focus();
                break;
        }
    },
    
    onBoxTextReturn : function(text){
        if(text)
            this.selectionHolder.insertText(text);
        this.checkText();
    },
    
    checkText : function(){
        var v = $.trim( this.jqInputor.val() );
        var left = Util.calWbText(v);
        if (left >= 0)
            this.jqWarn.html('您还可以输入<span>'+left+'</span>字')
                .removeClass(exceedCS);
        else
            this.jqWarn.html('已超出<span>'+Math.abs(left)+'</span>字')
                .addClass(exceedCS);
                
        return left>=0 && v;
    },
    
    checkImg : function(fileName){
		var pieces = fileName.split('.');
		return pieces.length && $.inArray(pieces.pop().toLowerCase(), ['jpg', 'png', 'gif','jpeg']) !== -1;
    },
    
    onInputorKeyup : function(){
        this.checkText();
    },
    
    TOPIC_TIP : '请在这里输入自定义话题',
    
    insertTopic : function(topic){
        if(!topic)
            topic = this.TOPIC_TIP;
        var inputor = this.jqInputor[0];
        var hasCustomTopic = new RegExp('#'+this.TOPIC_TIP+'#').test(inputor.value);
        var text = topic, start=0,end=0;
        
        inputor.focus();
        
        if (document.selection) {
            var cr = document.selection.createRange();
            //获取选中的文本
            text = cr.text || topic;
        
            //内容有默认主题，且没选中文本
            if (text == topic && hasCustomTopic) {
                start = RegExp.leftContext.length + 1;
                end   =   topic.length;
            }
            //内容没有默认主题，且没选中文本
            else if(text == topic) {
                cr.text = '#' + topic + '#';
                start = inputor.value.indexOf('#' + topic + '#') + 1;
                end   = topic.length;
            }
            //有选中文本
            else {
                cr.text = '#' + text + '#';
            }
        
            if (text == topic) {
                cr = inputor.createTextRange();
                cr.collapse();
                cr.moveStart('character', start);
                cr.moveEnd('character', end);
            }
        
            cr.select();
        }
        else if (inputor.selectionStart || inputor.selectionStart == '0') {
            start = inputor.selectionStart;
            end = inputor.selectionEnd;
        
            //获取选中的文本
            if (start != end) {
                text = inputor.value.substring(start, end);
            }
        
            //内容有默认主题，且没选中文本
            if (hasCustomTopic && text == topic) {
                start = RegExp.leftContext.length + 1;
                end = start + text.length;
            }
            //内容没有默认主题，且没选中文本
            else if (text == topic) {
                inputor.value = inputor.value.substring(0, start) + '#' + text + '#' + inputor.value.substring(end, inputor.value.length);
                start++;
                end = start + text.length;
            }
            //有选中文本
            else {
                inputor.value = inputor.value.substring(0, start) + '#' + text + '#' + inputor.value.substring(end, inputor.value.length);
                end = start = start + text.length + 2;
            }
        
            //设置选中范
            inputor.selectionStart = start;
            inputor.selectionEnd = end;
        }
        else {
            inputor.value += '#' + text + '#';
        }
        
        this.checkText();
        this.selectionHolder.saveSpot();
    },
    
    post : function(){
        var text = this.checkText();
        
        if(!text){
            this.jqInputor.focus();
            return;
        }

        if( this.getUploader().isLoading() ){
            MB.tipWarn('图片正在上传，请稍候..');
            return;
        }
        
        if(this.sending){
            MB.tipWarn('正在发布,请稍候..');
            return;
        }
        
        
        this.sending = TRUE;
        
        // 传递当前页面标识_route，以返回不同HTML内容
        Req.post(text, Util.getBind(this, 'onSendLoad'), this.uploadPic, { data : {_route:X.getModule() }});
    },
    
    onImgFileChange : function(){
        var jq = this.jqImgFile;
        var fn = jq.val(), self = this;
        
        this.uploadPic = NULL;
        
        if( !fn || !this.checkImg(fn) ){
            this.jqForm[0].reset();
            MB.alert('', '只支持 jpg、png、gif 的图片。', function(){
                self.jqInputor.focus();
            });
            return ;
        }
        this.jq('#xwb_upload_tip').cssDisplay(TRUE);
        this.jqForm.cssDisplay(FALSE);
        this.jqBtnImg.cssDisplay(FALSE);
        // add submit disabled class
	    this.getUploader().upload();
    },
    
    onUploadLoad : function(e){
        if( e.isOk() ){
            var data = e.getData();
            this.uploadPic = data.msg;
            this.jqPhotoName.html(Util.getFileName(this.jqImgFile.val(), 10) + T.get('UploadImgBtn') );
            this.jqPhotoName.cssDisplay(TRUE);
            !$.trim(this.jqInputor.val()) && this.selectionHolder.setText('分享图片');
            this.checkText();
        }else {
            MB.alert('', e.getMsg());
            this.jqBtnImg.cssDisplay(TRUE);
            this.jqForm.cssDisplay(TRUE);
        }
        this.jqUploadTip.cssDisplay(FALSE);
        this.jqForm[0].reset();
        this.jqInputor.focus();
        // remove disabled class
    },
    
    onSendLoad : function( e ){
        var jqInputor = this.jqInputor;
        if(e.isOk()){
            var jqMask = this.jqMask;
            if(!jqMask){
                this.jqMask = jqMask = this.jq('#xwb_succ_mask');
                this.jqMaskPt = jqMask.parent();
            }
            
            jqMask.cssDisplay(true)
                  .show()
                  .appendTo(this.jqMaskPt);

            jqInputor.focus();
            var self = this;
            jqMask.fadeOut(1800, function(){
                // 修正IE下滤镜使得层不会隐藏的BUG，
                // 如果不移除，则不会隐藏
                jqMask.remove();
                jqMask[0].style.filter = null;
                self.reset();
            });
            
            // 发送新微博事件
            // X.fire('wb.create', e.getData(), e);
        }else {
            MB.alert('', e.getMsg(), function(){
                Util.focusEnd(jqInputor[0]);
            });
        }
    }
};

/**
 * @class Xwb.mod.postBox
 * 发布微博弹出框
 * @extends Xwb.ui.Box
 * @extends Xwb.mod.PostBase
 * @singleton
 */
 
// 这写法是调用时才实例化
X.reg('postBox', function(){
    
    var inst = $.extend({}, mod.PostBase);
    
    $.extend(inst, {
        
        title : '发微博',
        
        closeable : TRUE,
        autoCenter : TRUE,
        appendTo : doc.body,
        
        mask : TRUE,
        
        cs : 'win-post',
        
        contentHtml : 'PostBoxContent',

        onViewReady : function(v){
            this.initEx();
        },
        
        onbuttonclick : function(bid){
            if( bid == 'ok'){
                this.post();
                // 取消对话框关闭
                return FALSE;
            }
        },
        
        // override
        
        onSendLoad : function(e){
            mod.PostBase.onSendLoad.call(this, e);
            if( e.isOk()){
                var self = this;
                setTimeout(function(){
                    self.close();
                    // fix bug#334,IE下光标隐藏后不消失
                    self.jqInputor[0].blur();
                }, 500);
            }
        }
    });
    
    inst = X.use('Box', inst);
    
    X.reg('postBox', inst, TRUE);
    
    return inst;
});

/**
 * @class Xwb.mod.WeiboList
 * 微博列表UI
 * @extends {Xwb.ui.Base}
 */
mod.WeiboList = X.reg('WeiboList', Util.create(Base, {
    
    ctNode : '#xwb_weibo_list_ct',
    
    innerViewReady : function(v){
        Base.prototype.innerViewReady.call(this, v);
        this.jqCt = this.jq(this.ctNode);
        // unsyncList属性置为真时不监听微博更新列表
        if(this.syncList){
            X.on('api.update', this.onWbCreate, this);
        }
    },
    
    // 插入到weibo list
    // item = {data:wbData, html:html}
    // 出于性能考虑，该UI类只维护追加新微博HTML内容到列表，
    // 不维护删除某此微博内容，删除列表中某条微博内容由其它功能自己实现。
    // 不排除以后根据需要实现该功能。
    onWbCreate : function(e){
        var item = e.getData();
        this.append(item.data.id, item.data, item.html);
    },
    
    /**
     * 追加微博到列表
     * @param {String} weiboId
     * @param {Object} weiboData
     * @param {String} weiboHtml
     */
    append : function(id, item, html){
        this.item(id, item);

        if(html){
            html = $.trim(html);
            var self = this;
            $(html).prependTo(this.jqCt)
                   .hide()
                   .fadeIn(1000, function(){
                        var obj = {};
                        obj[id] = item;
                        self.renderLink(obj);
                   });
        }
    },
    
    item : function(id, v){
        if( v === UNDEFINED )
            return getWb(id);
        setWb(id, v);
    },
    
    renderLink : function(envlope){
		ui.linkRender(envlope);
    }
}));

/**
 * @class Xwb.mod.SearchEntry
 * 搜索框
 * @extends Xwb.ui.Base
 */
mod.SearchEntry = X.reg('SearchEntry', Util.create(Base, {
    focusText : '搜微博/找人',
    focusCs   : 'search-box-focus',
    // 30个字节
    maxLen    : 30,
    
    innerViewReady : function(v){
        Base.prototype.innerViewReady.call(this, v);
        var jqInputor = this.jqInputor = this.jq('#xwb_inputor'),
            jqTrigBtn = this.jq('#xwb_trig'),
            self = this;

        jqTrigBtn.click(function(){
            return self.submit();
        });
        
        
        jqInputor.keydown(function(e){
            var kc = e.keyCode;
            if(kc===13)
                self.submit();
        });
        
        if(this.focusText)
            jqInputor.focusText(this.focusText, this.focusCs, this.getView());
    },

 
    submit : function(){
        var kw = $.trim(this.jqInputor.val());
        if(kw == this.focusText)
            kw = '';
        if(!kw){
            this.jqInputor.focus();
        }else {
            var kw = encodeURIComponent( Util.byteCut(kw, this.maxLen) ),
                url = Req.mkUrl('search','', 'k=' + kw);
            window.location.href = url;
        }
    }
}));


(function() {

	function getShortID(data) {
		var data = data || getWb();
		
		var result = {
			urls: [],
			map: {}
		}, tmp, url_id;

		if (data) {
			var matchs, map = result.map, urls = result.urls;
			
			var reg = /http:\/\/sinaurl\.cn\/([0-9a-z]+)/gi;
			
			for (var i in data) {

				$.each([data[i], data[i].rt], function(idx, ele){
					if (!ele) 
						return;
					var txt = ele.tx;
					
					while (reg.test(txt)) {
						url_id = RegExp.$1;
						
						if (!map[url_id]) {
							map[url_id] = [];
						}
						
						urls.push(url_id);
						map[url_id].push([i, idx]);
					}
				});
			}
		}

		return result.urls.length ? result : NULL;
	}

	/**
	 * @param {HTMLElement} domWb 微博
	 * @param {String} sid 短链接
	 * @param {Object} linkInfo 短链接信息
	 * @private
	 */
	function urlRender(domWb, link_id, info, isFw) {
		var type = info.type, link = 'http://sinaurl.cn/'+link_id, $domWb = $(domWb);

		var $forward = $domWb.find('div.forward'),
			$feedMain = $domWb.find('p.feed-main'),
			$links;

		if (isFw)
		{
			$links = $forward.next('p').find('a[href='+link+']');
		} else {
			$links = $feedMain.find('a[href='+link+']');
		}

		switch (type)
		{
			case 'music':
				$links
				.attr('title', info.url)
				.addClass('icon-music-url icon-bg');
				break;
			
			case 'video':
				$links
				.attr('title', info.title)
				.addClass('icon-video-url icon-bg');

				//检测是否有preview的div，没就生成
				var $preview;
				if (isFw)
				{
					$preview = $forward.find('>div.preview-img');
					if (!$preview.length)
					{
						$preview = $(T.parse('PreviewBox')).appendTo($forward);
					}
				} else {
					$preview = $feedMain.next('div.preview-img');
					if (!$preview.length)
					{
						$preview = $(T.parse('PreviewBox')).insertAfter($feedMain);
					}
				}

				//URL在转发区->添加缩略图
				//URL在非转发并且该微博是原创 -> 添加缩略图
				if (isFw || (!isFw && !$forward.length))
				{
					$links.attr('rel', 'e:pv,i:'+link_id);
					var thumb = T.parse('VideoThumbHtml', {img: info.screen,id:link_id});
					$(thumb).appendTo($domWb.find((isFw? 'div.forward ':'')+'div.preview-img'));
				}
				break;

			case 'url':
			default:
				$links.attr('title', info.url)
				break;
		}
	};

	ui.linkRender = function(data) {
        
        var ids = getShortID(data);
		
		if (!ids)
		    return;

		Req.sinaurl(ids.urls.join(','), function(e) {
			var CFG = X.cfg;

			if (e.isOk()) {
				var data = e.raw.data;
				var map = ids.map;

				if (CFG.urls)
				{
					$.each(data, function(sid, dat) {
						CFG.urls[sid] = dat;
					});

				} else {
					CFG.urls = data;
				}

				$.each(data, function(k, info) {

					$.each(map[k], function(i, m) {
						var wid = m[0], 
							isFw = m[1];

						urlRender($('div.feed-list>ul>li[rel=w:' + wid + ']'), k, info, isFw);
					});
				});
			}
		});
	}
})();

/**
 * @class Xwb.mod.myMsg
 * 发私信弹出框
 * @extends Xwb.ui.Box
 * @singleton
 */
X.reg('myMsg', function(){

var inst = X.use('Box', function(proto){

return {
    contentHtml:'PrivateMsgContent',
    appendTo:doc.body,
    cs:'win-mes',
    actionMgr : TRUE,
    title:'发私信',
    autoCenter : TRUE,
    closeable:TRUE,
    mask:TRUE,
    onViewReady : function( v ){
        var self = this;
        this.jqExtra('word', 'warn', 'sender', 'content', 'warnPos', 'uid');
        this.jqContent.keyup(Util.bind(this.checkText, this));
        this.jqSender.blur(function(){
            var v = $.trim(this.value);
            self.checkFans(v,1,NULL,TRUE);
        });
        this.selectionHolder = X.use('SelectionHolder', {elem:this.jqContent[0]});
    },
    
    checkText : function(){
        var v = $.trim(this.jqContent.val()),
            left = Util.calWbText(v, 140);
        this.jqWord.html(
            left >= 0 ? '您还可以输入'+left+'个字' : '已超出' + Math.abs(left) + '字'
        );
        return left>=0 && v;
    },
    
    afterShow : function(){
        proto.afterShow.call(this);
        if( this.jqSender.val() === '' )
            this.jqSender.focus();
        else this.jqContent.focus();
    },
    
    onactiontrig : function( e ){
        switch(e.data.e){
            // 点击发送
            case 'sd' :
                this.send();
            break;
            case 'ic':
                 X.use('emotion')
                  .setSelectionHolder( this.selectionHolder , this.checkText, this)
                  .showAt(e.src);
            break;
        }
    },
    
    send : function(){
        if(!this.sending){
            var d = this.validate(), 
                fn = Util.getBind(this, 'onSendLoad'),
                sndBtn = this.jqSendBtn;
            if(d){
                this.checkFans( d.u, d.t, function(){
                    Util.disable( sndBtn, TRUE);
                    Req.msg(d.u, d.t, d.c, fn);
                });
            }
        }
    },
    
    onSendLoad : function( e ){
        if(e.isOk()){
            this.display(FALSE);
        }else {
            var msg;
            switch(e.getCode()){
                case 20014:
                    MB.alert('', e.getMsg());
                    break;
                case 1010005:
                    alert('内容长度不能超过140个字。');
                    this.jqContent.focus();
                    break;
                default : msg = e.getMsg();
            }
            if(msg && this.display()){
                this.jqWarnPos.cssDisplay(TRUE).text(msg);             
            }
        }
        this.sending = FALSE;
        Util.disable( this.jqSendBtn, FALSE);
    },
    
    checkFans : function(user, type, onsuccess, disableFocus){
		 var self = this; 

		if (!user)
		{
			self.jqWarnPos.cssDisplay(TRUE)
                .text('请输入要发送的用户昵称。');
			return;
		}

          // 对方是否为我的粉丝
          Req.followed(
            user,
            function( e ){
                if(e.isOk()){
                    if(e.getData()){
                        self.jqWarnPos.cssDisplay(FALSE);
                        onsuccess && onsuccess.call(this, e);
                    }else {
                        self.jqWarnPos.cssDisplay(TRUE)
                            .text(Req.ERRORMAP['20016']);
                        !disableFocus && self.jqSender.focus();
                    }
                }else {
                    self.jqWarnPos.cssDisplay(TRUE)
                        .text(e.getMsg());
                    !disableFocus && self.jqSender.focus();
                }
            },
            type
          );
    },
    
    /***/
    reset : function(){
        this.jqSender.attr('disabled', FALSE).val('');
        this.jqContent.val('');
        this.jqUid.val('');
        this.jqWarnPos.cssDisplay(FALSE);
        this.checkText();
        return this;
    },
    
    validate : function(){
        var name    = $.trim(this.jqSender.val()),
            content = this.checkText(),
            uid     = this.jqUid.val();
        
        if(!name){
            this.jqSender.focus();
            return;
        }
        
        if(!content){
            if(!$.trim(this.jqContent.val()).length)
                alert('请输入私信内容。');
            else alert('内容长度不能超过140个字。');
            this.jqContent.focus();
            return;
        }
        
        if(uid)
            return {u:uid, c:content};
        return {u:name, c:content,t:1};
    },
    
    reply : function(uid, name){
        this.getView();
        this.reset();
        this.display(TRUE);
        this.jqSender.val(name).attr('disabled', TRUE);
        this.jqUid.val(uid);
        this.jqContent.focus();
        this.checkText();
    }
};

});



X.reg('myMsg', inst, TRUE);

return inst;

});

/**
 * @class Xwb.mod.notice
 * 消息提示浮层
 * @extends Xwb.ui.Box
 * @singleton
 */
X.reg('notice', function( cfg ){

var inst = X.use('Layer', function(proto){

    return $.extend({
        view : 'NoticeLayer2',
        hidden : TRUE,
        closeable : TRUE,
        actionMgr : TRUE,
        remindType:1, 
        // 关闭后是否清空消息
        clearOnClose : TRUE,
        // 该数组下标顺序对应后台返回的类型数组下标
        types : ['wbs', 'refer','cmts', 'fans', 'msgs'],
        wbsUrl : Req.mkUrl('index'),
        referUrl : Req.mkUrl('index', 'atme'),
        cmtsUrl : Req.mkUrl('index', 'comments'),
        msgsUrl : Req.mkUrl('index', 'messages'),
        fansUrl : Req.mkUrl('index', 'fans'),
        initUI : function(){
            if( this.remindType )
                this.view = 'NoticeLayer';
            proto.initUI.call(this);
            this.getView();
            // 监听轮询事件
            X.on('api.unread', Util.bind(this.unreadLoad, this));
        },
        
        push : function(type, num){
            var jqItem = this.jq('#'+type),
                jqCnt  = jqItem.find('#c'),
                cur    = parseInt(jqCnt.text());

            // 数目与原先不同，显示或隐藏单条
            if( num != cur ){
                jqCnt.text(num);
                jqItem.cssDisplay(!!num);
            }
            
            // 显示主面板
            if(num && !this.display())
                this.display(TRUE);
        },
        
        onclose : function(){
            if(this.clearOnClose)
                this.clearUnread();
        },
        
        clearUnread : function(){
            var self = this;
            $.each(this.types, function(){
                var item = self.jq('#'+this);
                item.cssDisplay(FALSE);
                item.find('#c').text('0');
            });
            // 清零服务器
            Req.clearUnread('', $.noop);
        },
        
        unreadLoad : function( e ){
            if(e.isOk()){
                // [好友新微博数,@me数,评论数,粉丝,私信]
                var unread = e.getData().unread;
                var none = true;
                // 目前提示面板不计好友新微博数
                for(var i=1,len=this.types.length;i<len;i++){
                    if(unread[i]){
                        this.push(this.types[i], unread[i]);
                        none = false;
                    }
                }
                // 全为0时隐藏面板
                if(none)
                    this.display(false);
            }
        }
    }, cfg);
});


X.reg('notice', inst, TRUE);

return inst;

});


// 换肤
/**
 * @class Xwb.mod.Skin
 * 提供换肤功能
 * @extends Xwb.ui.Base
 */
X.mod.Skin = function(opt){
    var inst = X.use('base', $.extend({
        
        actionMgr : TRUE,
        
        skinSelectedCS : 'current',
        
        onViewReady : function(v){
            this.tab = X.use('Switcher', this.tab);
        },
        
        onactiontrig : function(e){
            switch(e.data.e){
                // change skin
                case 'cs' :
                    this.change(e.get('sk'), e.get('id'));
                    this.decorateSelected(e.src);
                break;
                // 保存
                case 'sv' :
                    if(this.using){
                        this.save(this.using);
                    }else {
                    	this.display(FALSE);
                    	this.reload();
                    }
                break;
                // 取消
                case 'cc' :
                    if(this.usedSkin)
                        this.change(this.usedSkin);
                    this.close();
                    this.reload();
                break;
            }
        },
        
        beforeHide : function(){
            // #IE7下，关闭浮层#header CSS样式表现不正确，需要reflow才能显示正确。
            if($.browser.msie){
                var dv = X.Cache.get('div');
                $('#wrapper').css('clear','both');
                X.Cache.put(dv);
            }
        },
        
        change : function(skin, id){
            var self = this;
            $('link[rel=stylesheet]').each(function(){
                if(this.href.indexOf('/skin.css') !== -1){
                    // 保存最初skin，方便恢复
                    if(!self.usedSkin)
                        self.usedSkin = this.href.match(/\/css\/default\/([\S\s]*?)\/skin.css$/i)[1];
                    this.href = this.href.replace(/\/css\/default\/[\S\s]*?\/skin.css$/i, '/css/default/'+skin+'/skin.css');
                }
            });
            this.using = id;
        },
        
        save : function(skinId){
            var self = this;
            Req.saveSkin(skinId, function(e){
                if(e.isOk()){
                    self.display(FALSE);
                    self.reload();
                }else MB.alert('', e.getMsg());
            });
        },
        
        reload : function() {
        	var reg = /skinset[^A-Za-z0-9\/]{1}1/g;
        	window.location = String(window.location.href).replace(reg, '');
        },
        
        decorateSelected : function(currentEl){
            if(!this.jqPreSel)
                this.jqPreSel = this.jq('#tabPanels .'+this.skinSelectedCS);
            this.jqPreSel.removeClass(this.skinSelectedCS);
            this.jqPreSel = $(currentEl);
            this.jqPreSel.addClass(this.skinSelectedCS);
        }
        
    }, opt));
    return inst;
};

/**
 * @class Xwb.mod.feedback
 * 意见反馈浮层
 * @extends Xwb.ui.Box
 * @singleton
 */
X.reg('feedback', function(opt){
    var inst = X.use('Box', $.extend({
        view:$('#feedbackBox')[0],
        mask:true,
        closeable:true,
        onViewReady : function(){
            // 三栏模式下，浮层不在BODY内，
            // 此时添加到BODY元素内
            if(this.view.parentNode !== doc.body)
                this.appendAt(doc.body);

            var jqForm = this.jq('#fbForm');
            this.validator = X.use('Validator', {
                form:jqForm,
                trigger:this.jq('#trig'),
                onsuccess : function(data, next){
                    Req.feedback(data, function(e){
                        if(!e.isOk())
                            MB.tipWarn(e.getMsg());
                        inst.close();
                        next();
                    });
                    return false;
                }
            });
        },
        afterShow : function(){
            X.ui.Box.prototype.afterShow.call(this);
            this.reset();
        },
        
        reset : function(){
            this.jq('[name=content]').val('').focus();
            this.jq('[name=mail]').val('邮箱地址');
            this.jq('[name=qq]').val('QQ');
            this.jq('#feedbackTip').cssDisplay(false);
        }
    }, opt));
    
    X.reg('feedback', inst, true);
    
    return inst;
});

// 弹出oauth登录窗口
ui.oAuthLogin = {
	logWin: NULL,

	show: function(action, from) {
		var logWin = this.logWin, self = this;

		if (logWin && !logWin.closed)
		{
			logWin.focus();

		} else {
			var act = action || '',
                
                url = Req.mkUrl('account', 'sinaLogin', 'popup=1&cb=' + act);
                
                if (from) {
                    url += '&from=' + from;
                }
                
			this.logWin = window.open(
				url, 
				"logWin","resizable=1,location=0,status=0,scrollbars=0,width=510,height=400"
			);
			
			if (!window.loginCallback)
			{
				window.loginCallback = function(go) {
					self.logWin.close();
					if (go)
					{
						window.location.href = go;
					} else {
						var page = X.getCfg('page');
						//如果在首页或者广场，刷新
						if (!page.indexOf('pub') || !page.indexOf('index'))
						{
							window.location.reload();
						} else {
							window.location.href = Req.mkUrl('pub');
						}
					}
				}
			}
		}
	},
	
	bind: function(ele, type) {
		var type = type || 'click';

		var self = this;

		$(ele).bind(type, function() {
			self.show();
		});
	}
}

/**
 * @class Xwb.mod.LoginBox
 * 登录框
 * @extends Xwb.ui.Box
 */
ui.LoginBox = X.reg('LoginBox', function(){

	var inst = X.use('Box', {
		
		contentHtml : 'Login',
		
		cs : 'win-bind-login win-fixed',
		
		appendTo : doc.body,

		mask:TRUE,

		siteName: getCfg('siteName'),

		siteLoginUrl: Req.mkUrl('account', 'siteLogin'),

		regUrl: X.getCfg('siteReg'),
		
		sinaRegUrl: X.getCfg('sinaReg'),
		
		closeable : TRUE,
			
		onViewReady: function() {
			ui.oAuthLogin.bind(this.jq('#oauth'));
		}
	});

	// override function -> object
	X.reg('LoginBox', inst, TRUE);

	return inst;
});

/**
 * @class Xwb.mod.FadeShow
 * 今日话题切换效果
 * @extends Xwb.ui.Base
 */
// 今日话题切换效果
mod.FadeShow = X.reg('FadeBox', Util.create(Base, {
	curr: 0,

	length: 0,

	duration: 300,
	
	delay: 5000,
	
	running: FALSE,

	runTimer: NULL,

	onViewReady: function() {
	  var j = this.jq;

	  this.$list = $(this.view).children();

	  this.length = this.$list.length;

	  var self = this;

	  $(this.view).mouseover(function() {
		  
		  self.stop();

	  }).mouseout(function(e) {

		  var relatedTarget = e.relatedTarget;

		  if (!relatedTarget || !$.contains(self.view, relatedTarget))
		  {
			  self.start();
		  }
	  });

	  this.start();
	},

	start: function() {
		if (this.length <= 1)
		{
			return;
		}

		if (!this.runTimer)
		{
			var self = this;

			this.runTimer = setTimeout(function() {
				self.fade();
			}, this.delay);

			this.running = TRUE;
		}
	},

	stop: function() {
		if (this.runTimer)
		{
			clearTimeout(this.runTimer);
			this.runTimer = NULL;
		}
		this.running = FALSE;
	},

	fade: function() {
	  //todo: 将要显示的元素
	  var curr = this.curr,
		  next = ++this.curr,
		  self = this;
	  
	 

	  if (next >= this.length)
	  {
		  this.curr = next = 0;
	  }

	  var $curr = $(this.$list[curr]),
		  $next = $(this.$list[next]);

		$curr.animate({'opacity': 0}, {
			'duration': self.duration,
			'complete': function() {
				$curr.addClass('next');

				$next.removeClass('next')
				.css({'opacity':0})
				.animate({'opacity':1}, {
					'duration': self.duration, 
					'complete': function() {
						self.runTimer = NULL;
						self.running && self.start();
					}
				})
			}
		});


	}
}));

/**
 * @class Xwb.mod.HoverList
 * 列表mouseover，mouseout效果，例如粉丝页、关注页飘过动作可用本类。
 * @extends Xwb.ui.Base
 */
X.mod.HoverList = Util.create(Base, {
    innerViewReady : function(){
        Base.prototype.innerViewReady.call(this);
        this.jq(this.itemSelector)
            .hover(this.onMouseOver, this.onMouseOut);
    },
    onMouseOver : $.noop,
    onMouseOut : $.noop
});

X.reg('MoreList', function(cfg) {
	var layer = X.use('Layer', $.extend({
	    
		closeable: TRUE,

		contextable: TRUE,

		actionMgr: TRUE,
		
		onactiontrig: function(e) {
			var data = e.data;
			var uid = e.get('u');

			switch (data.e){
    			case 'abl':
    				MB.confirm('提示', 
    				           '确定将'+data.nick+'加入到黑名单吗？<span>你和' + 
    				              (data.gender == 'f' ? '她': '他') + 
    				              '将自动解除关注关系，并且她不能再关注你，给你发评论、私信、@通知。</span>', 
    				           function(click) {
                					if (click === 'ok'){
                						Req.blacklistAdd(uid, '', function(e) {
                							if (e.isOk()) {
                								window.location.reload();
                							}
                						});
                					}
    				            });
    			break;
			}
		}
	}, cfg));

	X.reg('MoreList', layer, TRUE);

	return layer;
});

/**
 * 数据上报
 * @method report
 * @member Xwb
 */
X.report = (function() {
	//上报地址
	var url = 'http://beacon.x.weibo.com/a.gif',

	//图片对象
		img,

		//用户ID，如果未登录，生成一个随机ID
		uid,

		//初始化上报参数
		reqOpt = {
			pjt: 'xwb',
			ver: '1.2',
			xt: 'stay'
		};

	//生成随机ID
	function genId(num) {
		var str = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';
		var len = str.length;

		var num = num || 16;

		var chars = ['u'], at;
		for (var i = 0 ;i< num ;i++)
		{
			at = Math.ceil(Math.random()*len)-1;
			chars.push(str.charAt(at));
		}

		return chars.join('');
	}

	//取得用户ID
	function getUid() {
		var uid = X.getCfg('uid');
		var cookieName = 'x3w4b';

		if (!uid)
		{
			uid = $.cookie(cookieName)

			if (!uid)
			{
				uid = genId();
				$.cookie(cookieName, uid, {
					expires: 90000
				});
			}

			return uid
		}

		return uid;
	}

	function report(params) {
		reqOpt.random = Math.random();
		reqOpt.uid = getUid();
		reqOpt.akey = X.getCfg('akey');

		var opt = $.extend(reqOpt, params);
		
		var qstrs = [];

		$.each(opt, function(i, k) {
			qstrs.push(i + '=' + encodeURIComponent(k));
		});

		img.src = url + '?' + qstrs.join('&');
	}

	//在线时长汇报
	var olReporter = (function() {
		var timer,
			//上报间隔
			interval = 1800000,
//			interval = 5000,

			//初始化状态
			inited = FALSE,
				
			bootTime = new Date().getTime(),

			lastTime = 0,
				
			uid;

		function init() {
			if (inited)
			{
				return;
			}

			uid = getUid();

			img = new Image();

			inited = TRUE;
		}

		function doReport() {
			var now = new Date().getTime();

			report({
				time: now - (lastTime ? lastTime: bootTime),
				p: X.getCfg('page')
			});

			lastTime = now;
		}

		return {
			start: function() {
				init();
				timer = window.setInterval(doReport, interval);
			},

			report: function() {
				!inited && init();
				doReport();
			}
		}
	})();

	return {
		start: function() {
			olReporter.start();
		},

		report: function() {
			olReporter.report();
		}
	}

})();

/**
 * @class Xwb.mod.AdMgm
 * 广告管理模块
 */
X.mod.AdMgm = {
    
    /**
     *  传入所有广告配置初始化广告内容管理。
     *  [{"flag":"global_bottom","cfg":{}},...]
     * @param {Array} adConfigList
     */
    init : function(adConfigList){
        adConfigList = this.cfgs = adConfigList || {};
        var gbls = !!this.globalHandlers, 
            hds = this.handlers;

        for(var i=0, len=adConfigList.length;i<len;i++){
            var ad = adConfigList[i];
            gbls && this.fireGlobal(ad);
            if(hds && hds[ad.flag])
                hds[ad.flag](ad, this);
        }
        this.inited = true;
    },
    
    fireGlobal : function(ad){
        var gbls = this.globalHandlers;
        if(gbls){
             for(var i=0,len=gbls.length;i<len;i++)
                gbls[i](ad, this);
        }
    },
    
    /**
     *  注册广告单元处理器。
     *  如果管理器已初始化，并且有匹配的广告单元，将立即执行处理器。
     *  如果已存在处理器，则重写。
     * @param {String} adId
     * @param {Function} handler handler(adInf, adMgr);
     */
    reg : function(adId, handler){
        // global
        if(handler === undefined){
            if(!this.globalHandlers)
                this.globalHandlers = [adId];
            else this.globalHandlers.push(adId);
        }else {
            if(!this.handlers)
                this.handlers = {};
            this.handlers[adId] = handler;
            if(this.inited)
                if(this.cfgs[adId])
                    handler(this.cfgs[adId], this);
        }
    },
    
    /**
     *  获得广告单元配置信息。
     *  如果参数为空，返回所有单元。
     *  @param {String} adId
     */
    getAd : function(adId){
        if(!adId)
            return this.cfgs;
        if(this.cfgs){
            for(var i=0;i<this.cfgs.length;i++)
                if(this.cfgs[i].flag == adId)
                    return this.cfgs[i];
        }
    }
};

})(Xwb, jQuery);

/*!
 * X weibo JavaScript Library v1.1
 * http://x.weibo.com/
 * 
 * Copyright 2010 SINA Inc.
 * Date: 2010/10/28 21:22:06
 */

 
(function(X, $){
var FALSE = false,

	TRUE = true,

    R = X.request,
    Box = X.ui.MsgBox,
	getCfg = X.getCfg,
	getWb = X.getWb;

X.use('action')
/**
 * @class Xwb.mod.GlobalActionFilter
 * 全局动作拦截器
 * @static
 */
 
/**
 * @property authFilter
 * 该拦截器检测登录用户是否具备执行当前动作的权限。<br/>
 * 目前检测的权限有：
  * <ul>
 * <li>
    登录权限
   </li>
 * </ul>
    登录权限：如果当前action.na未设置为true，则提示要求用户登录。<br/>
    登录类型由全局配置loginCfg属性指定。<br/>
    登录类型：
 * <ul>
 * <li>仅使用新浪帐号直接登录</li>
 * <li>仅使用原有站点帐号登录</li>
 * <li>使用新浪帐号与原有站点帐号并存方式登录</li>
 * </ul>

 */


// 增加全局action拦截器，
// 对于要求登录的action转至登录页面
.addFilter(function( e, act){
    // 如果e:name未注册action或者action.na未设置为true
    // 则操作前要求用户登录
	if( !act || !act.na ){
		var uid = X.getUid(),
			siteUid = X.getSiteUid(),
			loginType = getCfg('loginCfg')||1;

		if (!uid){
            var from = e.get('from');
            
			if (siteUid){
				if (e.get('e')=='lg')
					X.ui.oAuthLogin.show('bind', from);
				else 
					window.location = R.mkUrl('account', 'bind');
			} else {
				switch (parseInt(loginType,10)) {
    				//使用新浪帐号与原有站点帐号并存方式登录
    				case 3:
    					X.use('LoginBox', {siteName: getCfg('siteName')})
    					.display(TRUE);
    
    					break;
    
    				//仅使用原有站点帐号登录
    				case 2:
    					window.location = R.mkUrl('account','siteLogin');
    					break;
    
    				//仅使用新浪帐号直接登录
    				case 1:
    				default:
    					X.ui.oAuthLogin.show('', from);
				}
			}
			return FALSE;
		}	
    }
}, TRUE)

/**
 * @class Xwb.mod.PageActions
 * 公共action处理
 * @static
 */

/**
 * @event sd
 * 发布微博弹框
 * @param {String} [m] 弹出时微博框内容
 */
.reg('sd', function( e ){
    var box = X.use('postBox');
    var text = e.get('m');
    box.display(TRUE)
       .reset()
       .selectionHolder.setText(text||'');
    if(text)
        box.checkText();
})

/**
 * @event fw
 * 弹出微博转发框
 * @param {String} w 微博ID
 */
.reg('fw', function( e ){
    var wbId = e.get('w');
    // 打开转发框
    var fb = Xwb.use('forwardBox');
    fb.display(true)
      .setContent(wbId, getWb(wbId), X.getUid())
      .selectionHolder
      .focusStart();
})

/**
 * @event fl
 * 加关注
 * @param {String} u 关注用户ID
 * @param {Number} t 动作类型
 * t值可为<br/>
  * <ul>
 * <li>1:用&lt;span class=&quot;followed-btn&quot;&gt;样式显示已关注；</li>
 * <li>2:用&lt;em&gt;显示已关注</li>
 * <li>其它为刷新当前页</li>
 * </ul>
 */
.reg('fl', function( e ){
    var uid    = e.get('u');
    var jqTrig = $(e.src);
    
    // 设置action提交标记，可有效防止重复响应
    e.lock(1);
    R.follow(uid, 0, function( ed ){
        // #1020805，用户先前已关注，但由于缓存未更新引起，现作为关注成功处理
        if( ed.isOk() || ed.getCode() == '1020805'){
			var type = e.get('t');
			var $src = $(e.src);
			switch (parseInt(type)) {
    			case 1: //今日话题、他的微博
    				$src.replaceWith('<span class="followed-btn">已关注</span>');
    			break;
    
    			case 2: //挂件栏
    				$src.replaceWith('<em>已关注</em>');
    			break;
    
    			default:
    				location.reload();
			}
        }else {
            if(ed.getCode() == '1020806'){
                //如果该用户一天超过500次关注行为，弹窗提示
                Box.confirm('', '你今天已经关注了足够多的人，先去看看他们在说些什么吧？', function(btn){
                    if(btn == 'ok')
                        location.href = Req.mkUrl('ta', '', 'id='+uid);
                });
            }else Box.tipWarn(ed.getMsg());
        }
        e.lock(0);
    });
})

/**
 * @event ufl
 * 取消关注
 * @param {String} u 用户ID
 * @param {Number} [f] 动作类型
 * f值可为<br/>
  * <ul>
 * <li>1:显示“关注他”标签</li>
 * <li>其它为刷新当前页</li>
 * </ul>
 */
.reg('ufl', function(e) {
	Box.anchorConfirm(e.src,'确定要取消关注？', function(btnId){
        if(btnId == 'ok'){
            e.lock(1);
			var uid = e.get('u');
			var act = e.get('f');

			R.unfollow(uid, '', function(re) {
				if (re.isOk()){
				
					if (act == 1){
						$(e.src).replaceWith('<a rel="e:fl,t:2" href="#">关注他</a>');
					} else {
						window.location.reload();
					}
				} else {
					Box.tipWarn(re.getMsg());
				}
			    e.lock(0);
			});
		}
	});
})

/**
 * @event rs
 * 弹出举报对话框
 * @param {String} w 微博ID
 */
.reg('rs', function(e){
    var wbId = e.get('w');
    var wb = getWb(wbId);
    var box = Xwb.use('Box', {
    	cs:'win-report',
        contentHtml : 'SpanBoxContent',
        title:'举报不良信息',
        appendTo : document.body,
        closeable:true,
        mask:true,
        destroyOnClose : true,
        actionMgr:true,
        autoCenter:true,
        // html template data
        nick : wb.u.sn,
        img  : wb.u.p,
        text : wb.tx,
        onactiontrig:function(e){
            switch(e.data.e){
                case 'ok' :
                    var text = this.jq('#content').val();
                    R.reportSpam(wbId, text, function(ret){
                        if(ret.isOk()){
                            Box.success('', '您的举报已提交，我们将尽快处理，感谢您对我们工作的支持！');
                        }
                        box.close();
                    });
                break;
                
                case 'cancel':
                    this.close();
                break;
            }
        }
    });
    
    box.display(true);
    box.jq('#content')
       .focus();
})
/**
 * @event blm
 * 弹出屏蔽微博对话框
 * @param {String} w 微博ID
 */
.reg('blm', function(e){
	 Box.anchorConfirm(e.src,'确定要屏蔽该微博？', function(btnId){
        if(btnId == 'ok'){
            var wbId = e.get('w');
            e.lock(1);
            R.shieldBlog(wbId, function( r ){
                if( r.isOk() ){
                    Box.anchorTipOk(e.src, '屏蔽成功！');
                    $(e.src).replaceWith('<span>已屏蔽</span>');
                }
                e.lock(0);
            });
        }
    });
})

//刷新页面
/**
 * @event rl
 * 刷新页面
 */
.reg('rl', function(){
	location.reload();
}, {na: TRUE})

// 收藏, favourite
/**
 * @event fr
 * 弹出收藏对话框
 * @param {String} w 微博ID
 */
.reg('fr', function( e ){
    var wbId = e.get('w');
    e.lock(1);
    R.fav(wbId, function( r ){
        if( r.isOk() ){
            Box.anchorTipOk(e.src, '收藏成功！');
            $(e.src).replaceWith('<span>已收藏</span>');
        }else {
            Box.tipWarn(r.getMsg());
        }
        e.lock(0);
    });
})

/**
 * @event fr
 * 弹出取消收藏对话框
 * @param {String} w 微博ID
 * @param {Number} t 为1时当请求成功后将微博从列表移除，否则显示“收藏”按钮
 */
.reg('ufr', function(e) {
	 Box.anchorConfirm(e.src,'确定要删除该收藏？', function(btnId){
        if(btnId == 'ok'){
            e.lock(1);
			var wbId = e.get('w');
			R.delFav(wbId, function( r ){
				if( r.isOk() ){
				    // 如果指定t的值为1，将微博从列表移除
				    if(e.data.t == 1){
				        var jq = $(e.getEl('w'));
						jq.slideUp(500, function() {
							jq.remove();
							e.lock(0);
						});
					} else {
						$(e.src).replaceWith('<a rel="e:fr" href="#">收藏</a>');
						e.lock(0);
					}
				}
			});
		}
	 })
})

/**
 * @event cm
 * 评论微博
 * @param {String} w
 */
.reg('cm', function( e ){
     var wbId = e.get('w'),
         itemEl = $( e.getEl('w') ),
         cmt = itemEl.data('xwb_cmt');
     
     if( !cmt ){
	   var wb = getWb(wbId);

       cmt =  X.use('CmtArea', {
                wbId:wbId, 
                wbUid    : wb && wb.u.id,
                appendTo : itemEl.find('.feed-content'), 
                trigEl : e.src
              });
       itemEl.data('xwb_cmt', cmt);
     }
     
     if(! cmt.display() ){
        cmt.display(TRUE);
        cmt.load(function(){
            cmt.cmtBox.jqInputor.focus();
        });
     }else cmt.display(FALSE);
})

// trun left 向左转
.reg('tl', function(e) {
	var $wb = $(e.getEl('w'));
	var wbEle = $wb.data('wbEle');

	if (!wbEle) {
		var wid = e.get('w');
		wbEle = X.use('WbElement', {$wb: $wb, wbData: getWb(wid)});
		
		$wb.data('wbEle', wbEle);
	}

	wbEle.trun('left');
}, {na:TRUE})

// trun right 向右转
.reg('tr', function(e) {
	var $wb = $(e.getEl('w'));
	var wbEle = $wb.data('wbEle');

	if (!wbEle) {
		var wid = e.get('w');
		wbEle = X.use('WbElement', {$wb: $wb, wbData: getWb(wid)});
		
		$wb.data('wbEle', wbEle);
	}

	wbEle.trun('right');
}, {na:TRUE})

//还原原来的缩略图片
.reg('zo', function(e) {
	var $wb = $(e.getEl('w'));
	var wbEle = $wb.data('wbEle');

	if (!wbEle) {
		var wid = e.get('w');
		wbEle = X.use('WbElement', {$wb: $wb, wbData: getWb(wid)});
		
		$wb.data('wbEle', wbEle);
	}

	wbEle.zoomOut();
}, {na:TRUE})

// zoom in 放大图片
.reg('zi', function( e ) {
	var $wb = $(e.getEl('w'));
	var wbEle = $wb.data('wbEle');

	if (!wbEle)
	{
		var wid = e.get('w');
		wbEle = X.use('WbElement', {$wb: $wb, wbData: getWb(wid)});
		
		$wb.data('wbEle', wbEle);
	}

	wbEle.zoomIn();

}, {na:TRUE})

// play video 播放视频
.reg('pv', function(e) {
	var $wb = $(e.getEl('w'));
	var wbEle = $wb.data('wbEle');

	if (!wbEle)
	{
		var wid = e.get('w');
		wbEle = X.use('WbElement', {$wb: $wb, wbData: getWb(wid)});
		
		$wb.data('wbEle', wbEle);
	}

	wbEle.playVideo(e);

}, {na:TRUE})

//close video
.reg('cv', function(e) {
	var $wb = $(e.getEl('w'));
	var wbEle = $wb.data('wbEle');

	if (!wbEle)
	{
		var wid = e.get('w');
		wbEle = X.use('WbElement', {$wb: $wb, wbData: getWb(wid)});
		
		$wb.data('wbEle', wbEle);
	}

	wbEle.closeVideo(e);
}, {na:TRUE})

/**
 * @event dl
 * 弹出删除我发布的微博对话框
 * @param {String} w 微博ID
 */
.reg('dl', function( e ){
    var wbId = e.get('w');
    Box.anchorConfirm(e.src,'确定删除该微博吗？', function(btnId){
        if(btnId === 'ok'){
            e.lock(1);
            R.del(wbId, function(re){
                var el = $(e.getEl('w'));
                if( re.isOk() ){
    				el.slideUp('normal', function(){
                        el.remove();
                    });
                }else Box.tipWarn(re.getMsg());
                e.lock(0);
            });
        }
    });
})

/**
 * @event mop
 * TA的微博、粉丝页 “更多”按键
 */
.reg('mop', function(e) {
	var $ele = $(e.src);
	var layer = $ele.data('morelayer');

	if (!layer) {
		layer = X.use('MoreList', {
			view: $('#more_list')[0]
		});
		$ele.data('morelayer', layer);
	}

	layer.display(1);
})

/**
 * @event sdm
 * 发私信
 * @param {String} [c] 内容
 * @param {String} [n] 昵称
 */
.reg('sdm', function( e ){
    var myMsg = X.use('myMsg');
    myMsg.display(TRUE)
         .reset();
    var content = e.get('c');
    if(content)
        myMsg.selectionHolder.setText(content);
    var nick = e.get('n');
    if(nick)
         myMsg.jqSender.val(nick);
    
    if(nick)
        myMsg.jqContent.focus();
    else myMsg.jqSender.focus();
})

/**
 * @event rm
 * 回复私信
 * @param {String} [u] 用户ID
 * @param {String} [n] 昵称
 */
.reg('rm', function( e ){
    X.use('myMsg').reply(
        e.get('u'), e.get('n')
    );
})

/**
 * @event dm
 * 删除私信
 * @param {String} m 私信ID
 */
.reg('dm', function(e){
	 Box.anchorConfirm(e.src,'确定要删除该私信？', function(btnId){
        if(btnId == 'ok'){
            e.lock(1);
            var mid    = e.get('m');
            R.delMsg(mid, function(rt){
                if(rt.isOk())
                    location.reload();
                e.lock(0);
            });
        }
    });
})

/**
 * @event dbl
 * 删除黑名单
 * @param {String} u 用户ID
 */
.reg('dbl', function(e) {
	
	function removeBl() {
		e.lock(1);
		var uid = e.get('u');

		R.blacklistDel(uid, '', function(r) {
			if (r.isOk())
			{
				location.reload();
			} else {
				Box.tipWarn(r.getMsg());
			}

			e.lock(0);
		});
	}

	var m = e.data.m;

	if (m)
	{
		Box.confirm('提示', m, function(bt) {
			bt === 'ok' && removeBl();
		});
	} else {
		removeBl();
	}

})
/**
 * @event dfan
 * 移除粉丝
 * @param {String} u 用户ID
 */
.reg('dfan', function(e){
    // 有必要时可改为anchorBox提示
    Box.confirm('提示','移除之后将取消'+name+'对你的关注?', function(bid){
        if(bid=='ok'){
            var uid = e.get('u');
            var itemElem = e.getEl('u');
            e.lock(1);
            R.removeFans(uid, '', function(ret){
                if(ret.isOk()){
                    $(itemElem).slideUp(500, function() {
                        e.lock(0);
                        $(itemElem).remove();
                    });
                }else {
                    Box.tipWarn(e.getMsg());
                    e.lock(0);
                }
            });
        }
    });
});

})(Xwb, $);
(function(X, $){
/**
 * @class Xwb.mod.Validators
 */


Xwb.ax.Validator.prototype

/**
 * @event ft
 * 获得焦点时清空提示，失去焦点时出现提示效果
 * _ft|ft结合使用
 * _ft时调用jq.focusText方法创建效果
 * 当字段必须时，使用ne检测，
 * 当字段非必须时，使用ft检测
 * 用法可参见“意见反馈”对话框表单
 */
.reg('ft', function(elem, v, data, next){
    // 初始化时
    if(arguments.length == 2){
        var text = elem.value||arguments[1].w;
        $(elem).data('vrel_ft_text', text).focusText(text);
    }else {
        // 验证时
        var text = $(elem).data('vrel_ft_text');
        // args:elem, v, data, next
        // 当条件满足时，重置为空值
        if(v == text)
            this.setValue('');
            
        this.report(true, data);
        next();
    }
})

/**
 * @event ne
 * 空检测，标记作为元素必须字段。
 * <pre>
   vrel="ne=w:在这里输入名称,m:请输入昵称"
 * </pre>
 * @param {String} [m] 出错提示文字
 */
.reg('ne', function(elem, v, data, next){
    
    var em = v === '';
    var text = $(elem).data('vrel_ft_text') || data.w;
    if( !em && text ){
        em = v == text;
        // 重置为空，防停留字干扰后来的验证器
        if(em)
            this.setValue('');
    }

    if(em && !data.m)
        data.m = '该项不能为空';

    if (elem.tagName === 'INPUT' && ( elem.type === 'radio' || elem.type === 'checkbox' )) 
        em = !elem.checked;
        
    this.report(!em, data);

    next();
})

/**
 * @event f
 * 失去焦点时验证元素
 * <pre>
    // 失去焦点时验证元素是否为空
    vrel="_f|ne"
 * </pre>
 */
.reg('f', function(elem, data){
    var chain = this;
    $(elem).blur(function(){
        chain.validate();
    });
})

/**
 * @event sz
 * 检测输入字符长度
 * 属性：
    <div class="mdetail-params">
    <ul>
    <li>max=number，允许最大字节长度</li>
    <li>min=number，允许最小字节长度</li>
    <li>ww, wide code缩写，将长度按宽字符计算，一个汉字两个字节长度</li>
    <li></li>
    </ul>
    </div>
    例：
    <pre>
        sz=max:6,min:4,m:最少两个汉字，最多三个汉字,ww
    </pre>
 * @param {Number} max 最大长度
 * @param {Number} min 最小长度
 * @param {Boolean} ww 取值1或0，指明长度单位是否按宽字符长度计算，宽字符单位为2，一个字两个字母
 */
.reg('sz', function(elem, v, data, next){
    // 允许空
   if(v){
       var len = data.ww ? Xwb.util.byteLen(v) : v.length,
           err, 
           max = data.max, 
           min = data.min;
       if(max !== undefined && parseInt(max) < len)
            err = true;
       if(min !== undefined && parseInt(min)>len)
            err = true;
       this.report(!err, data);
   }else this.report(true, data);
   
   next();
})
/**
 * @event dt
 * 检查是否有效的日期格式
 * <pre><code>
 * vrel="dt"
 * </code></pre>
 */

.reg('dt', function(elem, v, data, next){
    if(v){
        if(!data.m)
            data.m = '不是有效的日期格式';
        var d = Date.parse(v);
        // 可以在这扩展max,min等
        this.report(!isNaN(d), data);
    }else this.report(true, data);
    next();
})
/**
 * @event mail
 * 验证是否为邮箱格式
 * <pre><code>
 * vrel="mail"
 * </code></pre>
 */

.reg('mail', function(elem, v, data, next){
    if(v){
    	var result = v && /\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*/.test(v);
        if(!data.m && data.m !== 0)
            data.m = '请输入正确的邮箱格式';
    	this.report(!v||result, data);
    }else this.report(true, data);
	next();
})
/**
 * @event int
 * 验证是否为数字格式
 * <pre><code>
 * vrel="int|sz=max:5,min:1"
 * </code></pre>
 */

.reg('int', function(elem, v, data, next) {
    if(v !== ''){
    	var result = v && /^\d+$/.test(v);
        if(!data.m && data.m !== 0)
            data.m = '该项为数字格式';
    	this.report(result, data);
    }else this.report(true, data);
	next();
})

/**
 * @event bt
 * 验证是值是否在某个整数范围内
 * <pre><code>
 * vrel="bt=max:1000,min:1"
 * </code></pre>
 * @param {Number} max 
 * @param {Number} min
 */

.reg('bt', function(elem, v, data, next) {
    if(v !== ''){
    	var min = parseInt(data.min),
    		max = parseInt(data.max),
    		v = parseInt(v),
    		err = 0;
    
    	if (v < min)
    		err = 1;
    
    	if (!err && (v > max))
    		err = 2
    
    	this.report(!err, data);
    }else this.report(true, data);
	next();
})
/**
 * @event sinan
 * 检查昵称是否为非法字符。非法字符指除中英文、数字、"_"或减号符号外的所有字符
 * <pre><code>
 * vrel="sinan"
 * </code></pre>
 */

.reg('sinan', function(elem, v, data, next){
    if(v){
        if(!data.m)
            data.m = '支持中英文、数字、"_"或减号';
        this.report(/^[a-zA-Z0-9\u4e00-\u9fa5_-]+$/.test(v), data);
    }else this.report(true, data);
    next();
});

})(Xwb, $);
/*!
 * 广告
 */
(function(X, $){
    
    // 通用关闭处理
    function bindCommonClsTrig(cfg){
        var adId = cfg.flag, page = cfg.page;
        $('#ad_'+adId)
          .find('#xwb_ad_cls')
          .mousedown(function(){
            $('#ad_'+adId).cssDisplay(false);
            $.cookie('ad_'+page+'_'+adId+'_hide', '1', {expires:1});
            return false;
          });
    }
    
    var winResizeBinded;
    // left , right
    function gblLeftRightHandler(cfg){
        if(!winResizeBinded){
            // 广告竖幅离container间距
            var MARGIN = 20,
                jqCt = $('#container'),
                jqBoxLeft  = $('#ad_global_left'),
                jqBoxRight = $('#ad_global_right');   
         
            function ajustAdPos(){
                var left = jqCt.offset().left;
                jqBoxLeft.length && jqBoxLeft.css('left', left - jqBoxLeft.width() - MARGIN);
                jqBoxRight.length && jqBoxRight.css('left', left + jqCt.width() + MARGIN);
            }
            
            $(window).resize(ajustAdPos);
            winResizeBinded = true;
            
            // 页面加载后调整
            setTimeout(function(){
                jqBoxLeft.css('visibility','hidden').removeClass('hidden');
                jqBoxRight.css('visibility','hidden').removeClass('hidden');
                ajustAdPos();
                jqBoxLeft.css('visibility', '');
                jqBoxRight.css('visibility','');
            }, 20);
        }
    }
    
    X.mod.AdMgm.reg(function(ad){
        bindCommonClsTrig(ad);
    });
    
    X.mod.AdMgm.handlers = 
    $.extend(X.mod.AdMgm.handlers, {
        global_left : gblLeftRightHandler,
        global_right: gblLeftRightHandler
    });
})(Xwb, $);
/*!
 * X weibo JavaScript Library v1.2
 * http://x.weibo.com/
 * 
 * Copyright 2010 SINA Inc.
 * Date: 2010/10/28 21:22:06
 */
 
/*
 * 页面初始化文件
 */

(function(X, $){
    var getCfg = X.getCfg,
        Req = X.request,
        Util = X.util,
        Box = X.ui.MsgBox,
        Pagelet = X.ax.Pagelet;
        
    /**
     * @namespace
     * 存放所有继承{@link Xwb.ax.Pagelet}类
     */
    Util.ns('Xwb.mod.pagelet', {});
    
    /**
     * @class Xwb.pagelet.WeiboList
     * 微博列表页面基类
     */
    var WBPipe = X.mod.pagelet.WeiboList = Util.create(Pagelet, {
        
        ui : {cls:X.mod.WeiboList},
        
        // 回调返回html作为页面内容
        onViewReady : function(cfg){
            
            var d = cfg.data;
            if(d){
                // 微博数据对象
                var ls = d.list;
                if(ls){
                    var gls = X.cfg.wbList;
                    if(!gls)
                        X.cfg.wbList = gls = {};
                    // 添加到全局微博数据缓存
                    for(var id in ls){
                        if(!gls[id])
                            gls[id] = ls[id];
                    }
                }
                
                // 监听全局微博计数返回事件
                X.on('api.getCounts', Util.getBind(this, 'onUpdateCounter'));
            }
        },
        
        onUpdateCounter : function(e){
            if(e.isOk()){
                var wbs = this.getUI().jq('#xwb_weibo_list_ct>li'),
                    wbsData = X.cfg.wbList,
                    cntData = e.getData();
                var jq, wid, wbd, cntd;
                var self = this;
                wbs.each(function(){
                    jq   = $(this);
                    wid  = Util.parseKnV(jq.attr('rel')).w;
                    cntd = cntData[wid];
                    // 自身微博
                    if(cntd)
                        self.renderWeiboCounter(jq, cntd);
                    
                    // 内容转发区内的微博
                    wbd  = wbsData[wid];
                    var rt = wbd.rt;
                    if(rt && (cntd = cntData[rt.id])){
                        jq = jq.find('.forward');
                        self.renderInnerWeiboCounter(jq, cntd);
                    }
                });
            }
        },
        
        // 自身微博数据更新
        renderWeiboCounter : function(jq, cntd){
            // 存在评论
            if(cntd[0])
                jq.find('#cm').text('评论(' + cntd[0] + ')');
            // 存在转发
            if(cntd[1])
                jq.find('#fw').text('转发(' + cntd[1] + ')');
        },
        
        // 内容转发区内的微博数据更新
        renderInnerWeiboCounter : function(jq, cntd){
            // 存在评论
            if(cntd[0])
                jq.find('#lk_cm').text('评论(' + cntd[0] + ')');
            // 存在转发
            if(cntd[1])
                jq.find('#lk_fw').text('转发(' + cntd[1] + ')');
        }
    });

    //
    //
    //
    X.use('pipeMgr')
        // 导航栏
        .reg('common.siteNav', {
            onViewReady : function(){
                var ui = this.getUI();
                // 缓存上一个未读数
                var preUnread = [];
                // 缓存提示结点
                var jqNodes;
                
                // 监听未读数
                X.on('api.unread', function(e){
                    if(e.isOk()){
                        if(!ui.jqNewWb){
                            ui.jqExtra('newWb', 'referMe', 'myCmt');
                            jqNodes = {0:ui.jqNewWb, 1:ui.jqReferMe, 2: ui.jqMyCmt};
                        }
                        var unread = e.getData().unread;
                        // 只更新需要更新的结点
                        for(var i=0;i<unread.length;i++){
                            if(preUnread[i] !== unread[i]){
                                var nd = jqNodes[i];
                                if(nd){
                                    nd.cssDisplay(unread[i]);
                                    if(unread[i])
                                        nd.find('#t').text(unread[i]);
                                }
                            }
                        }
                        preUnread = unread;
                    }
                });
            }
        })
        // 用户介绍区
        .reg('common.userPreview',{
            onViewReady : function(){
                var self = this;
                // 微博更新时，监听计数变化
                X.on('api.update', function(){
                    var countMarker = self.getUI().jq('#xwb_user_total_wb');
                    countMarker.text(parseInt(countMarker.text())+1);
                 })
                 .on('api.destroy', function(){
                    var countMarker = self.getUI().jq('#xwb_user_total_wb');
                    countMarker.text(parseInt(countMarker.text())-1);                    
                 })
                 .on('api.createFriendship', function(){
                    // 可能批量关注
                    var countMarker = self.getUI().jq('#xwb_user_total_fans');
                    countMarker.text(parseInt(countMarker.text())+1);                     
                 })
                 .on('api.deleteFriendship', function(){
                    // TODO:区别取消关注与移除粉丝
                    var countMarker = self.getUI().jq('#xwb_user_total_fans');
                    countMarker.text(parseInt(countMarker.text())-1);                     
                 });
            }
        })
        // 微博框发布
        .reg('input', {
            ui : X.mod.PostBase,
            onViewReady : function(){
                // 调用PostBase.initEx作额外初始化
                this.getUI().initEx();
            }
        })
        
        // 通用微博列表模块
        .reg('wblist', WBPipe)
        
        // 个人微博列表
        .reg('weibo.weiboList', function(){
            return new WBPipe({
                // 指定该pagelet的ui类配置
                ui : {cls:X.mod.WeiboList, syncList:true}
            });
        })
        // 我|TA的微博列表
        .reg('weibo.userTimelineList', function(){
            // 如果是“我的微博，实时同步微博列表”
            var syncList = getCfg('page')=='index.profile';
            return new WBPipe({
                // 指定该pagelet的ui类配置
                ui : {cls:X.mod.WeiboList, syncList:syncList}
            });
        })
        // 用户搜索模块
        .reg('common.searchMod', function(){
            return new Pagelet({
                onViewReady : function(){
                    // 光标聚焦
                    var iptEl = document.getElementById('k');
                    if(iptEl)
                        Util.focusEnd(iptEl);
    			    
    			    // 绑定提交事件
                    $('#searchForm').bind('submit', function(){
                        var k = $.trim($('#k').val());
                        if(!k){
                            $('#searchTip').cssDisplay(true);
                            $('#k').focus();
                            return false;
                        }
                    });
                    
        			$('#searchBtn').click(function(){
        			    // 不多于15汉字长度
                        var k = X.util.byteCut($.trim($('#k').val()), 30);
                        if(k){
                            $('#searchForm').submit();
                        }else {
                            $('#searchTip').cssDisplay(true);
                            $('#k').focus();
                        }
                        return false;
                    });
                }
            });
        })
        
        // 搜索综合列表
        .reg('user.fameList', function(){
            return new Pagelet({
                onViewReady : function(){
                    this.getUI().jq().highlight($('#k').val());
                }
            });
        })
        // 搜索用户列表
        .reg('user.userSearchList',function(){
            return new Pagelet({
                 onViewReady : function(){
                    this.getUI().jq().highlight($('#k').val());
                 }
            });
        })
        // 搜索微博列表
        .reg('weibo.weiboOnly', function(){
            return new WBPipe({
                onViewReady : function(){
                    WBPipe.prototype.onViewReady.apply(this, arguments);
                    this.getUI()
                        .jq('#xwb_weibo_list_ct')
                        .highlight($('#k').val());
                }
            });
        })
        // 我的关注
        .reg('user.followersList', function(){
             return  new Pagelet({
                   ui : {
                       cls:X.mod.HoverList,
                       itemSelector:'ul li',
        			   onMouseOver: function() {
        			        $(this).find('#removeFans,#sendMsg').removeClass('hidden');
        			   },
        			   onMouseOut: function() {
        			    	$(this).find('#removeFans,#sendMsg').addClass('hidden');
        			   },
                       actionMgr:true,
                       onactiontrig : function(e){
                           switch(e.data.e){
                               case 'ufl' :
                                   var uid = e.get('u'), name = e.get('n');
                                   Box.confirm('提示', '确定要取消关注' + name + '?', function (btnId) {
                                       if (btnId === 'ok') {
                                           e.lock(1);
                                           X.request.unfollow(uid, '', function (ret) {
                                               if (ret.isOk()) {
                                                   // e.jq()用法参见文档
                                                   var jqEl = e.jq('u');
                                                   jqEl.slideUp(500, function () {
                                                       e.lock(0);
                                                       jqEl.remove();
                                                   });
                                               } else {
                                                    e.lock(0);
                                                    Box.tipWarn(ret.getMsg());
                                               }
                                           });
                                       }
                                   });
                               break;
                               default :
                               e.stopPropagation(false);
                           }
                       }
                   }
             });
        })
        // 具体微博页面
        .reg('weibo.detail', function(){
            return new WBPipe({
                onViewReady : function(v){
                    WBPipe.prototype.onViewReady.apply(this, arguments);
                    var jq = this.getUI().jq('#xwb_cmt_list');
                    var wbId = jq.attr('wbid');
                    var wbUid = X.cfg.wbList[wbId].u.id;
                    var area = this.getUI().jq('#topCmtBox');
                    var cmtArea = X.use('MBlogCmtArea', {
                        view : jq[0],
                        wbId : wbId,
                        wbUid : wbUid,
                        topCmtBox : area[0],
        				faceSize: 50
                    });
                    cmtArea.display(true).load();
                }
            });
        })
        // 我的私信
        .reg('common.message', function(){
            return new Pagelet({
                onViewReady : function(v){
                    // mouseover 显示 删除
                    this.getUI().jq('#messageList li').hover(function(e){
                        $(this).find('#del').cssDisplay(true);
                    }, function(e){
                        $(this).find('#del').cssDisplay(false);
                    });
                    
                    // 发送私信后刷新页面
                    X.on('api.sendDirectMessage', function(e){
                        if(e.isOk())
                            location.reload();
                    });
                }
            });
        })
        
        // 我的评论页，MyCmt类在mycomments.js中
        // 此时X.mod.MyCmt还未加载，所以放到一个函数中返回，
        // 当调用的时候就加载好了
        .reg('weibo.comments', function(){
            return new Pagelet( { ui:{ cls:X.mod.MyCmt } } );
        })
        
        // 我的粉丝列表
        .reg('user.fansList', function(){
            return new Pagelet({
                ui:{ 
                    cls:X.mod.HoverList,
                    itemSelector:'ul li',
    				onMouseOver: function() {
    					$(this).find('#removeFans,#sendMsg').removeClass('hidden');
    				},
    				onMouseOut: function() {
    					$(this).find('#removeFans,#sendMsg').addClass('hidden');
    				}
    			}
            });
        })
        // 名人堂批量关注
        .reg('user.outputCelebUserBlock', function(){
            return new Pagelet({
                ui : {
                    selectedCS:'current',
                    actionMgr : true,
                    onactiontrig : function(e){
                        switch(e.data.e){
                            // 选择关注
                            case 'ck' :
                                var jqIcon = e.jq('u').find('#pic');
                                if(jqIcon.hasClass(this.selectedCS))
                                    jqIcon.removeClass(this.selectedCS);
                                else jqIcon.addClass(this.selectedCS);
                            break;
                            // 全选
                            case 'sa':
                                var checked = e.src.checked;
                                var cs = this.selectedCS;
                                this.jq('#pic').each(function(){
                                    $(this).checkClass(cs, checked);
                                });
                                // 让checkbox可选
                                e.preventDefault(false);
                            break;
                            // 关注已选
                            case 'submit' : 
                                var ids = [];
                                var cs = this.selectedCS;
                                var rel;
                                var action = X.use('action');
                                this.jq('#pic').each(function(){
                                    if($(this).hasClass(cs)){
                                        rel = X.ax.ActionMgr.wrapRel(this);
                                        ids.push(rel.get('u'));
                                    }
                                });
                                if(!ids.length){
                                    Box.tipWarn('请选择您要关注的人。');
                                }else {
                                    Req.follow(ids.join(','), 0, function(r){
                                        if (r.isOk()) {
                                            $(e.src).replaceWith('<span class="followed-btn">已关注</span>');
                                        } else {
                                            Box.tipWarn(r.getMsg());
                                        }
                                        e.lock(0);
                                    });
                                }                       
                            break;
                        }
                    }
                }
            });
        })
        
        .reg('common.userSkin', function(){
            return new Pagelet({
                ui : {
                    cls:X.mod.Skin,
                    tab:{ 
                        selectedCS:'current', 
                        items: $('#tabItems>span'), 
                        contents:$('#tabPanels>div')
                    }
                }
            });
        })
        
        // 热门评论与转发切换页
        .reg('component/component_1.run', function(){
            return new Pagelet({
                onViewReady : function(){
                    var ui = this.getUI();
            		X.on('pipe.end', function(){
                        X.use('Switcher', {
                			items : ui.jq('div.tab-s2>span'),
                			contents : ui.jq('div.hot-mblog-body'),
                			selectedCS: 'current'
                		});
            		});
                }
            });
        })
        
        // 热门评论
        .reg('component/component_common.hotWB_getComment', function(){
            return new WBPipe({
                // 重写该方法，更新其它计数区域
                renderWeiboCounter : function(jq, cntd){
                    WBPipe.prototype.renderWeiboCounter.apply(this, arguments);
                    if(cntd[0])
                        jq.find('#hotNum').text(cntd[0]);
                }
            });        
        })
        
        // 热门转发
        .reg('component/component_common.hotWB_getRepost', function(){
            return new WBPipe({
                // 重写该方法，更新其它计数区域
                renderWeiboCounter : function(jq, cntd){
                    WBPipe.prototype.renderWeiboCounter.apply(this, arguments);
                    if(cntd[1])
                        jq.find('#hotNum').text(cntd[1]);
                }
            });        
        })
        // 同城微博
        .reg('component/component_8.run', function(){
			return new WBPipe({
			    onViewReady : function(){
			        WBPipe.prototype.onViewReady.apply(this, arguments);
			        // 选择城市浮层
			        var layer = X.use('Layer', {
        					closeable: true,
        					contextable: true,
        					view: this.jq('#win_city')[0],
        					onViewReady: function() {
        						Req.getProvinces(Util.bind(this.onDataLoaded, this));
        						var self = this;
        						// 选择城市后关闭
        						this.jq('#citys').click(function(e){
        						    if(e.target.tagName == 'A')
        						        self.close();
        						});
        					},
        
        					//省份加载完成后
        					onDataLoaded: function(e) {
        						if (e.isOk()){
        							this.provinces = e.getData().provinces;
        							var self = this;
        							this.jq('#sel-area').change(function() {
        								self.changeProvince(this.value);
        							});
        						}
        					},
        
        					changeProvince: function(id) {
        						if (this.provinces){
        							var self = this;
        							$.each(this.provinces, function(i, row) {
        								if (row.id == id){
        									var htmls = [];
        									$.each(row.citys, function(k, ct) {
        										var ctKey,ctName;
        										for (var k in ct ){
        											ctKey = k;
        											ctName = ct[k];
        										}
        										var url = Req.mkUrl('pub', '', Util.queryString({province:id, city: ctKey + '#city'}));
        										htmls.push('<a href="' + url + '">' + ctName + '</a>');
        									});
        									self.jq('#citys').html(htmls.join(''));
        									return false;
        								}
        							});
        						}
        					}
        		    });
        		    this.jq('#cityBtn').click(function() {
        		        layer.display(true);
        				return false;
        		    });
			    }
			});
        });
})(Xwb, $);
/*!
 * X weibo JavaScript Library v1.2
 * http://x.weibo.com/
 * 
 * Copyright 2010 SINA Inc.
 * Date: 2010/10/28 21:22:06
 */
 
/*
 * 页面初始化文件
 */

(function(X, $){
    var getCfg = X.getCfg,
        Req = X.request,
        Util = X.util,
        Box = X.ui.MsgBox,
        Pagelet = X.ax.Pagelet;

    // 监听pipe开始事件
    X.on('pipe.start', function(cfg){
        
        if(!cfg)
            cfg = {};

        // 绑定到空间
    	X.cfg = cfg;

        // 绑定全局页面action
        X.use('action').bind(document.body);
        
    	//初始化请求路径
    	cfg.basePath && Req.init(cfg.basePath);
    	
        if(X.getUid()){
            // 消息提醒面板
            var rt = cfg.remind;
            var bd = rt ? document.body : $('#xwbInnerNav')[0];
            if(bd){
                X.use('notice', {
                    appendTo : bd,
                    remindType : rt
                });                
            }
        }
    })
    
    .on('pipe.end', function(){
    	//查询页面中微博列表评论和转发数
    	if(X.cfg.wbList){
    	    var list = X.cfg.wbList, ids = [], wb;
    	    for(var id in list){
    	        ids.push(id);
    	        // 内容内转发的微博id
    	        var wb = list[id];
    	        wb.rt && ids.push(wb.rt.id);
    	    }
    	    Req.counts(ids.join(','), $.noop);
    	    ids = null;
    	}
    	
        // 搜索框
        $('#xwb_search_form').each(function(){
            X.use('SearchEntry', {view:this}).display(true);
        });
        
    	//上报数据
        X.report.start();
        var unload = function () {
            X.report.report();
        };
        // 不能用JQ来绑定unload事件
        if (window.addEventListener)
            window.addEventListener("unload", unload, false);
        else if (window.attachEvent)
            window.attachEvent('onunload', unload);
    	
    	// 广告初始化
    	if(getCfg('ads'))
    	    X.mod.AdMgm.init(getCfg('ads'));
    	    
    	// 页面内的新微博横条提示
    	var jqWbTip = $('#new_wb_tips');
    	if(jqWbTip.length){
    	    X.on('api.unread', function(e){
    	        if(e.isOk()){
    	            var unread = e.getData().unread[0];
    	            jqWbTip.cssDisplay(!!unread);
    	        }
    	    });
    	}
    	
    	// 发起轮询未读数
    	var checking = false;
    	// 半分钟查一次
    	var interval = 30000;
    	var latestWid = getCfg('maxid');
    	
    	function onUnreadLoad(){
    	    checking = false;
    	    setTimeout(doCheck, interval);
    	}
    	
    	function doCheck(){
    	    if(!checking){
    	        checking = true;
    	        Req.unread(latestWid, onUnreadLoad);
    	    }
    	}
    	
    	doCheck();
    });
    
    // DOM Ready
    $(function(){
    	if ($('#logo').length){
    		$('#logo').fixPng();
    	}
    	// TODO:变为Pagelet输出
    	$('#focus_index').each(function(){
    	    //我的首页，聚焦位推广
            var idx = X.use('base', {
            	actionMgr: true,
            	view:this,
            	onactiontrig: function(e) {
            		var data = e.data;
            		switch (data.e){
                		case 'cls': //关闭
                			$.cookie(e.get('cn'), 1);
                			this.display(0);
                		break;
                
                		case 'do': //按键被点击
                			var op = data.op;
                			//发主题微博
                			if (op == 1) {
                				var postArea = X.use('postArea');
                				if(postArea)
                				    postArea.selectionHolder.insertText('#' + data.tp + '# ');
                			} else if (op == 2){
                				data.ln && window.open(decodeURIComponent(data.ln.replace(/\+/g, '%20')));
                			}
                		break;
            		}
            	}
            });
            idx.display(true);
    	});
    	
    	// slide menu
    	$('.main-menu>li').slideMenu('>ul');
    });
    
window.xwbPipe = X.ax.PipeMgr;

})(Xwb, $);


$(function(){

(function(X, $){

	var xui = X.ui,
		
		CFG = X.cfg,
		
		Req = X.request,

		getCfg = X.getCfg,

		BasePath = getCfg('basePath');
	//
	xui.linkRender();

	$('#xwb_today_topic').each(function() {
		$(this).find('p.feedback').substrText(80, 1);
		$(this).find('div.column-item:first').removeClass('next');

		X.use('FadeBox', {view: this}).display(1);
	});
	
})(Xwb, $)

});
</pre>    
</body>
</html>
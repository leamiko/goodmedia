(function(W,G){var map=function(cg){if(!cg){return}var _cg={q:"",markerhtml:"",name:"",target:"",width:210,height:270,drag:false,bar:true,revise:false,center:null,siteNo:null,type:null};$.extend(_cg,cg);for(var i in _cg){this[i]=_cg[i]}};map.prototype={_loadcss:function(){var host=GM.widget.host,place="-min";if(GM.debug){place=""}$.loadcss(host+"map/map"+place+".css")},drawmap:function(target,center,name,siteNo){if(google){var that=this,T,Circle,errortime=0,markersArray=[],Gmap=google.maps,Gevent=Gmap.event,infowindow=new Gmap.InfoWindow(),latlng=new Gmap.LatLng(center[1],center[0]),myOptions={zoom:15,center:latlng,mapTypeId:Gmap.MapTypeId.ROADMAP},map=new Gmap.Map(target,myOptions),marker=new Gmap.Marker({title:name,position:latlng,map:map,draggable:function(){if(that.drag||that.type=="search"){return true}return false}()}),_fn={setlatlng:function(m,c){var center=m.getPosition();$("#J_Coord").html('lat:<span id="J_Pa">'+c.Pa+'</span><br/>lng:<span id="J_Oa">'+c.Oa+"</span>")},getPosition:function(m){var center=m.getPosition();return{lat:center.Oa,lng:center.Pa}},deleteMarkers:function(ary,cle){if(ary){for(i in ary){ary[i].setMap(null)}ary.length=0}if(cle){cle.setMap(null)}},clearRightBar:function(){},infoshow:function(info,msg,position){clearTimeout(T);info.setContent(msg);if(position){info.setPosition(position)}info.open(map);T=setTimeout(function(){info.close()},5000)},infowindowShow:function(info,l){_fn.infoshow(info,"在此3公里范围找到了"+l+"家健身会馆,拖动此标志可继续查找",marker.getPosition())},addrimmarkers:function(ary,map,info,markAry){for(var i=0;i<ary.length;i++){(function(i){var result=ary[i],resultlat=result.lat,resultlng=result.lng,resultname=result.name,newlatlng=new Gmap.LatLng(resultlat,resultlng),marker=new Gmap.Marker({title:resultname,position:newlatlng,map:map,icon:"http://s1.ifiter.com/static/images/map/124.png"});markAry.push(marker);Gevent.addListener(marker,"click",function(){_fn.infoshow(info,resultname,newlatlng)})})(i)}},clickseach:function(e){var lat=e.latLng["Oa"],lng=e.latLng["Pa"],darwin=new Gmap.LatLng(lat,lng);marker.setPosition(darwin);_fn.postPostion(marker)},postPostionSuccess:function(data,lat,lng){var darwin=new Gmap.LatLng(lat,lng);map.setCenter(darwin);map.setZoom(13);try{eval("var data="+$.trim(data))}catch(e){console.log(e)}var dataAry=data.s["result"];_fn.infowindowShow(infowindow,dataAry.length);if(data.r!=0){return}if(dataAry.length==0){}_fn.clearRightBar();_fn.deleteMarkers(markersArray,Circle);_fn.addrimmarkers(dataAry,map,infowindow,markersArray);Circle=new Gmap.Circle({strokeColor:"#FF0000",fillOpacity:0,map:map,strokeWeight:1,radius:3500,center:marker.getPosition()});Gevent.addListener(marker,"click",function(){_fn.infowindowShow(infowindow,dataAry.length)});Gevent.addListener(Circle,"click",_fn.clickseach)},postPostionError:function(){errortime++;if(errortime==10){alert("连续请求失败,建议重新刷新页面");return}setTimeout(function(){_fn.postPostion(marker)},200)},postPostion:function(m){var coord=_fn.getPosition(m),lat=coord.lat,lng=coord.lng,action="/api/mi.jsp?v=geo/"+lng+"/"+lat;$.ajax({url:action,type:"GET",success:function(data){_fn.postPostionSuccess(data,lat,lng)},error:_fn.postPostionError})}};if(that.markerhtml!=""){infowindow.setContent(markerhtml);infowindow.open(map,marker);Gevent.addListener(marker,"click",function(){infowindow.open(map,marker)})}if(that.drag){_fn.setlatlng(marker,center);Gevent.addListener(marker,"dragend",function(){_fn.setlatlng(marker,center)})}if(that.type=="search"){_fn.postPostion(marker);Gevent.addListener(marker,"dragend",function(){_fn.postPostion(marker)});Gevent.addListener(marker,"drag",function(){infowindow.close();clearTimeout(T)});Gevent.addListener(map,"click",_fn.clickseach)}if(that.bar){that._bulidbar(that.target)}}},_bulidbar:function(target){var revise="",that=this,bar;if(that.revise){revise='<li><a href="javascript:void(0);" class="J_EditMap">修订坐标</a></li>'}bar='<ul class="map_bar"><li><a href="javascript:void(0);" class="J_LookBigMap">查看全图</a></li><li><a href="javascript:void(0);" class="J_LookWay">公交/驾车</a></li>'+revise+"</ul>";$("#"+target).after(bar)},_errorClick:function(){var BigMap='<div class="emersion error"><div class="msg">对不起,没有可以查看的地图信息</div><a href="javascript:void(0);" class="J_OverlayClose mapclose">&times</a></div>';G.tools.overlay.fire(BigMap)},_setwrap:function(target){var that=this;target.style.cssText+="width:"+that.width+"px;height:"+that.height+"px;border:1px solid #CCC;"},_Initerror:function(target){target.parentNode.removeChild(target)},init:function(){var that=this,target=document.getElementById(that.target);that._loadcss();if(!that.center){if(google){var Gmap=google.maps,geocoder=new Gmap.Geocoder();geocoder.geocode({address:that.q},function(results,status){if(status==Gmap.GeocoderStatus.OK){var location=results[0].geometry.location;that.center=[location.Pa,location.Oa];that.drawmap(target,that.center,that.name,that.siteNo)}else{that._Initerror(target)}})}}else{if(that.center){that.drawmap(target,that.center,that.name,that.siteNo)}}that._setwrap(target);$.overlay();var events=[".J_LookBigMap",".J_LookWay",".J_OverlayClose",".J_EditMap","#J_SqSub","#J_Esub"];$.each(events,function(key,val){$(val).die()});$(".J_LookBigMap").live("click",function(){if(that.coord||that.center){that._BigMapaction()}else{that._errorClick()}});$(".J_LookWay").live("click",function(){if(that.coord||that.center){that._lookway()}else{that._errorClick()}});$(".J_OverlayClose").live("click",function(){G.tools.overlay.close()});$("#J_SqSub").live("click",function(){var diget=$(this).attr("data-diget"),map=new G.widget.map({q:$("#J_Sq").val(),markerhtml:"拽我，拽我，确定准确的位置~",target:"J_Map_"+diget,width:600,height:500,bar:false,drag:true,name:that.name,siteNo:that.siteNo}).init()});$(".J_EditMap").live("click",function(){if(that.coord||that.center){that._editaction()}else{that._errorClick()}});$("#J_Esub").live("click",function(){that._revise()})},_BigMapaction:function(){var diget=new Date().valueOf(),that=this,BigMap='<div class="emersion bigmap"><div id="J_Map_'+diget+'" style="height:500px;"></div><a href="javascript:void(0);" class="J_OverlayClose mapclose">&times</a></div>';G.tools.overlay.opacity(0.5);G.tools.overlay.fire(BigMap);var map=new G.widget.map({q:that.q,markerhtml:that.markerhtml,target:"J_Map_"+diget,width:500,height:500,bar:false,name:that.name,center:that.center,siteNo:that.siteNo}).init()},_lookway:function(){var that=this;var Way='<div class="emersion lookway"><form action="http://ditu.google.cn/maps" method="get" target="_blank"><div class="lookway_title">请输入出发所在地</div><div class="lookway_content"><span>出发地</span><input type="text" name="saddr" class="profile_box1"></div><div><input type="submit" value="确认" class="space_button"></div><input value="'+that.q+","+that.name+'" type="hidden" name="daddr"/></form><a href="javascript:void(0);" class="J_OverlayClose mapclose">&times</a></div>';G.tools.overlay.opacity(0.5);G.tools.overlay.fire(Way)},_editaction:function(){var diget=new Date().valueOf(),that=this,BigMap='<div class="emersion edit"><div id="J_Map_'+diget+'" style="height:500px;""></div><a href="javascript:void(0);" class="J_OverlayClose mapclose">&times</a><div class="editbox">搜索:<br><input type="text" id="J_Sq"/><br/>操作:<br><input type="button" data-diget="'+diget+'" id="J_SqSub" value="搜索"/> <input type="button" id="J_Esub" value="保存坐标"/><br/>坐标:<br><span id="J_Coord"></span></div></div>';G.tools.overlay.opacity(0);G.tools.overlay.fire(BigMap);var map=new G.widget.map({q:that.q,markerhtml:"拽我，拽我，确定准确的位置~",target:"J_Map_"+diget,width:600,height:500,bar:false,drag:true,name:that.name,center:that.center,siteNo:that.siteNo}).init()},_revise:function(){var that=this;if(confirm("确定保存当前标记位置为新场馆位置么？")){$.ajax({url:"/gestion/map.jsp",data:{siteno:that.siteNo,latitude:$("#J_Pa").text(),longitude:$("#J_Oa").text(),act:"update"},success:function(str){var result=$.trim(str);if(result==1){alert("保存成功");window.location.href="/gestion/map.jsp?siteno="+that.siteNo}else{alert("操作失败")}},error:function(){alert("相应超时，重新保存")}})}}};if(G&&G.widget){G.widget.map=map}})(window,GM);